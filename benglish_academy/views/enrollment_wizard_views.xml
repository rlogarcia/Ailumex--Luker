<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- VISTA DE FORMULARIO DEL WIZARD  -->
    <record id="view_enrollment_wizard_form" model="ir.ui.view">
        <field name="name">benglish.enrollment.wizard.form</field>
        <field name="model">benglish.enrollment.wizard</field>
        <field name="arch" type="xml">
            <form string="Asistente de Matr√≠cula">
                <sheet>
                    <div class="oe_title">
                        <label for="student_id" string="Matricular Estudiante" />
                        <h1>
                            <field name="student_id"
                                placeholder="Seleccione un estudiante..."
                                required="1"
                                options="{'no_create': True}" />
                        </h1>
                    </div>

                    <!-- Alertas de validaci√≥n -->
                    <div class="alert alert-danger" role="alert"
                        invisible="not has_prerequisite_warning">
                        <h5>
                            <strong>‚ö†Ô∏è Advertencia de Prerrequisitos</strong>
                        </h5>
                        <field name="prerequisite_warning_message" readonly="1" nolabel="1" />

                        <div invisible="not can_override_prerequisites" class="mt-3">
                            <hr />
                            <p>
                                <strong>üõ°Ô∏è Autorizaci√≥n de Excepci√≥n (Solo Coordinadores)</strong>
                            </p>
                            <field name="prerequisite_override" widget="boolean_toggle" nolabel="1" />
                            <label for="prerequisite_override"
                                string="Autorizar excepci√≥n de prerrequisitos" />
                            <field name="override_reason"
                                placeholder="Escriba la justificaci√≥n para esta excepci√≥n..."
                                invisible="not prerequisite_override"
                                required="prerequisite_override"
                                class="mt-2" />
                        </div>
                    </div>

                    <div class="alert alert-success" role="alert"
                        invisible="has_prerequisite_warning">
                        <strong>‚úÖ Validaciones Correctas</strong>
                        <p>El estudiante cumple con los requisitos para matricularse.</p>
                    </div>

                    <notebook>
                        <!-- PASO 1: INFORMACI√ìN DEL ESTUDIANTE -->
                        <page string="üìã Paso 1: Estudiante" name="student_info">
                            <group>
                                <group string="Datos del Estudiante">
                                    <field name="student_code" readonly="1" />
                                    <field name="student_email" widget="email" readonly="1" />
                                    <field name="student_program_id" readonly="1" />
                                    <field name="student_commercial_plan_id" readonly="1" />
                                </group>
                                <group string="Informaci√≥n de Matr√≠cula">
                                    <field name="enrollment_date" />
                                </group>
                            </group>
                            <group>
                                <field name="notes"
                                    placeholder="Observaciones adicionales sobre esta matr√≠cula..." />
                            </group>
                        </page>

                        <!-- PASO 2: ESTRUCTURA ACAD√âMICA -->
                        <page string="üìö Paso 2: Plan Comercial" name="academic_structure">
                            <div class="alert alert-info mb-3" role="alert">
                                <strong>‚ÑπÔ∏è Plan Comercial</strong>
                                <p class="mb-0">El Plan Comercial define cu√°ntas asignaturas de cada
                                    tipo debe cursar el estudiante (selecci√≥n, electivas, oral
                                    tests).</p>
                            </div>
                            <group>
                                <group string="Programa y Plan Comercial">
                                    <field name="program_id"
                                        required="1"
                                        options="{'no_create': True}"
                                        placeholder="Seleccione el programa" />
                                    <field name="commercial_plan_id"
                                        required="1"
                                        domain="[('program_id', '=', program_id), ('state', '=', 'active')]"
                                        options="{'no_create': True}"
                                        placeholder="Seleccione el plan comercial" />
                                    <field name="phase_id" readonly="1" />
                                    <field name="level_id" readonly="1" />
                                </group>
                                <group string="Asignatura Inicial (Opcional)">
                                    <field name="subject_id"
                                        required="0"
                                        readonly="0"
                                        domain="[('program_id', '=', program_id)]"
                                        options="{'no_create': True}"
                                        placeholder="Primera asignatura (opcional)" />
                                </group>
                            </group>
                            <div class="alert alert-warning" role="alert">
                                <p class="mb-0"> üìå <strong>IMPORTANTE:</strong> El Plan Comercial
                                    es obligatorio. Define las cantidades que el estudiante debe
                                    cursar: <br />‚Ä¢ Plan Plus: 78 asignaturas (24 niveles) <br />‚Ä¢
                                    Plan Gold: 126 asignaturas (24 niveles) <br />‚Ä¢ M√≥dulo: 42
                                    asignaturas (6 niveles) </p>
                            </div>

                            <!-- Prerrequisitos -->
                            <group string="üìã Prerrequisitos de la Asignatura"
                                invisible="not prerequisite_ids">
                                <field name="can_override_prerequisites" invisible="1" />
                                <field name="prerequisites_met" widget="boolean_toggle" readonly="1" />
                                <field name="missing_prerequisites" readonly="1"
                                    invisible="prerequisites_met" />
                                <field name="prerequisite_ids" nolabel="1" readonly="1">
                                    <list>
                                        <field name="code" />
                                        <field name="name" />
                                        <field name="level_id" />
                                        <field name="phase_id" />
                                    </list>
                                </field>
                            </group>
                        </page>

                        <!-- PASO 3: MODALIDAD DE ASISTENCIA -->
                        <page string="üåê Paso 3: Modalidad" name="delivery_mode">
                            <group>
                                <group string="Modalidad de Asistencia">
                                    <field name="delivery_mode"
                                        widget="radio"
                                        required="1" />

                                    <field name="attendance_type"
                                        widget="radio"
                                        required="delivery_mode == 'hybrid'"
                                        invisible="delivery_mode != 'hybrid'" />
                                </group>
                            </group>

                            <div class="alert alert-info" role="alert"
                                invisible="delivery_mode != 'hybrid'">
                                <h5>
                                    <strong>‚ÑπÔ∏è Modalidad H√≠brida</strong>
                                </h5>
                                <p> Este grupo tiene modalidad <strong>h√≠brida</strong>, lo que
                                    significa que puede asistir de forma presencial o conectarse
                                    remotamente. </p>
                                <ul>
                                    <li><strong>Presencial:</strong> Asiste f√≠sicamente al aula en
                                        la sede.</li>
                                    <li><strong>Virtual (Remoto):</strong> Se conecta por
                                        videoconferencia desde cualquier lugar.</li>
                                </ul>
                                <p class="mb-0">
                                    <strong>Importante:</strong> Esta elecci√≥n afecta los cupos
                                    disponibles. Una vez matriculado, puede solicitar cambio al
                                    coordinador si hay cupos disponibles. </p>
                            </div>
                        </page>

                        <!-- PASO 4: CONFIRMACI√ìN -->
                        <page string="‚úÖ Paso 4: Confirmaci√≥n" name="confirmation">
                            <div class="alert alert-info" role="alert">
                                <h4>
                                    <strong>üìã Resumen de la Matr√≠cula</strong>
                                </h4>
                                <hr />
                                <table class="table table-sm">
                                    <tr>
                                        <th>Estudiante:</th>
                                        <td>
                                            <field name="student_id" readonly="1" nolabel="1" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Programa:</th>
                                        <td>
                                            <field name="program_id" readonly="1" nolabel="1" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Plan:</th>
                                        <td>
                                            <field name="plan_id" readonly="1" nolabel="1" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Asignatura:</th>
                                        <td>
                                            <field name="subject_id" readonly="1" nolabel="1" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Modalidad:</th>
                                        <td>
                                            <field name="delivery_mode" readonly="1" nolabel="1"
                                                widget="badge" />
                                            <field name="attendance_type" readonly="1" nolabel="1"
                                                invisible="delivery_mode != 'hybrid'" widget="badge" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Fecha de Matr√≠cula:</th>
                                        <td>
                                            <field name="enrollment_date" readonly="1" nolabel="1" />
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <div class="alert alert-success" role="alert"
                                invisible="has_prerequisite_warning">
                                <h5>
                                    <strong>‚úÖ Listo para Matricular</strong>
                                </h5>
                                <p class="mb-0"> Todos los datos est√°n completos y las validaciones
                                    son correctas. Presione el bot√≥n <strong>"Crear Matr√≠cula"</strong>
                                    para finalizar. </p>
                            </div>

                            <div class="alert alert-warning" role="alert"
                                invisible="not has_prerequisite_warning">
                                <h5>
                                    <strong>‚ö†Ô∏è Atenci√≥n</strong>
                                </h5>
                                <p class="mb-0">
                                    Hay advertencias que debe revisar antes de continuar.
                                    Verifique las pesta√±as anteriores para m√°s detalles.
                                </p>
                            </div>
                        </page>
                    </notebook>
                </sheet>

                <footer>
                    <button name="action_create_enrollment"
                        string="Crear Matr√≠cula"
                        type="object"
                        class="btn-primary" />
                    <button name="action_cancel"
                        string="Cancelar"
                        type="object"
                        class="btn-secondary" />
                </footer>
            </form>
        </field>
    </record>

    <!-- ACCI√ìN PARA ABRIR EL WIZARD -->
    <record id="action_enrollment_wizard" model="ir.actions.act_window">
        <field name="name">Asistente de Matr√≠cula</field>
        <field name="res_model">benglish.enrollment.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Matricular un estudiante paso a paso
            </p>
            <p> Este asistente le guiar√° a trav√©s del proceso de matr√≠cula: <ol>
                    <li>Selecci√≥n del estudiante</li>
                    <li>Confirmaci√≥n de programa/plan (asignatura autom√°tica)</li>
                    <li>Configuraci√≥n de modalidad de asistencia</li>
                    <li>Confirmaci√≥n y creaci√≥n</li>
                </ol>
            </p>
        </field>
    </record>

    <!-- ==================== ACCI√ìN DESDE ESTUDIANTE ==================== -->
    <record id="action_enrollment_wizard_from_student" model="ir.actions.act_window">
        <field name="name">Matricular Estudiante</field>
        <field name="res_model">benglish.enrollment.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{
            'default_student_id': active_id,
            }</field>
    </record>

</odoo>