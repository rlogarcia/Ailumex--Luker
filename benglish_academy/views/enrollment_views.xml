<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!--VISTA DE LISTA  -->
    <record id="view_enrollment_list" model="ir.ui.view">
        <field name="name">benglish.enrollment.list</field>
        <field name="model">benglish.enrollment</field>
        <field name="arch" type="xml">
            <list string="Matr√≠culas" sample="1"
                decoration-success="state == 'finished' and is_approved"
                decoration-info="state in ['active', 'in_progress']"
                decoration-warning="state in ['enrolled', 'pending']"
                decoration-danger="state == 'finished' and not is_approved"
                decoration-muted="state in ['withdrawn', 'cancelled', 'suspended']"
                decoration-primary="state == 'homologated'">
                <field name="code" optional="show" />
                <field name="enrollment_date" optional="show" />
                <field name="student_id" widget="many2one_avatar_user" />
                <field name="group_id" />
                <field name="campus_id" optional="show" />
                <field name="delivery_mode" widget="badge" optional="show"
                    decoration-success="delivery_mode == 'presential'"
                    decoration-info="delivery_mode == 'virtual'"
                    decoration-warning="delivery_mode == 'hybrid'" />
                <field name="attendance_type" widget="badge" optional="hide" />
                <field name="coach_id" optional="show" />
                <field name="start_date" optional="hide" />
                <field name="end_date" optional="hide" />
                <field name="prerequisites_met" invisible="1" />
                <field name="group_available_seats" optional="show" />
                <field name="final_grade" optional="show" />
                <field name="is_approved" optional="show" />
                <field name="state" widget="badge"
                    decoration-success="state in ['active', 'finished'] and is_approved"
                    decoration-info="state == 'active'"
                    decoration-warning="state == 'pending'"
                    decoration-danger="state == 'finished' and not is_approved"
                    decoration-muted="state == 'suspended'" />
            </list>
        </field>
    </record>

    <!-- VISTA DE FORMULARIO -->
    <record id="view_enrollment_form" model="ir.ui.view">
        <field name="name">benglish.enrollment.form</field>
        <field name="model">benglish.enrollment</field>
        <field name="arch" type="xml">
            <form string="Matr√≠cula" chatter_position="bottom">
                <header>
                    <!-- Botones de flujo -->
                    <button name="action_submit" type="object" string="Enviar para Aprobaci√≥n"
                        invisible="state != 'draft'"
                        class="oe_highlight" />
                    <button name="action_approve" type="object" string="Aprobar Matr√≠cula"
                        invisible="state != 'pending'"
                        class="oe_highlight"
                        groups="benglish_academy.group_academic_coordinator" />
                    <button name="action_complete" type="object" string="Completar (Aprobada)"
                        invisible="state not in ['in_progress', 'active']"
                        groups="benglish_academy.group_academic_coordinator" />
                    <button name="action_fail" type="object" string="Reprobar"
                        invisible="state not in ['in_progress', 'active']"
                        groups="benglish_academy.group_academic_coordinator"
                        confirm="¬øEst√° seguro de reprobar esta matr√≠cula?" />
                    <button name="action_suspend" type="object" string="Suspender"
                        invisible="state != 'active'"
                        groups="benglish_academy.group_academic_coordinator"
                        confirm="¬øEst√° seguro de suspender esta matr√≠cula?" />
                    <button name="action_reactivate" type="object" string="Reactivar"
                        invisible="state != 'suspended'"
                        class="oe_highlight"
                        groups="benglish_academy.group_academic_coordinator" />
                    <button name="action_withdraw" type="object" string="Retirar"
                        invisible="state not in ['enrolled', 'in_progress', 'active']"
                        confirm="¬øEst√° seguro de retirar al estudiante de esta asignatura?" />
                    <button name="action_cancel" type="object" string="Cancelar"
                        invisible="state not in ['draft', 'pending']" />
                    <button name="action_set_to_draft" type="object" string="Volver a Borrador"
                        invisible="state != 'cancelled'"
                        groups="benglish_academy.group_academic_manager" />
                    <button name="action_homologate" type="object" string="Homologar"
                        invisible="state != 'finished' or not is_approved"
                        class="oe_highlight"
                        groups="benglish_academy.group_academic_coordinator"
                        confirm="¬øEst√° seguro de homologar esta matr√≠cula?" />
                    <button name="action_advance_level" type="object" string="‚¨ÜÔ∏è Avanzar Nivel"
                        invisible="state not in ['active', 'in_progress']"
                        class="btn-success"
                        groups="benglish_academy.group_academic_coordinator"
                        confirm="¬øEst√° seguro de avanzar al estudiante al siguiente nivel? Se verificar√° que todos los requisitos del nivel actual est√©n completados." />

                    <field name="state" widget="statusbar"
                        statusbar_visible="draft,pending,active,finished,homologated" />
                </header>

                <sheet class="o_form_sheet_full">
                    <!-- Alertas de validaci√≥n -->
                    <div class="alert alert-warning" role="alert"
                        invisible="state != 'suspended'">
                        <strong>‚è∏Ô∏è Matr√≠cula Suspendida</strong>
                        <p>Esta matr√≠cula est√° suspendida por congelamiento.<br /> Se reactivar√°
                            autom√°ticamente al finalizar el periodo de congelamiento.</p>
                    </div>

                    <div class="alert alert-danger" role="alert"
                        invisible="prerequisites_met or not prerequisite_ids">
                        <strong>‚ö†Ô∏è Prerrequisitos No Cumplidos</strong>
                        <p> El estudiante no cumple con los prerrequisitos para esta asignatura. <br />
                            <strong>
                            Faltan:</strong> <field name="missing_prerequisites" readonly="1" />
                        </p>
                        <button name="%(benglish_academy.action_benglish_subject)d"
                            type="action"
                            string="üîç Ver Prerrequisitos Faltantes"
                            class="btn-warning"
                            context="{'search_default_id': prerequisite_ids}"
                            invisible="not prerequisite_ids" />
                    </div>

                    <div class="alert alert-info" role="alert"
                        invisible="not prerequisite_override or state in ['cancelled', 'withdrawn']">
                        <strong>üõ°Ô∏è Excepci√≥n de Prerrequisitos Autorizada</strong>
                        <p> Esta matr√≠cula fue aprobada con excepci√≥n de prerrequisitos. <br />
                            <strong>Autorizada
                            por:</strong> <field name="override_by" readonly="1" />
                        </p>
                    </div>

                    <div class="alert alert-warning" role="alert"
                        invisible="not group_id or group_available_seats > 5 or state in ['cancelled', 'withdrawn']">
                        <strong>‚ö†Ô∏è Cupos Limitados</strong>
                        <p> El grupo tiene pocos cupos disponibles: <field
                                name="group_available_seats" readonly="1" /> / <field
                                name="group_capacity" readonly="1" />
                        </p>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_student" type="object"
                            class="oe_stat_button" icon="fa-user">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver</span>
                                <span class="o_stat_text">Estudiante</span>
                            </div>
                        </button>
                        <button name="action_view_group" type="object"
                            class="oe_stat_button" icon="fa-users"
                            invisible="not group_id">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver</span>
                                <span class="o_stat_text">Grupo</span>
                            </div>
                        </button>
                        <button name="action_view_sessions" type="object"
                            class="oe_stat_button" icon="fa-calendar"
                            invisible="not group_id or not total_sessions">
                            <field name="total_sessions" widget="statinfo"
                                string="Sesiones" />
                        </button>
                    </div>

                    <div class="oe_title">
                        <label for="student_id" string="Matr√≠cula de Estudiante" />
                        <h1>
                            <field name="student_id"
                                placeholder="Seleccione un estudiante..."
                                required="1"
                                options="{'no_create': True, 'no_open': True}" />
                        </h1>
                        <h3>
                            <field name="code" readonly="1" />
                        </h3>
                    </div>

                    <group>
                        <group name="student_info" string="Informaci√≥n del Estudiante">
                            <field name="student_code" />
                            <field name="student_email" widget="email" />
                            <field name="student_phone" widget="phone" />
                            <field name="enrollment_date" />
                        </group>
                        <group name="academic_structure" string="Estructura Acad√©mica"
                            readonly="state in ['finished', 'withdrawn', 'cancelled']">
                            <field name="program_id" />
                            <field name="plan_id" domain="[('program_id', '=', program_id)]" />
                            <field name="current_phase_id" />
                            <field name="current_level_id" />
                        </group>
                    </group>

                    <group>
                        <group name="contract_info" string="Datos del Contrato Acad√©mico">
                            <field name="categoria" placeholder="Ej: Regular, Intensivo, VIP" />
                            <field name="course_start_date" />
                            <field name="course_end_date" />
                            <field name="max_freeze_date" />
                            <field name="course_days" />
                        </group>
                        <group name="group_info" string="Grupo y Ubicaci√≥n"
                            invisible="not group_id">
                            <field name="group_id" required="0"
                                domain="[('state', 'in', ['confirmed', 'in_progress'])]"
                                options="{'no_create': True}" />
                            <field name="course_id" readonly="1" />
                            <field name="campus_id" readonly="1" />
                            <field name="subcampus_id" readonly="1" />
                            <field name="coach_id" readonly="1" />
                        </group>
                        <group name="capacity_info" string="Capacidad y Cupos">
                            <field name="group_capacity" />
                            <field name="group_current_students" />
                            <field name="group_available_seats" />
                            <!-- Para grupos h√≠bridos -->
                            <field name="presential_capacity"
                                invisible="delivery_mode != 'hybrid'" />
                            <field name="virtual_capacity"
                                invisible="delivery_mode != 'hybrid'" />
                        </group>
                    </group>

                    <group>
                        <group name="modality" string="Modalidad de Asistencia">
                            <field name="delivery_mode" widget="radio" required="1" />
                            <field name="attendance_type"
                                invisible="delivery_mode != 'hybrid'"
                                widget="radio" />
                        </group>
                        <group name="schedule" string="Horarios">
                            <field name="start_date" readonly="1" />
                            <field name="end_date" readonly="1" />
                            <field name="schedule" readonly="1" />
                        </group>
                    </group>

                    <!-- Prerrequisitos -->
                    <group name="prerequisites_group" string="Prerrequisitos"
                        invisible="not prerequisite_ids">
                        <field name="prerequisite_count" invisible="1" />
                        <field name="prerequisites_met" widget="boolean_toggle" />
                        <field name="prerequisite_ids" nolabel="1" readonly="1">
                            <list>
                                <field name="code" />
                                <field name="name" />
                                <field name="level_id" />
                            </list>
                        </field>
                    </group>

                    <notebook>
                        <!-- P√°gina de Calificaciones -->
                        <page name="grades" string="üìä Calificaciones"
                            invisible="state in ['draft', 'pending', 'cancelled', 'suspended']">
                            <group>
                                <group>
                                    <field name="final_grade"
                                        readonly="state in ['finished', 'withdrawn']"
                                        required="state == 'finished'"
                                        groups="benglish_academy.group_academic_teacher,benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                                    <field name="min_passing_grade" readonly="1" />
                                    <field name="is_approved" widget="boolean_toggle" />
                                </group>
                                <group>
                                    <field name="completed_date" readonly="1" />
                                </group>
                            </group>
                        </page>

                        <!-- P√°gina de Observaciones -->
                        <page name="notes" string="üìù Observaciones">
                            <field name="notes" placeholder="Observaciones sobre esta matr√≠cula..." />
                        </page>

                        <!-- P√°gina de Retiro/Cancelaci√≥n -->
                        <page name="withdrawal" string="üö´ Retiro/Cancelaci√≥n"
                            invisible="state not in ['withdrawn', 'cancelled']">
                            <group>
                                <group>
                                    <field name="withdrawal_date" readonly="1" />
                                    <field name="withdrawal_reason" readonly="1" />
                                </group>
                                <group>
                                    <field name="cancellation_reason" readonly="1" />
                                </group>
                            </group>
                        </page>

                        <!-- P√°gina de Excepci√≥n de Prerrequisitos -->
                        <page name="override" string="üõ°Ô∏è Excepci√≥n de Prerrequisitos"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager"
                            invisible="not prerequisite_ids">
                            <div class="alert alert-warning mb-3" role="alert">
                                <h5>
                                    <i class="fa fa-exclamation-triangle" />
                                    <strong>Autorizaci√≥n de Excepci√≥n</strong>
                                </h5>
                                <p> Esta opci√≥n permite aprobar una matr√≠cula aunque el estudiante
                                    no haya completado todos los prerrequisitos requeridos. <strong>Use
                                    con precauci√≥n y solo en casos justificados.</strong>
                                </p>
                                <hr />
                                <small>
                                    <i class="fa fa-check-circle" /> Debe proporcionar una
                                    justificaci√≥n clara<br />
                                    <i class="fa fa-history" /> La
                                    excepci√≥n quedar√° registrada en el historial<br />
                                    <i
                                        class="fa fa-user-shield" /> Solo coordinadores y
                                    administradores pueden autorizar </small>
                            </div>
                            <group>
                                <group>
                                    <field name="prerequisite_override"
                                        widget="boolean_toggle"
                                        readonly="state not in ['draft', 'pending']" />
                                    <field name="override_by" readonly="1" />
                                </group>
                                <group>
                                    <field name="override_reason"
                                        placeholder="Escriba la justificaci√≥n para esta excepci√≥n..."
                                        required="prerequisite_override"
                                        readonly="state not in ['draft', 'pending']" />
                                </group>
                            </group>
                        </page>

                        <!-- P√°gina de Control -->
                        <page name="control" string="‚öôÔ∏è Control"
                            groups="benglish_academy.group_academic_coordinator">
                            <group>
                                <group>
                                    <field name="approved_date" readonly="1" />
                                    <field name="approved_by" readonly="1" />
                                </group>
                            </group>
                        </page>

                        <!-- P√°gina de Requisitos del Nivel Actual -->
                        <page name="requirements" string="‚úÖ Requisitos Acad√©micos"
                            invisible="state in ['draft', 'pending', 'cancelled']">
                            <div class="alert alert-info mb-3" role="alert">
                                <i class="fa fa-info-circle" />
                                <strong> Estado de requisitos del
                                nivel actual.</strong> Los requisitos se generan autom√°ticamente
                                seg√∫n la configuraci√≥n del plan. Complete todos los requisitos para
                                poder avanzar al siguiente nivel. </div>
                            <field name="requirement_status_ids" readonly="1">
                                <list decoration-muted="state == 'locked'"
                                    decoration-info="state == 'pending'"
                                    decoration-warning="state == 'in_progress'"
                                    decoration-success="state == 'completed'">
                                    <field name="level_id" />
                                    <field name="requirement_type" />
                                    <field name="subject_id" />
                                    <field name="state" widget="badge"
                                        decoration-muted="state == 'locked'"
                                        decoration-info="state == 'pending'"
                                        decoration-warning="state == 'in_progress'"
                                        decoration-success="state == 'completed'" />
                                    <field name="completed_count" />
                                    <field name="min_selection" string="Requerido" />
                                    <field name="progress_percentage" widget="progressbar" />
                                    <field name="completed_date" />
                                </list>
                            </field>
                        </page>

                        <!-- P√°gina de Cumplimiento Acad√©mico -->
                        <page name="compliance" string="üìã Cumplimiento"
                            invisible="state in ['draft', 'pending', 'cancelled']">
                            <field name="compliance_ids" readonly="1">
                                <list decoration-success="compliance_type == 'class_attended'"
                                    decoration-info="compliance_type == 'elective_completed'"
                                    decoration-warning="compliance_type == 'choice_fulfilled'">
                                    <field name="subject_id" />
                                    <field name="compliance_type" widget="badge"
                                        decoration-success="compliance_type == 'class_attended'"
                                        decoration-info="compliance_type == 'elective_completed'"
                                        decoration-warning="compliance_type == 'choice_fulfilled'" />
                                    <field name="class_execution_id" />
                                    <field name="compliance_date" />
                                    <field name="notes" optional="hide" />
                                </list>
                            </field>
                        </page>

                        <!-- P√°gina de Homologaci√≥n -->
                        <page name="homologation" string="üéì Homologaci√≥n"
                            invisible="state != 'homologated'"
                            groups="benglish_academy.group_academic_coordinator">
                            <div class="alert alert-success mb-3" role="alert">
                                <h5>
                                    <i class="fa fa-graduation-cap" />
                                    <strong>Matr√≠cula Homologada</strong>
                                </h5>
                                <p>Esta matr√≠cula ha sido homologada, reconociendo estudios o
                                    competencias previas del estudiante.</p>
                            </div>
                            <group>
                                <group>
                                    <field name="homologation_date" readonly="1" />
                                    <field name="homologated_by" readonly="1" />
                                </group>
                                <group>
                                    <field name="homologation_reason" readonly="1" />
                                    <field name="homologation_document" readonly="1" />
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter />
            </form>
        </field>
    </record>

    <!-- VISTA KANBAN -->
    <record id="view_enrollment_kanban" model="ir.ui.view">
        <field name="name">benglish.enrollment.kanban</field>
        <field name="model">benglish.enrollment</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1"
                default_group_by="state" quick_create="false">
                <field name="id" />
                <field name="student_id" />
                <field name="group_id" />
                <field name="campus_id" />
                <field name="delivery_mode" />
                <field name="state" />
                <field name="is_approved" />
                <field name="prerequisites_met" />
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="student_id" />
                                    </strong>
                                    <div class="o_kanban_record_subtitle">
                                        <field name="group_id" />
                                    </div>
                                </div>
                                <span class="float-end badge badge-pill"
                                    t-attf-class="badge-{{record.state.raw_value == 'completed' and record.is_approved.raw_value ? 'success' : record.state.raw_value == 'in_progress' ? 'info' : record.state.raw_value == 'failed' ? 'danger' : 'warning'}}">
                                    <field name="state" />
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="campus_id" />
                                <span t-if="record.delivery_mode.raw_value == 'hybrid'"
                                    class="badge badge-warning">
                                    H√≠brido
                                </span>
                                <span t-if="!record.prerequisites_met.raw_value"
                                    class="badge badge-danger">
                                    ‚ö†Ô∏è Prerrequisitos
                                </span>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <field name="enrollment_date" />
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- VISTA DE B√öSQUEDA  -->
    <record id="view_enrollment_search" model="ir.ui.view">
        <field name="name">benglish.enrollment.search</field>
        <field name="model">benglish.enrollment</field>
        <field name="arch" type="xml">
            <search string="Buscar Matr√≠culas">
                <!-- B√∫squeda -->
                <field name="code" />
                <field name="student_id" />
                <field name="group_id" />
                <field name="campus_id" />
                <field name="coach_id" />

                <!-- Filtros por estado -->
                <filter name="filter_draft" string="Borrador"
                    domain="[('state', '=', 'draft')]" />
                <filter name="filter_pending" string="Pendiente"
                    domain="[('state', '=', 'pending')]" />
                <filter name="filter_enrolled" string="Matriculado"
                    domain="[('state', '=', 'enrolled')]" />
                <filter name="filter_in_progress" string="En Progreso"
                    domain="[('state', '=', 'in_progress')]" />
                <filter name="filter_completed" string="Completado"
                    domain="[('state', '=', 'completed')]" />
                <separator />

                <!-- Filtros por modalidad -->
                <filter name="filter_presential" string="Presencial"
                    domain="[('delivery_mode', '=', 'presential')]" />
                <filter name="filter_virtual" string="Virtual"
                    domain="[('delivery_mode', '=', 'virtual')]" />
                <filter name="filter_hybrid" string="H√≠brido"
                    domain="[('delivery_mode', '=', 'hybrid')]" />
                <separator />

                <!-- Filtros adicionales -->
                <filter name="filter_active" string="Activas"
                    domain="[('state', 'in', ['enrolled', 'in_progress'])]" />
                <filter name="filter_prerequisites_not_met" string="Sin Prerrequisitos"
                    domain="[('prerequisites_met', '=', False)]" />
                <filter name="filter_approved" string="Aprobados"
                    domain="[('is_approved', '=', True)]" />
                <filter name="filter_failed" string="Reprobados"
                    domain="[('state', '=', 'failed')]" />
                <separator />

                <!-- Filtros por fecha -->
                <filter name="filter_current_month" string="Este Mes"
                    domain="[('enrollment_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')), ('enrollment_date', '&lt;=', (context_today() + relativedelta(day=31)).strftime('%Y-%m-%d'))]" />
                <filter name="filter_this_year" string="Este A√±o"
                    domain="[('enrollment_date', '&gt;=', datetime.datetime.now().strftime('%Y-01-01'))]" />

                <!-- Agrupaci√≥n -->
                <group expand="0" string="Agrupar Por">
                    <filter name="group_student" string="Estudiante"
                        context="{'group_by': 'student_id'}" />
                    <filter name="group_group" string="Grupo"
                        context="{'group_by': 'group_id'}" />
                    <filter name="group_campus" string="Sede"
                        context="{'group_by': 'campus_id'}" />
                    <filter name="group_program" string="Programa"
                        context="{'group_by': 'program_id'}" />
                    <filter name="group_level" string="Nivel"
                        context="{'group_by': 'current_level_id'}" />
                    <filter name="group_delivery_mode" string="Modalidad"
                        context="{'group_by': 'delivery_mode'}" />
                    <filter name="group_state" string="Estado"
                        context="{'group_by': 'state'}" />
                    <separator />
                    <filter name="group_enrollment_date" string="Fecha de Matr√≠cula"
                        context="{'group_by': 'enrollment_date'}" />
                </group>
            </search>
        </field>
    </record>

    <!-- ACCI√ìN PRINCIPAL -->
    <record id="action_enrollment" model="ir.actions.act_window">
        <field name="name">Matr√≠culas</field>
        <field name="res_model">benglish.enrollment</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="context">{
            'search_default_filter_active': 1,
            }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crear una nueva matr√≠cula
            </p>
            <p> Matricule estudiantes en grupos y asignaturas.<br /> El sistema validar√°
                autom√°ticamente: <ul>
                    <li>‚úÖ Prerrequisitos cumplidos</li>
                    <li>‚úÖ Cupos disponibles en el grupo</li>
                    <li>‚úÖ Modalidad compatible</li>
                    <li>‚úÖ Horarios sin conflictos </li>
                </ul>
            </p>
        </field>
    </record>

    <!-- ACCI√ìN KANBAN  -->
    <record id="action_enrollment_kanban" model="ir.actions.act_window">
        <field name="name">Gesti√≥n de Matr√≠culas</field>
        <field name="res_model">benglish.enrollment</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="context">{
            'search_default_filter_active': 1,
            }</field>
    </record>

</odoo>