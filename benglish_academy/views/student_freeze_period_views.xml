<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Vista de √°rbol (lista) -->
    <record id="view_student_freeze_period_tree" model="ir.ui.view">
        <field name="name">benglish.student.freeze.period.tree</field>
        <field name="model">benglish.student.freeze.period</field>
        <field name="arch" type="xml">
            <list string="Periodos de Congelamiento" 
                decoration-info="estado == 'borrador'"
                decoration-warning="estado == 'pendiente'"
                decoration-success="estado == 'aprobado'"
                decoration-danger="estado == 'rechazado'"
                decoration-muted="estado in ('cancelado', 'finalizado')">
                <field name="student_id"/>
                <field name="enrollment_id" optional="show"/>
                <field name="plan_id" optional="show"/>
                <field name="fecha_solicitud"/>
                <field name="fecha_inicio"/>
                <field name="fecha_fin"/>
                <field name="dias"/>
                <field name="estado" widget="badge" 
                    decoration-info="estado == 'borrador'"
                    decoration-warning="estado == 'pendiente'"
                    decoration-success="estado == 'aprobado'"
                    decoration-danger="estado == 'rechazado'"
                    decoration-muted="estado in ('cancelado', 'finalizado')"/>
                <field name="es_especial" widget="boolean_toggle" optional="show"/>
                <field name="aprobado_por_id" optional="hide"/>
                <field name="ajuste_aplicado" optional="hide"/>
            </list>
        </field>
    </record>
    
    <!-- Vista de formulario REDISE√ëADA -->
    <record id="view_student_freeze_period_form" model="ir.ui.view">
        <field name="name">benglish.student.freeze.period.form</field>
        <field name="model">benglish.student.freeze.period</field>
        <field name="arch" type="xml">
            <form string="Solicitud de Congelamiento">
                <header>
                    <button name="action_enviar_aprobacion" type="object" string="üì§ Enviar a Aprobaci√≥n"
                        class="btn-primary" invisible="estado != 'borrador'"/>
                    <button name="action_abrir_preview_aprobacion" type="object" string="üîç Preview y Aprobar"
                        class="btn-success" invisible="estado != 'pendiente'"
                        groups="benglish_academy.group_academic_coordinator"/>
                    <button name="action_aprobar" type="object" string="‚úÖ Aprobar Directo"
                        class="btn-secondary" invisible="estado != 'pendiente'"
                        groups="benglish_academy.group_academic_manager"
                        confirm="¬øEst√° seguro de aprobar sin revisar el preview?"/>
                    <button name="action_rechazar" type="object" string="‚ùå Rechazar"
                        class="btn-danger" invisible="estado != 'pendiente'"/>
                    <button name="action_cancelar" type="object" string="Cancelar"
                        invisible="estado not in ('borrador', 'pendiente')"
                        confirm="¬øEst√° seguro de cancelar esta solicitud?"/>
                    <button name="action_finalizar" type="object" string="Finalizar"
                        invisible="estado != 'aprobado'"
                        confirm="¬øDesea finalizar este congelamiento?"/>
                    <button name="action_revertir_ajuste" type="object" string="‚ö† Revertir Ajuste"
                        class="btn-secondary" invisible="not ajuste_aplicado"
                        groups="benglish_academy.group_benglish_manager"
                        confirm="¬øEst√° seguro? Esto revertir√° la fecha de fin de la matr√≠cula a su valor original."/>
                    <field name="estado" widget="statusbar" 
                        statusbar_visible="borrador,pendiente,aprobado,finalizado"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                    </div>
                    
                    <widget name="web_ribbon" title="‚ö† CONGELAMIENTO ESPECIAL" 
                        invisible="not es_especial" bg_color="text-bg-warning"/>
                    <widget name="web_ribbon" title="‚ùå RECHAZADO" 
                        invisible="estado != 'rechazado'" bg_color="text-bg-danger"/>
                    <widget name="web_ribbon" title="‚úÖ APROBADO" 
                        invisible="estado != 'aprobado'" bg_color="text-bg-success"/>
                    
                    <div class="oe_title">
                        <label for="student_id" string="Estudiante"/>
                        <h1>
                            <field name="student_id" options="{'no_create': True}"
                                readonly="estado != 'borrador'" 
                                placeholder="Seleccione el estudiante..."/>
                        </h1>
                    </div>
                    
                    <!-- Mensaje de validaci√≥n en tiempo real -->
                    <div class="alert alert-info" role="alert" style="margin-bottom: 20px;">
                        <field name="mensaje_validacion" nolabel="1"/>
                    </div>
                    
                    <group>
                        <group string="üìã Informaci√≥n de la Matr√≠cula">
                            <field name="enrollment_id" options="{'no_create': True}"
                                readonly="estado != 'borrador'"
                                required="1"/>
                            <field name="plan_id"/>
                            <field name="fecha_solicitud"/>
                            <field name="freeze_config_id" invisible="1"/>
                        </group>
                        <group string="üìÖ Periodo de Congelamiento">
                            <field name="fecha_inicio" 
                                readonly="estado not in ('borrador', 'pendiente')"
                                required="1"/>
                            <field name="fecha_fin" 
                                readonly="estado not in ('borrador', 'pendiente')"
                                required="1"/>
                            <field name="dias" string="Total de D√≠as"/>
                            <field name="dias_restantes" 
                                invisible="estado != 'aprobado'"
                                decoration-danger="dias_restantes &lt;= 7"
                                decoration-warning="dias_restantes &lt;= 14"/>
                        </group>
                    </group>
                    
                    <group string="üìù Motivo del Congelamiento">
                        <field name="freeze_reason_id" 
                            placeholder="Seleccione el motivo de su solicitud..."
                            readonly="estado not in ('borrador', 'pendiente')"
                            required="1"
                            options="{'no_create': True, 'no_open': True}"/>
                        <field name="requiere_documentacion" invisible="1"/>
                        <field name="tipos_documentos_requeridos" invisible="1"/>
                    </group>
                    
                    <group string="üí¨ Detalles Adicionales (Opcional pero recomendado)">
                        <field name="motivo_detalle" nolabel="1"
                            readonly="estado not in ('borrador', 'pendiente')"
                            placeholder="Proporcione informaci√≥n adicional que respalde su solicitud...&#10;&#10;Por ejemplo:&#10;- Fechas espec√≠ficas&#10;- Circunstancias particulares&#10;- Planes de retorno&#10;- Cualquier informaci√≥n relevante"/>
                    </group>
                    
                    <!-- Documentaci√≥n requerida -->
                    <group string="üìé Documentos de Soporte" invisible="not requiere_documentacion">
                        <div class="alert alert-warning" role="alert" colspan="2">
                            <i class="fa fa-exclamation-triangle"/> 
                            <strong>Este motivo requiere documentaci√≥n de soporte</strong><br/>
                            Debe adjuntar: <field name="tipos_documentos_requeridos" nolabel="1" readonly="1"/>
                        </div>
                        <field name="documento_soporte_ids" widget="many2many_binary" nolabel="1" colspan="2"
                            readonly="estado == 'finalizado'"/>
                        <field name="documentacion_completa" invisible="1"/>
                    </group>
                    
                    <notebook>
                        <page string="Validaciones" name="validations" 
                            invisible="estado not in ('pendiente', 'aprobado')">
                            <group>
                                <group string="Estado de Cartera">
                                    <field name="estudiante_al_dia"/>
                                    <field name="excepcion_cartera"
                                        invisible="estudiante_al_dia"
                                        readonly="estado == 'aprobado'"/>
                                    <field name="motivo_excepcion_cartera"
                                        invisible="not excepcion_cartera"
                                        readonly="estado == 'aprobado'"/>
                                </group>
                                <group string="Evaluaci√≥n">
                                    <field name="puede_aprobar"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Congelamiento Especial" name="special"
                            groups="benglish_academy.group_benglish_manager,benglish_academy.group_benglish_coordinator">
                            <group>
                                <group string="Configuraci√≥n Especial">
                                    <field name="es_especial" readonly="estado not in ('borrador', 'pendiente')"/>
                                    <field name="tipo_especial" 
                                        invisible="not es_especial"
                                        required="es_especial"
                                        readonly="estado not in ('borrador', 'pendiente')"/>
                                    <field name="visible_portal"/>
                                </group>
                                <group string="Documentos de Soporte" invisible="not es_especial">
                                    <field name="documento_soporte_ids" widget="many2many_binary"
                                        readonly="estado == 'finalizado'"/>
                                    <field name="documentos_pendientes"/>
                                    <field name="fecha_limite_documentos" 
                                        invisible="not documentos_pendientes"/>
                                </group>
                            </group>
                            <group invisible="not es_especial">
                                <field name="motivo_especial" 
                                    readonly="estado not in ('borrador', 'pendiente')"/>
                            </group>
                        </page>
                        
                        <page string="Auditor√≠a" name="audit" 
                            invisible="estado not in ('aprobado', 'rechazado', 'finalizado')">
                            <group>
                                <group string="Aprobaci√≥n" invisible="estado == 'rechazado'">
                                    <field name="aprobado_por_id"/>
                                    <field name="fecha_aprobacion"/>
                                </group>
                                <group string="Rechazo" invisible="estado != 'rechazado'">
                                    <field name="rechazado_por_id"/>
                                    <field name="motivo_rechazo"/>
                                </group>
                            </group>
                            <group string="Ajuste de Matr√≠cula" 
                                invisible="not ajuste_aplicado">
                                <group>
                                    <field name="ajuste_aplicado"/>
                                    <field name="fecha_fin_original_enrollment"/>
                                    <field name="fecha_fin_nueva_enrollment"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Notas Internas" name="notes">
                            <group>
                                <field name="notas_internas"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>
    
    <!-- Vista de b√∫squeda -->
    <record id="view_student_freeze_period_search" model="ir.ui.view">
        <field name="name">benglish.student.freeze.period.search</field>
        <field name="model">benglish.student.freeze.period</field>
        <field name="arch" type="xml">
            <search string="Buscar Congelamientos">
                <field name="student_id"/>
                <field name="enrollment_id"/>
                <field name="plan_id"/>
                <separator/>
                <filter name="borrador" string="Borradores" 
                    domain="[('estado', '=', 'borrador')]"/>
                <filter name="pendiente" string="Pendientes de Aprobaci√≥n" 
                    domain="[('estado', '=', 'pendiente')]"/>
                <filter name="aprobado" string="Aprobados" 
                    domain="[('estado', '=', 'aprobado')]"/>
                <filter name="activos_hoy" string="Activos Hoy" 
                    domain="[('estado', '=', 'aprobado'), ('fecha_inicio', '&lt;=', context_today().strftime('%Y-%m-%d')), ('fecha_fin', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="rechazado" string="Rechazados" 
                    domain="[('estado', '=', 'rechazado')]"/>
                <filter name="finalizado" string="Finalizados" 
                    domain="[('estado', '=', 'finalizado')]"/>
                <separator/>
                <filter name="especial" string="Especiales" 
                    domain="[('es_especial', '=', True)]"/>
                <filter name="no_especial" string="No Especiales" 
                    domain="[('es_especial', '=', False)]"/>
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter name="group_estado" string="Estado" 
                        context="{'group_by': 'estado'}"/>
                    <filter name="group_student" string="Estudiante" 
                        context="{'group_by': 'student_id'}"/>
                    <filter name="group_plan" string="Plan" 
                        context="{'group_by': 'plan_id'}"/>
                    <filter name="group_mes" string="Mes de Solicitud" 
                        context="{'group_by': 'fecha_solicitud:month'}"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Vista Kanban -->
    <record id="view_student_freeze_period_kanban" model="ir.ui.view">
        <field name="name">benglish.student.freeze.period.kanban</field>
        <field name="model">benglish.student.freeze.period</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="estado">
                <field name="student_id"/>
                <field name="fecha_inicio"/>
                <field name="fecha_fin"/>
                <field name="dias"/>
                <field name="estado"/>
                <field name="color"/>
                <field name="es_especial"/>
                <progressbar field="estado" 
                    colors='{"borrador": "muted", "pendiente": "warning", "aprobado": "success", "rechazado": "danger", "cancelado": "default", "finalizado": "info"}'/>
                <templates>
                    <t t-name="card">
                        <div t-attf-class="oe_kanban_card #{record.es_especial.raw_value ? 'border-warning border-2' : ''}">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="student_id"/>
                                        </strong>
                                    </div>
                                    <span t-if="record.es_especial.raw_value" 
                                        class="badge text-bg-warning">
                                        Especial
                                    </span>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div>
                                        <i class="fa fa-calendar-o me-1"/>
                                        <field name="fecha_inicio"/> - <field name="fecha_fin"/>
                                    </div>
                                    <div>
                                        <strong><field name="dias"/> d√≠as</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- Vista Calendario -->
    <record id="view_student_freeze_period_calendar" model="ir.ui.view">
        <field name="name">benglish.student.freeze.period.calendar</field>
        <field name="model">benglish.student.freeze.period</field>
        <field name="arch" type="xml">
            <calendar string="Congelamientos" date_start="fecha_inicio" date_stop="fecha_fin"
                color="color" mode="month" quick_create="0">
                <field name="student_id"/>
                <field name="dias"/>
                <field name="estado"/>
            </calendar>
        </field>
    </record>
    
    <!-- Acci√≥n de ventana principal -->
    <record id="action_student_freeze_period" model="ir.actions.act_window">
        <field name="name">Congelamientos</field>
        <field name="res_model">benglish.student.freeze.period</field>
        <field name="view_mode">list,kanban,calendar,form</field>
        <field name="context">{'search_default_no_especial': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Gestione solicitudes de congelamiento
            </p>
            <p>
                Los estudiantes pueden solicitar congelar su matr√≠cula
                seg√∫n las pol√≠ticas de su plan de estudio.
            </p>
        </field>
    </record>
    
    <!-- Acci√≥n para ver pendientes -->
    <record id="action_freeze_pending" model="ir.actions.act_window">
        <field name="name">Congelamientos Pendientes</field>
        <field name="res_model">benglish.student.freeze.period</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="domain">[('estado', '=', 'pendiente')]</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Vista del wizard de rechazo -->
    <record id="view_freeze_reject_wizard_form" model="ir.ui.view">
        <field name="name">benglish.freeze.reject.wizard.form</field>
        <field name="model">benglish.freeze.reject.wizard</field>
        <field name="arch" type="xml">
            <form string="Rechazar Congelamiento">
                <group>
                    <field name="freeze_period_id" invisible="1"/>
                    <field name="student_name"/>
                    <field name="fecha_inicio"/>
                    <field name="fecha_fin"/>
                    <field name="dias"/>
                </group>
                <group>
                    <field name="motivo_rechazo" placeholder="Indique el motivo del rechazo..."/>
                </group>
                <footer>
                    <button name="action_confirmar_rechazo" type="object" 
                        string="Confirmar Rechazo" class="btn-danger"/>
                    <button string="Cancelar" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

</odoo>
