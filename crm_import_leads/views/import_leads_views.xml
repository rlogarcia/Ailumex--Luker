<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Vista de √°rbol/lista para mostrar las importaciones -->
    <record id="view_import_leads_wizard_list" model="ir.ui.view">
        <field name="name">import.leads.wizard.list</field>
        <field name="model">import.leads.wizard</field>
        <field name="arch" type="xml">
            <list string="Importaciones de Leads" create="true" delete="true">
                <field name="name" string="Referencia"/>
                <field name="file_name" string="Archivo"/>
                <field name="leads_count" string="Nuevos"/>
                <field name="leads_updated" string="Actualizados"/>
                <field name="contacts_created" string="Contactos Nuevos"/>
                <field name="contacts_updated" string="Contactos Actualizados"/>
                <field name="state" widget="badge" decoration-success="state == 'done'" decoration-info="state == 'draft'"/>
                <field name="create_date" string="Fecha"/>
            </list>
        </field>
    </record>

    <!-- Vista de formulario con los 3 botones en el header -->
    <record id="view_import_leads_wizard_form" model="ir.ui.view">
        <field name="name">import.leads.wizard.form</field>
        <field name="model">import.leads.wizard</field>
        <field name="arch" type="xml">
            <form string="Importar Leads">
                <header>
            <!-- Bot√≥n 1: Descargar plantilla -->
            <button name="action_download_template"
                type="object"
                string="üì• Descargar Plantilla"
                class="btn-primary"/>
            <!-- Bot√≥n 2: Importar archivo (solo visible si hay archivo y est√° en borrador) -->
            <button name="action_import"
                type="object"
                string="üì§ Importar Archivo"
                class="btn-success"
                modifiers="{'invisible': ['|', ('state', '=', 'done'), ('file_data', '=', False)]}"
                confirm="¬øEst√°s seguro de que deseas importar este archivo?"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,done"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box" modifiers="{'invisible': [('state', '!=', 'done')]}">
                        <button class="oe_stat_button" type="object" name="action_view_leads" icon="fa-list-ul" modifiers="{'invisible': [('leads_count', '=', 0)]}">
                            <field name="leads_count" widget="statinfo" string="Leads"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>

                    <!-- Secci√≥n principal con informaci√≥n -->
                    <group>
                        <group string="üìÅ Archivo de Importaci√≥n">
                            <field name="file_name"
                                   modifiers="{'readonly': True, 'invisible': [('file_name', '=', False)]}"/>
                            <field name="file_data"
                                   filename="file_name"
                                   widget="binary"
                                   options="{'accepted_file_extensions': '.csv,.xls,.xlsx'}"
                                   modifiers="{'readonly': [('state', '=', 'done')]}"/>
                        </group>
                        <group string="üìä Resumen de Importaci√≥n" modifiers="{'invisible': [('state', '!=', 'done')]}">
                            <field name="leads_count" string="Leads Nuevos" modifiers="{'readonly': True}"/>
                            <field name="leads_updated" string="Leads Actualizados" modifiers="{'readonly': True}"/>
                            <field name="contacts_created" modifiers="{'readonly': True}"/>
                            <field name="contacts_updated" modifiers="{'readonly': True}"/>
                            <field name="create_date" string="Fecha de Importaci√≥n" modifiers="{'readonly': True}"/>
                        </group>
                    </group>

                    <!-- Resultado detallado en un notebook -->
                    <notebook modifiers="{'invisible': [('state', '!=', 'done')]}">
                        <page string="üìã Resultado Detallado" name="result">
                            <group>
                                <div class="alert alert-success" role="alert" modifiers="{'invisible': [('result_message', '=', False)]}">
                                    <h4 class="alert-heading">
                                        <i class="fa fa-check-circle"/> Resumen de la Importaci√≥n
                                    </h4>
                                    <field name="result_message" nolabel="1" readonly="1" widget="text" class="o_field_text"/>
                                </div>
                            </group>
                        </page>
                        <page string="‚≠ê Puntajes de Leads" name="scoring">
                            <group>
                                <div class="o_scoring_details" modifiers="{'invisible': [('scoring_details', '=', False)]}">
                                    <div style="background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 16px 20px; margin-bottom: 20px;">
                                        <h3 style="color: #111827; margin: 0; font-weight: 600; font-size: 18px; letter-spacing: -0.5px;">
                                            An√°lisis de Puntuaci√≥n
                                        </h3>
                                        <p style="color: #6b7280; margin: 4px 0 0 0; font-size: 13px;">
                                            Scoring autom√°tico aplicado a cada lead importado
                                        </p>
                                    </div>
                                    <div style="background-color: #ffffff; padding: 0 20px 20px 20px;">
                                        <field name="scoring_details" nolabel="1" readonly="1" widget="html" class="o_field_html"/>
                                    </div>
                                </div>
                            </group>
                        </page>
                        <page string="üîç Enriquecimiento de Datos" name="enrichment">
                            <group>
                                <div class="o_enrichment_details" modifiers="{'invisible': [('enrichment_details', '=', False)]}">
                                    <div style="background-color: #ffffff; padding: 0 20px 20px 20px;">
                                        <field name="enrichment_details" nolabel="1" readonly="1" widget="html" class="o_field_html"/>
                                    </div>
                                </div>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de b√∫squeda/filtros -->
    <record id="view_import_leads_wizard_search" model="ir.ui.view">
        <field name="name">import.leads.wizard.search</field>
        <field name="model">import.leads.wizard</field>
        <field name="arch" type="xml">
            <search string="Buscar Importaciones">
                <field name="name" string="Referencia" filter_domain="[('name', 'ilike', self)]"/>
                <field name="file_name" string="Archivo"/>
                <separator/>
                <filter string="Borrador" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Completadas" name="filter_done" domain="[('state', '=', 'done')]"/>
                <separator/>
                <filter string="Este Mes" name="filter_this_month"
                        domain="[('create_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Este A√±o" name="filter_this_year"
                        domain="[('create_date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Estado" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Fecha" name="group_date" context="{'group_by': 'create_date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acci√≥n para abrir la lista de importaciones -->
    <record id="action_import_leads_wizard" model="ir.actions.act_window">
        <field name="name">Importar Leads</field>
        <field name="res_model">import.leads.wizard</field>
        <field name="view_mode">list,form</field>
        <field name="views" eval="[(ref('view_import_leads_wizard_list'), 'list'), (ref('view_import_leads_wizard_form'), 'form')]"/>
        <field name="target">current</field>
    </record>

    <!-- Men√∫ principal para importar leads -->
    <menuitem id="menu_crm_import_leads" name="Importar Leads" parent="crm.crm_menu_root" sequence="15" groups="base.group_user"/>
    <!-- Submen√∫ para abrir la lista de importaciones -->
    <menuitem id="menu_crm_import_leads_wizard" name="Importar" parent="menu_crm_import_leads" action="action_import_leads_wizard" sequence="10" groups="base.group_user"/>

</odoo>
