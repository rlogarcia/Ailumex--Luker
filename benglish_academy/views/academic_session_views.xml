<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================== -->
        <!-- VISTAS PARA ACADEMIC SESSION -->
        <!-- ========================================== -->

        <!-- Vista List -->
        <record id="view_academic_session_list" model="ir.ui.view">
            <field name="name">benglish.academic.session.list</field>
            <field name="model">benglish.academic.session</field>
            <field name="arch" type="xml">
                <list string="Clases"
                    decoration-info="state == 'draft'"
                    decoration-primary="state == 'with_enrollment'"
                    decoration-warning="state == 'started'"
                    decoration-success="state == 'done'"
                    decoration-danger="state == 'cancelled'">
                    <field name="session_code" readonly="1" />
                    <field name="date" />
                    <field name="weekday" />
                    <field name="time_start_label" string="Hora Inicio" />
                    <field name="time_end_label" string="Hora Fin" />
                    <field name="subject_id" />
                    <field name="student_alias" />
                    <field name="campus_id" />
                    <field name="subcampus_id" />
                    <field name="teacher_id" />
                    <field name="enrolled_count" />
                    <field name="max_capacity" />
                    <field name="is_full" invisible="1" />
                    <field name="state" />
                </list>
            </field>
        </record>

        <!-- Vista Form -->
        <record id="view_academic_session_form" model="ir.ui.view">
            <field name="name">benglish.academic.session.form</field>
            <field name="model">benglish.academic.session</field>
            <field name="arch" type="xml">
                <form string="Clase">
                    <header>
                        <button name="action_start" string="Iniciar Clase" type="object"
                            invisible="state not in ('draft','active','with_enrollment')"
                            class="btn-primary"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="action_mark_done" string="Marcar como Dictada" type="object"
                            invisible="state != 'started'" class="btn-success"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="action_draft" string="Regresar a Borrador" type="object"
                            invisible="state != 'started'" class="btn-warning"
                            groups="benglish_academy.group_academic_manager" />
                        <button name="action_cancel" string="Cancelar Sesi贸n" type="object"
                            invisible="state in ('done','cancelled')"
                            class="btn-danger"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="%(action_session_transfer_wizard)d"
                            string="Trasladar Estudiantes"
                            type="action"
                            class="btn-secondary"
                            invisible="state in ('done','cancelled')"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <field name="state" widget="statusbar"
                            statusbar_visible="draft,active,with_enrollment,started,done,cancelled" />
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_enrollments" type="object"
                                class="oe_stat_button" icon="fa-users">
                                <field name="enrolled_count" widget="statinfo" string="Inscritos" />
                            </button>
                            <button name="action_enroll_student" type="object"
                                class="oe_stat_button" icon="fa-user-plus"
                                invisible="not is_published or is_full">
                                <field name="available_spots" widget="statinfo" string="Disponibles" />
                            </button>
                        </div>
                        <widget name="web_ribbon" title="Dictada" bg_color="bg-success"
                            invisible="state != 'done'" />
                        <widget name="web_ribbon" title="Llena" bg_color="bg-warning"
                            invisible="not is_full" />
                        <widget name="web_ribbon" title="Publicada" bg_color="bg-info"
                            invisible="not is_published" />
                        <widget name="web_ribbon" title="Cancelada" bg_color="bg-danger"
                            invisible="state != 'cancelled'" />
                        <div class="oe_title">
                            <h1>
                                <field name="display_name" readonly="1" />
                            </h1>
                        </div>
                        <group string="Codigo de Sesi贸n">
                            <field name="session_code" readonly="1" />
                        </group>
                        <group string="Informaci贸n Acad茅mica">
                            <group>
                                <field name="program_id" required="1" options="{'no_create': True}" />

                                <!-- Pool de Electivas: visible solo cuando ES tipo electiva -->
                                <field name="elective_pool_id"
                                    domain="[('state', '=', 'active'), ('program_id', '=', program_id)]"
                                    options="{'no_create': True}"
                                    invisible="session_type != 'elective'"
                                    required="session_type == 'elective'" />

                                <!-- Fase Audiencia -->
                                <field name="audience_phase_id"
                                    domain="[('program_id', '=', program_id), ('active', '=', True)]"
                                    options="{'no_create': True}" />

                                <!-- Rango de unidades -->
                                <field name="audience_unit_from"
                                    placeholder="Unidad inicial (1-24)" />
                                <field name="audience_unit_to"
                                    placeholder="Unidad final (1-24)" />
                            </group>
                            <group>
                                <field name="session_type" required="1" />
                                <field name="elective_pool_id" invisible="1" />
                                <field name="subject_id"
                                    readonly="elective_pool_id"
                                    force_save="1"
                                    required="1"
                                    domain="[('program_id', '=', program_id), ('active', '=', True)]"
                                    options="{'no_create': True}" />
                            </group>
                        </group>
                        <group>
                            <group string="Horario y Ubicaci贸n">
                                <field name="agenda_id" required="1" readonly="1"
                                    domain="[('state', 'in', ['active', 'published'])]"
                                    options="{'no_create': True}" />
                                <field name="location_city" invisible="1" />
                                <field name="campus_id" readonly="1" />
                                <field name="delivery_mode" widget="radio"
                                    options="{'horizontal': true}" />
                                <field name="subcampus_id"
                                    invisible="delivery_mode == 'virtual'"
                                    context="{'show_only_name': True}"
                                    options="{'no_create': True}" />
                            </group>
                            <group string="Fecha y Hora">
                                <field name="date" required="1" />
                                <field name="weekday" readonly="1" />
                                <field name="time_start" widget="time_picker" required="1" />
                                <field name="time_end" widget="time_picker" required="1" />
                                <field name="duration_hours" readonly="1" />
                            </group>
                        </group>
                        <group string="Docente Asignado">
                            <group>
                                <field name="teacher_id"
                                    options="{'no_create': True, 'no_open': True}"
                                    placeholder="Selecciona un docente disponible..." />
                            </group>
                            <group invisible="not teacher_id or delivery_mode == 'presential'">
                                <label for="teacher_meeting_link" string="Enlace del Docente" />
                                <div>
                                    <field name="teacher_meeting_link" widget="url" readonly="1"
                                        class="text-muted small" nolabel="1" />
                                </div>
                                <field name="teacher_meeting_id" readonly="1"
                                    string="ID de Reuni贸n del Docente"
                                    class="text-muted small" />
                            </group>
                        </group>
                        <group string="Capacidad">
                            <group>
                                <field name="max_capacity" required="1"
                                    invisible="delivery_mode == 'hybrid'" />
                                <field name="max_capacity_presential"
                                    invisible="delivery_mode != 'hybrid'"
                                    required="delivery_mode == 'hybrid'" />
                                <field name="max_capacity_virtual"
                                    invisible="delivery_mode != 'hybrid'"
                                    required="delivery_mode == 'hybrid'" />
                                <field name="enrolled_count" readonly="1" />
                                <field name="available_spots" readonly="1" />
                            </group>
                            <group>
                                <field name="is_full" readonly="1" />
                                <field name="occupancy_rate" widget="progressbar" readonly="1" />
                            </group>
                        </group>
                        <notebook>
                            <page string=" Inscripciones"
                                invisible="enrolled_count == 0">
                                <field name="enrollment_ids" readonly="1">
                                    <list decoration-success="state == 'attended'"
                                        decoration-danger="state == 'absent'"
                                        decoration-muted="state == 'cancelled'">
                                        <field name="student_id" />
                                        <field name="student_email" />
                                        <field name="enrollment_date" />
                                        <field name="state" />
                                    </list>
                                </field>
                            </page>
                            <page string=" Notas">
                                <field name="notes" placeholder="Observaciones sobre la sesi贸n..." />
                            </page>
                        </notebook>
                    </sheet>
                    <chatter />
                </form>
            </field>
        </record>

        <!-- Vista Search -->
        <record id="view_academic_session_search" model="ir.ui.view">
            <field name="name">benglish.academic.session.search</field>
            <field name="model">benglish.academic.session</field>
            <field name="arch" type="xml">
                <search string="Buscar Clases">
                    <field name="subject_id" string="Asignatura"
                        filter_domain="['|', ('subject_id.name', 'ilike', self), ('subject_id.code', 'ilike', self)]" />
                    <field name="student_alias" string="Alias" />
                    <field name="teacher_id" />
                    <field name="campus_id" />
                    <field name="location_city" />
                    <field name="agenda_id" />
                    <separator />
                    <filter name="filter_draft" string="Borrador"
                        domain="[('state', '=', 'draft')]" />
                    <filter name="filter_active" string="Activas"
                        domain="[('state', '=', 'active')]" />
                    <filter name="filter_with_enrollment" string="Con Horario"
                        domain="[('state', '=', 'with_enrollment')]" />
                    <filter name="filter_started" string="Iniciadas"
                        domain="[('state', '=', 'started')]" />
                    <filter name="filter_done" string="Dictadas" domain="[('state', '=', 'done')]" />
                    <filter name="filter_cancelled" string="Canceladas"
                        domain="[('state', '=', 'cancelled')]" />
                    <separator />
                    <filter name="filter_presential" string="Presencial"
                        domain="[('delivery_mode', '=', 'presential')]" />
                    <filter name="filter_virtual" string="Virtual"
                        domain="[('delivery_mode', '=', 'virtual')]" />
                    <filter name="filter_hybrid" string="H铆brida"
                        domain="[('delivery_mode', '=', 'hybrid')]" />
                    <separator />
                    <filter name="filter_published" string="Publicadas"
                        domain="[('is_published', '=', True)]" />
                    <filter name="filter_not_published" string="No Publicadas"
                        domain="[('is_published', '=', False)]" />
                    <separator />
                    <filter name="filter_full" string="Clase Llena"
                        domain="[('is_full', '=', True)]" />
                    <filter name="filter_available" string="Con Cupos Disponibles"
                        domain="[('is_full', '=', False), ('is_published', '=', True)]" />
                    <separator />
                    <filter name="filter_today" string="Hoy"
                        domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]" />
                    <filter name="filter_next_7_days" string="Pr贸ximos 7 D铆as"
                        domain="[('date', '&gt;=', context_today().strftime('%Y-%m-%d')), ('date', '&lt;=', (context_today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]" />
                    <filter name="filter_next_30_days" string="Pr贸ximos 30 D铆as"
                        domain="[('date', '&gt;=', context_today().strftime('%Y-%m-%d')), ('date', '&lt;=', (context_today() + datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]" />
                    <group expand="0" string="Agrupar por">
                        <filter name="group_date" string="Fecha" context="{'group_by': 'date'}" />
                        <filter name="group_weekday" string="D铆a de la Semana"
                            context="{'group_by': 'weekday'}" />
                        <filter name="group_campus" string="Sede"
                            context="{'group_by': 'campus_id'}" />
                        <filter name="group_teacher" string="Docente"
                            context="{'group_by': 'teacher_id'}" />
                        <filter name="group_subject" string="Asignatura"
                            context="{'group_by': 'subject_id'}" />
                        <filter name="group_state" string="Estado" context="{'group_by': 'state'}" />
                        <filter name="group_agenda" string="Horario"
                            context="{'group_by': 'agenda_id'}" />
                    </group>
                </search>
            </field>
        </record>

        <!-- Vista Calendar - Matriz de Programaci贸n -->
        <record id="view_academic_session_calendar" model="ir.ui.view">
            <field name="name">benglish.academic.session.calendar</field>
            <field name="model">benglish.academic.session</field>
            <field name="arch" type="xml">
                <calendar string="Matriz de Programaci贸n de Clases"
                    mode="week"
                    date_start="datetime_start"
                    date_stop="datetime_end"
                    color="subject_id"
                    quick_create="false"
                    form_view_id="%(view_academic_session_form)s"
                    all_day="all_day"
                    hide_time="false">
                    <field name="session_code" readonly="1" />
                    <field name="subject_id" />
                    <field name="student_alias" />
                    <field name="teacher_id" />
                    <field name="campus_id" />
                    <field name="subcampus_id" invisible="delivery_mode == 'virtual'" />
                    <field name="teacher_meeting_link" widget="url" readonly="1"
                        class="text-muted small" nolabel="1" />
                    <field name="delivery_mode" />
                    <field name="enrolled_count" />
                    <field name="max_capacity" />
                    <field name="occupancy_rate" />
                    <field name="is_full" invisible="1" />
                    <field name="state" />
                    <field name="date" invisible="1" />
                    <field name="time_start" invisible="1" />
                    <field name="time_end" invisible="1" />
                    <field name="weekday" invisible="1" />
                    <field name="agenda_id" invisible="1" />
                    <field name="all_day" invisible="1" />
                    <field name="datetime_start" invisible="1" />
                    <field name="datetime_end" invisible="1" />
                </calendar>
            </field>
        </record>

        <!-- Vista Pivot -->
        <record id="view_academic_session_pivot" model="ir.ui.view">
            <field name="name">benglish.academic.session.pivot</field>
            <field name="model">benglish.academic.session</field>
            <field name="arch" type="xml">
                <pivot string="An谩lisis de Clases">
                    <field name="date" interval="week" type="row" />
                    <field name="campus_id" type="col" />
                    <field name="enrolled_count" type="measure" />
                    <field name="max_capacity" type="measure" />
                </pivot>
            </field>
        </record>

        <!-- Acci贸n Window -->
        <record id="action_academic_session" model="ir.actions.act_window">
            <field name="name">Clases</field>
            <field name="res_model">benglish.academic.session</field>
            <field name="view_mode">list,form,calendar,pivot</field>
            <field name="context">{'search_default_group_agenda': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Crear una nueva Clase
                </p>
                <p> Las clases son sesiones espec铆ficas dentro de un horario acad茅mico.<br /> Asigna
                    docente, aula, horario y gestiona las inscripciones de estudiantes. </p>
            </field>
        </record>

    </data>
</odoo>