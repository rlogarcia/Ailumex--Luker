<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Lista de sesiones      -->
        <record id="view_class_session_list" model="ir.ui.view">
            <field name="name">benglish.class.session.list</field>
            <field name="model">benglish.class.session</field>
            <field name="arch" type="xml">
                <list string="Clases" default_order="start_datetime"
                    decoration-muted="state == 'cancelled'" multi_edit="1"
                    decoration-danger="is_full"
                    decoration-warning="occupancy_rate &gt; 80 and not is_full">
                    <header>
                        <button name="action_publish_bulk" type="object"
                            string="Publicar Seleccionadas"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="%(benglish_academy.action_bulk_edit_sessions_wizard)d"
                            type="action" string="Edici√≥n Masiva"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="%(benglish_academy.action_duplicate_sessions_wizard)d"
                            type="action" string="Duplicar Sesiones"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                    </header>
                    <field name="start_datetime" string="Inicio" />
                    <field name="end_datetime" string="Fin" optional="show" />
                    <field name="program_id" optional="show" />
                    <field name="subject_id" />
                    <field name="is_prerequisite_session" widget="boolean" optional="show"
                        string="Prereq." />
                    <field name="location_city" optional="show" string="Ciudad" />
                    <field name="campus_id" />
                    <field name="subcampus_id" optional="show" />
                    <field name="teacher_id" widget="many2one_avatar_user" optional="show" />
                    <field name="coach_id" optional="show" />
                    <field name="session_type" widget="badge" />
                    <field name="delivery_mode" widget="badge"
                        decoration-success="delivery_mode == 'presential'"
                        decoration-info="delivery_mode == 'virtual'"
                        decoration-warning="delivery_mode == 'hybrid'" />
                    <field name="max_capacity" optional="show" string="Cupo" />
                    <field name="enrolled_count" optional="show" string="Inscritos" />
                    <field name="available_spots" optional="show" string="Disponibles" />
                    <field name="occupancy_rate" optional="show" widget="progressbar"
                        string="Ocupaci√≥n %" />
                    <field name="is_full" invisible="1" />
                    <field name="is_published" widget="boolean" optional="show" />
                    <field name="state" widget="badge"
                        decoration-info="state == 'planned'"
                        decoration-warning="state == 'in_progress'"
                        decoration-success="state == 'done'"
                        decoration-danger="state == 'cancelled'" />
                </list>
            </field>
        </record>


        <!-- Formulario              -->
        <record id="view_class_session_form" model="ir.ui.view">
            <field name="name">benglish.class.session.form</field>
            <field name="model">benglish.class.session</field>
            <field name="arch" type="xml">
                <form string="Clase">
                    <header>
                        <button name="action_mark_in_progress" type="object" string="Iniciar"
                            class="oe_highlight" invisible="state != 'planned'" />
                        <button name="action_mark_done" type="object" string="Marcar como dictada"
                            class="oe_highlight" invisible="state not in ('planned', 'in_progress')" />
                        <button name="action_publish" type="object" string="Publicar"
                            class="btn-success" invisible="is_published or state == 'cancelled'"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="action_unpublish" type="object" string="Despublicar"
                            class="btn-warning" invisible="not is_published"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="action_replace_teacher" type="object"
                            string="Reemplazar Docente"
                            invisible="not teacher_id or state == 'done'"
                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager" />
                        <button name="action_cancel" type="object" string="Cancelar"
                            class="btn-danger" invisible="state == 'cancelled'" />
                        <button name="action_reset_to_planned" type="object" string="Reprogramar"
                            invisible="state != 'cancelled'" />
                        <field name="state" widget="statusbar"
                            statusbar_visible="planned,in_progress,done,cancelled" />
                    </header>
                    <sheet>
                        <widget name="web_ribbon" title="‚ö° PRERREQUISITO" bg_color="text-bg-warning"
                            invisible="not is_prerequisite_session" />
                        <widget name="web_ribbon" title="‚úÖ PUBLICADA" bg_color="text-bg-success"
                            invisible="not is_published or is_prerequisite_session" />
                        <widget name="web_ribbon" title="Cancelada" bg_color="text-bg-danger"
                            invisible="state != 'cancelled'" />
                        <widget name="web_ribbon" title="En curso" bg_color="text-bg-warning"
                            invisible="state != 'in_progress'" />
                        <group>
                            <group>
                                <field name="program_id"
                                    options="{'no_create': True, 'no_create_edit': True}"
                                    placeholder="Primero selecciona el programa..." />
                                <field name="subject_id"
                                    options="{'no_create': True, 'no_create_edit': True}"
                                    placeholder="Finalmente selecciona la asignatura..." />
                                <field name="is_prerequisite_session" widget="boolean"
                                    string="Es Prerrequisito"
                                    help="Marca esta casilla si esta sesi√≥n es un prerrequisito que debe tomarse antes que otras" />
                                <field name="session_type" />
                            </group>
                            <group>
                                <field name="delivery_mode" widget="radio" />
                                <field name="meeting_platform"
                                    invisible="delivery_mode == 'presential'" />
                                <field name="meeting_link" widget="url"
                                    invisible="delivery_mode == 'presential'" />
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="location_city"
                                    placeholder="Escoja la ciudad"
                                    invisible="delivery_mode == 'virtual'"
                                    string="Ubicaci√≥n (Ciudad)"
                                    help="Selecciona la ciudad donde se dictar√° la clase" />
                                <field name="campus_id" />
                                <field name="subcampus_id" invisible="delivery_mode == 'virtual'" />
                            </group>
                            <group>
                                <field name="teacher_id" widget="many2one_avatar_user" />
                                <field name="coach_id" />
                                <div class="alert alert-info mt-2" role="alert" 
                                    invisible="delivery_mode == 'presential' or not coach_id">
                                    <strong>üìã Enlace del Coach:</strong><br/>
                                    <field name="coach_meeting_link" widget="url" readonly="1" nolabel="1" class="d-block"/>
                                    <small class="text-muted">
                                        <field name="coach_meeting_platform" nolabel="1" readonly="1"/>
                                    </small>
                                </div>
                            </group>
                        </group>
                        <group string="FECHA Y HORA">
                            <group>
                                <label for="start_datetime" string="Fecha y Hora de Inicio"/>
                                <div class="o_row">
                                    <field name="start_datetime" widget="date" class="oe_inline" 
                                        placeholder="Selecciona la fecha"/>
                                </div>
                                <label for="start_time" string="Hora de Inicio"/>
                                <div>
                                    <field name="start_time" widget="time_picker" 
                                        class="oe_inline"
                                        help="Selecciona la hora de inicio usando el reloj o ingresa manualmente (HH:MM)"/>
                                    <div class="text-muted small mt-1">
                                        <i class="fa fa-info-circle"/> Haz clic en el reloj para selector visual o escribe directamente en formato HH:MM
                                    </div>
                                </div>
                            </group>
                            <group>
                                <label for="end_datetime" string="Fecha y Hora de Fin"/>
                                <div class="o_row">
                                    <field name="end_datetime" widget="date" class="oe_inline"
                                        placeholder="Selecciona la fecha"/>
                                </div>
                                <label for="end_time" string="Hora de Fin"/>
                                <div>
                                    <field name="end_time" widget="time_picker" 
                                        class="oe_inline"
                                        help="Selecciona la hora de fin usando el reloj o ingresa manualmente (HH:MM)"/>
                                    <div class="text-muted small mt-1">
                                        <i class="fa fa-info-circle"/> Duraci√≥n: <field name="duration_hours" readonly="1" nolabel="1" class="font-weight-bold"/> horas
                                    </div>
                                </div>
                            </group>
                        </group>
                        <group>
                            <group>
                                <field name="state" invisible="1" />
                                <field name="is_published" widget="boolean_toggle" readonly="1" />
                                <field name="published_at" readonly="1" invisible="not is_published" />
                                <field name="published_by_id" readonly="1"
                                    invisible="not is_published" />
                            </group>
                        </group>
                        <group invisible="state != 'cancelled'">
                            <field name="cancellation_reason"
                                placeholder="Describe el motivo de la cancelaci√≥n" />
                            <field name="cancelled_by_id" readonly="1" />
                            <field name="cancelled_at" readonly="1" />
                        </group>
                        <notebook>
                            <page string="üë• Estudiantes y Capacidad" name="students_capacity"
                                priority="1">
                                <group>
                                    <group string="Capacidad de la Sesi√≥n">
                                        <field name="max_capacity"
                                            help="N√∫mero m√°ximo de estudiantes permitidos en esta sesi√≥n" />
                                        <field name="enrolled_count" readonly="1"
                                            class="font-weight-bold" />
                                        <field name="available_spots" readonly="1" />
                                        <field name="is_full" widget="boolean" readonly="1" />
                                    </group>
                                    <group string="Estad√≠sticas de Ocupaci√≥n">
                                        <field name="occupancy_rate" widget="progressbar"
                                            readonly="1"
                                            help="Porcentaje de ocupaci√≥n actual de la sesi√≥n" />
                                        <div class="mt-2">
                                            <div class="alert alert-success" role="alert"
                                                invisible="occupancy_rate &lt; 50">
                                                <i class="fa fa-check-circle" /> Buena ocupaci√≥n </div>
                                            <div class="alert alert-warning" role="alert"
                                                invisible="occupancy_rate &lt; 80 or occupancy_rate &gt;= 100">
                                                <i class="fa fa-exclamation-triangle" /> Capacidad
                                                casi completa </div>
                                            <div class="alert alert-danger" role="alert"
                                                invisible="not is_full">
                                                <i class="fa fa-ban" /> Sesi√≥n completa - Sin cupos
                                                disponibles </div>
                                        </div>
                                    </group>
                                </group>
                                <group string="Gesti√≥n de Estudiantes Inscritos">
                                    <label for="student_ids"
                                        string="Estudiantes (Inscritos desde Portal)" />
                                    <div>
                                        <!-- Campo para COORDINADORES y MANAGERS: Solo permite
                                        REMOVER (X), no agregar -->
                                        <field name="student_ids" widget="many2many_tags"
                                            nolabel="1"
                                            options="{'no_create': True, 'no_quick_create': True, 'no_create_edit': True}"
                                            groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager"
                                            placeholder="Los estudiantes se inscriben desde el portal..."
                                            help="Solo puedes REMOVER estudiantes haciendo clic en la 'X'. No se pueden agregar manualmente." />
                                        <!-- Campo para otros usuarios: completamente readonly -->
                                        <field name="student_ids" widget="many2many_tags"
                                            nolabel="1"
                                            options="{'no_create': True, 'no_open': True}"
                                            readonly="1"
                                            groups="!benglish_academy.group_academic_coordinator,!benglish_academy.group_academic_manager"
                                            placeholder="Sin estudiantes inscritos" />
                                    </div>
                                    <div class="alert alert-warning mt-3" role="alert"
                                        groups="benglish_academy.group_academic_coordinator,benglish_academy.group_academic_manager">
                                        <i class="fa fa-exclamation-triangle" />
                                        <strong>‚ö†Ô∏è Gesti√≥n de Cupos (Solo Coordinadores):</strong>
                                        <ul class="mb-0 mt-2">
                                            <li><strong>NO puedes agregar</strong> estudiantes
                                                manualmente - Se inscriben autom√°ticamente desde el
                                                portal</li>
                                            <li><strong>‚úÖ S√ç puedes remover:</strong> Haz clic en la
                                                "X" junto al nombre del estudiante para liberar cupo</li>
                                            <li><strong>‚úÖ S√ç puedes ajustar:</strong> Modifica
                                                "Capacidad M√°xima" arriba para controlar
                                                disponibilidad total</li>
                                        </ul>
                                    </div>
                                    <div class="alert alert-info mt-3" role="alert"
                                        groups="!benglish_academy.group_academic_coordinator,!benglish_academy.group_academic_manager">
                                        <i class="fa fa-info-circle" /> Los estudiantes se inscriben
                                        autom√°ticamente desde el portal estudiantil. </div>
                                </group>
                            </page>
                            <page string="Notas" priority="2">
                                <field name="notes" placeholder="Observaciones de la sesi√≥n" />
                            </page>
                            <page string="üîÑ Historial de Reemplazos" name="replacement_history"
                                invisible="not original_teacher_id"
                                priority="3">
                                <group>
                                    <group string="√öltimo Reemplazo">
                                        <field name="original_teacher_id" readonly="1" />
                                        <field name="replacement_reason" readonly="1" />
                                    </group>
                                    <group>
                                        <field name="replaced_at" readonly="1" />
                                        <field name="replaced_by_id" readonly="1" />
                                        <field name="replacement_count" readonly="1" />
                                    </group>
                                </group>
                                <group string="Historial de Reemplazos">
                                    <group>
                                        <field name="replacement_count" readonly="1" />
                                        <button
                                            name="%(benglish_academy.action_teacher_replacement_log)d"
                                            type="action"
                                            string="Ver Historial"
                                            class="oe_stat_button"
                                            context="{}" />
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter />
                </form>
            </field>
        </record>


        <!-- Calendario              -->
        <record id="view_class_session_calendar" model="ir.ui.view">
            <field name="name">benglish.class.session.calendar</field>
            <field name="model">benglish.class.session</field>
            <field name="arch" type="xml">
                <calendar string="Horario de clases"
                    date_start="start_datetime"
                    date_stop="end_datetime"
                    color="subject_id">
                    <field name="name" />
                    <field name="subject_id" />
                    <field name="campus_id" />
                    <field name="teacher_id" />
                    <field name="state" />
                    <field name="delivery_mode" widget="badge"
                        decoration-success="delivery_mode == 'presential'"
                        decoration-info="delivery_mode == 'virtual'"
                        decoration-warning="delivery_mode == 'hybrid'" />
                </calendar>
            </field>
        </record>

        <record id="view_class_session_tree" model="ir.ui.view">
            <field name="name">class.session.tree</field>
            <field name="model">benglish.class.session</field>
            <field name="arch" type="xml">
                <list string="Clases" default_order="start_datetime" create="false">
                    <field name="teacher_id" />
                    <field name="subject_id" />
                    <field name="campus_id" />
                    <field name="start_datetime" />
                    <field name="end_datetime" />
                </list>
            </field>
        </record>

        <!-- B√∫squeda                 -->
        <record id="view_class_session_search" model="ir.ui.view">
            <field name="name">benglish.class.session.search</field>
            <field name="model">benglish.class.session</field>
            <field name="arch" type="xml">
                <search string="Buscar clases">
                    <field name="subject_id" />
                    <field name="campus_id" />
                    <field name="teacher_id" />
                    <field name="session_type" />
                    <field name="delivery_mode" />
                    <separator />
                    <filter string="Programadas" name="planned" domain="[('state', '=', 'planned')]" />
                    <filter string="En curso" name="in_progress"
                        domain="[('state', '=', 'in_progress')]" />
                    <filter string="Dictadas" name="done" domain="[('state', '=', 'done')]" />
                    <filter string="Canceladas" name="cancelled"
                        domain="[('state', '=', 'cancelled')]" />
                    <separator />
                    <filter string="üìç Presencial" name="presential"
                        domain="[('delivery_mode', '=', 'presential')]"
                        help="Solo clases presenciales" />
                    <filter string="üíª Virtual" name="virtual"
                        domain="[('delivery_mode', '=', 'virtual')]"
                        help="Solo clases virtuales" />
                    <filter string="üîÄ H√≠brida" name="hybrid"
                        domain="[('delivery_mode', '=', 'hybrid')]"
                        help="Solo clases h√≠bridas" />
                    <separator />
                    <filter string="‚úÖ Publicadas" name="published"
                        domain="[('is_published', '=', True)]"
                        help="Clases visibles en portales" />
                    <filter string="üö´ No Publicadas" name="not_published"
                        domain="[('is_published', '=', False)]"
                        help="Clases no visibles en portales" />
                    <separator />
                    <filter string="‚ö†Ô∏è Clase Llena" name="full_capacity"
                        domain="[('is_full', '=', True)]"
                        help="Clases que alcanzaron el cupo m√°ximo" />
                    <filter string="‚úì Con Cupos Disponibles" name="has_spots"
                        domain="[('is_full', '=', False)]"
                        help="Clases con cupos disponibles" />
                    <filter string="üî• Alta Ocupaci√≥n (&gt;80%)" name="high_occupancy"
                        domain="[('occupancy_rate', '&gt;', 80)]"
                        help="Clases con m√°s del 80% de ocupaci√≥n" />
                    <separator />
                    <filter string="üìÖ Hoy" name="today"
                        domain="[('date', '=', context_today())]"
                        help="Clases programadas para hoy" />
                    <filter string="üìÖ Pr√≥ximos 7 D√≠as" name="next_7_days"
                        domain="[('date', '&gt;=', context_today()), ('date', '&lt;=', (context_today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"
                        help="Clases de los pr√≥ximos 7 d√≠as" />
                    <filter string="üìÖ Pr√≥ximos 30 D√≠as" name="next_30_days"
                        domain="[('date', '&gt;=', context_today()), ('date', '&lt;=', (context_today() + datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"
                        help="Clases de los pr√≥ximos 30 d√≠as" />
                    <group expand="0" string="Agrupar por">
                        <filter string="Modalidad" name="group_by_delivery_mode"
                            context="{'group_by': 'delivery_mode'}"
                            help="Agrupar por modalidad (Presencial/Virtual/H√≠brida)" />
                        <filter string="Sede" name="group_by_campus"
                            context="{'group_by': 'campus_id'}" />
                        <filter string="Asignatura" name="group_by_subject"
                            context="{'group_by': 'subject_id'}" />
                        <filter string="Docente" name="group_by_teacher"
                            context="{'group_by': 'teacher_id'}" />
                        <filter string="Estado" name="group_by_state"
                            context="{'group_by': 'state'}" />
                        <filter string="Fecha" name="group_by_date"
                            context="{'group_by': 'date'}" />
                    </group>
                </search>
            </field>
        </record>

        <!-- Acci√≥n y men√∫           -->
        <record id="action_class_session" model="ir.actions.act_window">
            <field name="name">Clases</field>
            <field name="res_model">benglish.class.session</field>
            <field name="view_mode">calendar,list,form</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Programar la primera clase
                </p>
                <p>
                    Utiliza esta vista para controlar horarios por sede, grupo y docente.
                </p>
            </field>
        </record>

        <record id="action_agend_session" model="ir.actions.act_window">
            <field name="name">Horario Semanal</field>
            <field name="res_model">benglish.class.session</field>
            <field name="view_mode">list,calendar</field>
            <field name="view_id" ref="view_class_session_tree" />
        </record>

        <!-- Acciones para Horarios Separados por Modalidad -->
        <record id="action_agenda_presential" model="ir.actions.act_window">
            <field name="name">üìç Horario Presencial</field>
            <field name="res_model">benglish.class.session</field>
            <field name="view_mode">calendar,list,form</field>
            <field name="domain">[('delivery_mode', '=', 'presential')]</field>
            <field name="context">{'search_default_presential': 1, 'default_delivery_mode':
                'presential'}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay clases presenciales programadas
                </p>
                <p>
                    Esta vista muestra √∫nicamente las clases de modalidad presencial.
                    Crea una nueva clase presencial para comenzar.
                </p>
            </field>
        </record>

        <record id="action_agenda_virtual" model="ir.actions.act_window">
            <field name="name">üíª Horario Virtual</field>
            <field name="res_model">benglish.class.session</field>
            <field name="view_mode">calendar,list,form</field>
            <field name="domain">[('delivery_mode', '=', 'virtual')]</field>
            <field name="context">{'search_default_virtual': 1, 'default_delivery_mode': 'virtual'}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay clases virtuales programadas
                </p>
                <p>
                    Esta vista muestra √∫nicamente las clases de modalidad virtual.
                    Crea una nueva clase virtual para comenzar.
                </p>
            </field>
        </record>

        <record id="action_agenda_hybrid" model="ir.actions.act_window">
            <field name="name">üîÄ Horario H√≠brido (Integrado)</field>
            <field name="res_model">benglish.class.session</field>
            <field name="view_mode">calendar,list,form</field>
            <field name="domain">[('delivery_mode', 'in', ['hybrid', 'presential', 'virtual'])]</field>
            <field name="context">{'default_delivery_mode': 'hybrid'}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay clases programadas
                </p>
                <p>
                    Esta vista integrada muestra clases de todas las modalidades (presencial,
                    virtual e h√≠brida).
                    √ötil para tener una visi√≥n completa del horario acad√©mico.
                </p>
            </field>
        </record>

    </data>
</odoo>