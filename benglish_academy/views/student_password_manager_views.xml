<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Vista de Lista (Tree) - Gestión de Contraseñas de Estudiantes -->
    <record id="view_student_password_manager_tree" model="ir.ui.view">
        <field name="name">benglish.student.password.manager.tree</field>
        <field name="model">benglish.student.password.manager</field>
        <field name="arch" type="xml">
            <list string="Gestión de Contraseñas de Estudiantes" 
                  create="false" 
                  delete="false"
                  editable="bottom"
                  decoration-muted="not has_portal_user">
                <field name="student_code" string="Código" optional="show" readonly="1"/>
                <field name="student_name" string="Nombre Completo" readonly="1"/>
                <field name="student_email" string="Email" optional="show" readonly="1"/>
                <field name="student_documento" string="Documento" optional="show" readonly="1"/>
                <field name="portal_login" string="Usuario/Login" optional="show" readonly="1"/>
                <field name="new_password" string="Nueva Contraseña" 
                       placeholder="Ingrese nueva contraseña..."
                       password="False"
                       optional="show"
                       invisible="not has_portal_user"/>
                <field name="has_portal_user" string="Tiene Usuario" 
                       widget="boolean_toggle" optional="hide" readonly="1"/>
                <field name="user_active" string="Activo" 
                       widget="boolean_toggle" 
                       optional="hide"
                       readonly="1"
                       invisible="not has_portal_user"/>
                <button name="action_change_password" 
                        type="object" 
                        string="Cambiar"
                        class="btn-primary"
                        icon="fa-key"
                        invisible="not has_portal_user or not new_password"/>
                <button name="action_reset_password_to_document" 
                        type="object" 
                        string="Resetear"
                        class="btn-warning"
                        icon="fa-refresh"
                        invisible="not has_portal_user or not student_documento"
                        confirm="¿Restablecer contraseña al documento?"/>
                <button name="action_create_portal_user" 
                        type="object" 
                        string="Crear Usuario"
                        class="btn-success"
                        icon="fa-user-plus"
                        invisible="has_portal_user"/>
                <field name="user_id" column_invisible="1"/>
                <field name="student_id" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- Vista de Formulario - Gestión de Contraseñas -->
    <record id="view_student_password_manager_form" model="ir.ui.view">
        <field name="name">benglish.student.password.manager.form</field>
        <field name="model">benglish.student.password.manager</field>
        <field name="arch" type="xml">
            <form string="Gestión de Contraseña de Estudiante" create="false" delete="false">
                <header>
                    <button name="action_change_password" 
                            type="object" 
                            string="Cambiar Contraseña"
                            class="oe_highlight"
                            invisible="not has_portal_user or not new_password"
                            confirm="¿Está seguro que desea cambiar la contraseña de este estudiante?"/>
                    <button name="action_reset_password_to_document" 
                            type="object" 
                            string="Restablecer a Documento"
                            class="btn-warning"
                            invisible="not has_portal_user or not student_documento"
                            confirm="¿Está seguro que desea restablecer la contraseña al número de documento?"/>
                    <button name="action_create_portal_user" 
                            type="object" 
                            string="Crear Usuario Portal"
                            class="oe_highlight"
                            invisible="has_portal_user"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="%(action_student)d" 
                                type="action" 
                                class="oe_stat_button" 
                                icon="fa-user"
                                context="{'search_default_id': student_id}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver</span>
                                <span class="o_stat_text">Estudiante</span>
                            </div>
                        </button>
                    </div>

                    <widget name="web_ribbon" 
                            title="Sin Usuario Portal" 
                            bg_color="text-bg-danger" 
                            invisible="has_portal_user"/>
                    <widget name="web_ribbon" 
                            title="Usuario Inactivo" 
                            bg_color="text-bg-warning" 
                            invisible="not has_portal_user or user_active"/>

                    <group name="student_info" string="Información del Estudiante">
                        <group name="student_basic">
                            <field name="student_id" readonly="1" options="{'no_create': True}"/>
                            <field name="student_code" readonly="1"/>
                            <field name="student_name" readonly="1"/>
                            <field name="student_email" readonly="1"/>
                            <field name="student_documento" readonly="1"/>
                        </group>
                        <group name="portal_info">
                            <field name="has_portal_user" readonly="1" widget="boolean"/>
                            <field name="user_id" readonly="1" invisible="not has_portal_user"/>
                            <field name="portal_login" readonly="1" invisible="not has_portal_user"/>
                            <field name="user_active" readonly="1" widget="boolean" invisible="not has_portal_user"/>
                        </group>
                    </group>

                    <group name="password_management" 
                           string="Gestión de Contraseña" 
                           invisible="not has_portal_user">
                        <group name="password_info">
                            <field name="current_password" 
                                   password="True" 
                                   readonly="1"
                                   help="La contraseña actual está encriptada y no puede ser mostrada"/>
                        </group>
                        <group name="password_change">
                            <field name="new_password" 
                                   password="False"
                                   placeholder="Ingrese la nueva contraseña..."
                                   help="Ingrese la nueva contraseña para el estudiante (mínimo 4 caracteres)"/>
                        </group>
                    </group>

                    <group name="instructions" invisible="not has_portal_user">
                        <group>
                            <div class="alert alert-info" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fa fa-info-circle"/> Instrucciones
                                </h4>
                                <ul>
                                    <li>Ingrese la nueva contraseña en el campo "Nueva Contraseña"</li>
                                    <li>Haga clic en "Cambiar Contraseña" para aplicar los cambios</li>
                                    <li>Use "Restablecer a Documento" para usar el número de documento como contraseña</li>
                                    <li>La contraseña debe tener al menos 4 caracteres</li>
                                </ul>
                            </div>
                        </group>
                    </group>

                    <group name="create_user_info" invisible="has_portal_user">
                        <group>
                            <div class="alert alert-warning" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fa fa-exclamation-triangle"/> Usuario Portal No Creado
                                </h4>
                                <p>Este estudiante aún no tiene un usuario portal creado.</p>
                                <p>Haga clic en el botón "Crear Usuario Portal" en la parte superior para crear uno.</p>
                            </div>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de Búsqueda (Search) -->
    <record id="view_student_password_manager_search" model="ir.ui.view">
        <field name="name">benglish.student.password.manager.search</field>
        <field name="model">benglish.student.password.manager</field>
        <field name="arch" type="xml">
            <search string="Buscar Estudiantes">
                <field name="student_name" string="Nombre" 
                       filter_domain="['|', ('student_name', 'ilike', self), ('student_code', 'ilike', self)]"/>
                <field name="student_code" string="Código"/>
                <field name="student_email" string="Email"/>
                <field name="student_documento" string="Documento"/>
                <field name="portal_login" string="Usuario/Login"/>
                
                <filter string="Con Usuario Portal" 
                        name="filter_has_portal" 
                        domain="[('has_portal_user', '=', True)]"/>
                <filter string="Sin Usuario Portal" 
                        name="filter_no_portal" 
                        domain="[('has_portal_user', '=', False)]"/>
                <filter string="Usuarios Activos" 
                        name="filter_active_users" 
                        domain="[('user_active', '=', True)]"/>
                <filter string="Usuarios Inactivos" 
                        name="filter_inactive_users" 
                        domain="[('user_active', '=', False), ('has_portal_user', '=', True)]"/>
                
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter string="Estado Usuario" 
                            name="group_by_portal_status" 
                            context="{'group_by': 'has_portal_user'}"/>
                    <filter string="Estado Activo" 
                            name="group_by_active" 
                            context="{'group_by': 'user_active'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción de Ventana -->
    <record id="action_student_password_manager" model="ir.actions.act_window">
        <field name="name">Gestión de Contraseñas de Estudiantes</field>
        <field name="res_model">benglish.student.password.manager</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_filter_has_portal': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay registros de gestión de contraseñas
            </p>
            <p>
                Este módulo le permite gestionar las contraseñas de acceso al portal de todos los estudiantes.
                Los registros se crean automáticamente cuando los estudiantes tienen usuarios portal.
            </p>
        </field>
    </record>

</odoo>
