<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- HU-CRM-03/04: Automated actions para transiciones de pipelines -->

        <!-- Transición 1: Marketing (Aprobado) → Comercial (En evaluación) -->
        <record id="ir_cron_marketing_to_commercial" model="ir.actions.server">
            <field name="name">CRM: Transición Marketing → Comercial (Aprobado)</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-03: Transición automática de Marketing a Comercial
commercial_team = env['crm.team'].search([('name', '=', 'Pipeline Comercial')], limit=1)

if commercial_team:
    stage_evaluacion = env['crm.stage'].search([
        ('name', '=', 'En evaluación'),
        ('team_id', '=', commercial_team.id)
    ], limit=1)
    
    if stage_evaluacion:
        asesores = env['hr.employee'].search([
            ('commercial_role', '=', 'asesor'),
            ('active', '=', True)
        ])
        
        for lead in records:
            vals = {
                'team_id': commercial_team.id,
                'stage_id': stage_evaluacion.id,
                'type': 'opportunity'
            }
            
            # Asignación round-robin si hay asesores disponibles
            if asesores:
                thirty_days_ago = fields.Date.today() - datetime.timedelta(days=30)
                asesor_counts = {}
                for asesor in asesores:
                    if asesor.user_id:
                        count = env['crm.lead'].search_count([
                            ('user_id', '=', asesor.user_id.id),
                            ('create_date', '>=', thirty_days_ago)
                        ])
                        asesor_counts[asesor.id] = count
                
                if asesor_counts:
                    min_asesor_id = min(asesor_counts, key=asesor_counts.get)
                    min_asesor = asesores.filtered(lambda e: e.id == min_asesor_id)
                    if min_asesor and min_asesor.user_id:
                        vals['user_id'] = min_asesor.user_id.id
            
            lead.write(vals)
            
            lead.message_post(
                body='<p><b>Transición automática:</b></p><ul><li>Pipeline: Marketing → Comercial</li><li>Etapa: Aprobado → En evaluación</li><li>Responsable asignado: %s</li></ul>' % (lead.user_id.name if lead.user_id else 'Sin asignar'),
                message_type='notification',
                subtype_xmlid='mail.mt_note'
            )
]]></field>
        </record>

        <record id="automated_action_marketing_to_commercial" model="base.automation">
            <field name="name">CRM: Transición Marketing → Comercial (Aprobado)</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('stage_id.name', '=', 'Aprobado')]</field>
            <field name="action_server_ids"
                eval="[(6, 0, [ref('ir_cron_marketing_to_commercial')])]" />
        </record>

        <!-- Transición 2: Validación en Pipeline Comercial (Convertir a oportunidad si no lo es) -->
        <record id="ir_cron_commercial_pipeline_validation" model="ir.actions.server">
            <field name="name">CRM: Validación Pipeline Comercial</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-04: Validación de tipo en pipeline comercial
commercial_team = env['crm.team'].search([('name', '=', 'Pipeline Comercial')], limit=1)

if commercial_team:
    for lead in records:
        if lead.team_id.id == commercial_team.id and lead.type != 'opportunity':
            lead.write({'type': 'opportunity'})
            lead.message_post(
                body='<p>Lead convertido automáticamente a Oportunidad al ingresar al Pipeline Comercial.</p>',
                message_type='notification',
                subtype_xmlid='mail.mt_note'
            )
]]></field>
        </record>

        <record id="automated_action_commercial_pipeline_validation" model="base.automation">
            <field name="name">CRM: Validación Pipeline Comercial</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('team_id.name', '=', 'Pipeline Comercial'), ('type', '=',
                'lead')]</field>
            <field name="action_server_ids"
                eval="[(6, 0, [ref('ir_cron_commercial_pipeline_validation')])]" />
        </record>

        <!-- Transición 3: Comercial (Matriculado) → Cerrar oportunidad como ganada -->
        <record id="ir_cron_lead_enrolled" model="ir.actions.server">
            <field name="name">CRM: Lead Matriculado → Ganado</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-04: Marcar oportunidad como ganada al matricular
for lead in records:
    if not lead.active or lead.probability == 100:
        continue  # Ya está cerrada como ganada
    
    # Marcar como ganada
    lead.action_set_won()
    
    # Mensaje en chatter
    lead.message_post(
        body='<p><b>¡Oportunidad ganada!</b></p><p>Lead matriculado exitosamente. La oportunidad se ha marcado como <b>Ganada</b>.</p>',
        message_type='notification',
        subtype_xmlid='mail.mt_note'
    )
]]></field>
        </record>

        <record id="automated_action_lead_enrolled" model="base.automation">
            <field name="name">CRM: Lead Matriculado → Ganado</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('stage_id.name', '=', 'Matriculado'), ('active', '=',
                True)]</field>
            <field name="action_server_ids" eval="[(6, 0, [ref('ir_cron_lead_enrolled')])]" />
        </record>

        <!-- Transición 4: Comercial (Rechazado) → Volver a Marketing -->
        <record id="ir_cron_lead_rejected_commercial" model="ir.actions.server">
            <field name="name">CRM: Lead Rechazado → Volver a Marketing</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-04: Retornar lead rechazado a pipeline de marketing
marketing_team = env['crm.team'].search([('name', '=', 'Pipeline Marketing')], limit=1)

if marketing_team:
    # Buscar etapa "Volver a llamar" en Marketing
    stage_volver_llamar = env['crm.stage'].search([
        ('name', '=', 'Volver a llamar'),
        ('team_id', '=', marketing_team.id)
    ], limit=1)
    
    if not stage_volver_llamar:
        # Si no existe, usar la primera etapa del pipeline Marketing
        stage_volver_llamar = env['crm.stage'].search([
            ('team_id', '=', marketing_team.id)
        ], limit=1, order='sequence asc')
    
    for lead in records:
        # Retornar a pipeline Marketing
        vals = {
            'team_id': marketing_team.id,
            'type': 'lead'
        }
        
        if stage_volver_llamar:
            vals['stage_id'] = stage_volver_llamar.id
        
        lead.write(vals)
        
        # Mensaje en chatter
        lead.message_post(
            body='<p><b>Lead devuelto a Marketing</b></p><p>El lead fue rechazado en el pipeline comercial y ha sido devuelto a Marketing para seguimiento.</p>',
            message_type='notification',
            subtype_xmlid='mail.mt_note'
        )
]]></field>
        </record>

        <record id="automated_action_lead_rejected_commercial" model="base.automation">
            <field name="name">CRM: Lead Rechazado → Volver a Marketing</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('stage_id.name', '=', 'Rechazado'), ('team_id.name', '=',
                'Pipeline Comercial')]</field>
            <field name="action_server_ids"
                eval="[(6, 0, [ref('ir_cron_lead_rejected_commercial')])]" />
        </record>

    </data>
</odoo>