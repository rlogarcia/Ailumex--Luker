<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Acción de Servidor: Inicializar Gestor de Contraseñas -->
    <record id="action_init_password_manager" model="ir.actions.server">
        <field name="name">Inicializar Gestor de Contraseñas</field>
        <field name="model_id" ref="model_benglish_student"/>
        <field name="state">code</field>
        <field name="code">
# Inicializar el gestor de contraseñas para todos los estudiantes con usuario portal
password_manager_model = env['benglish.student.password.manager']

# Buscar todos los estudiantes que tienen usuario portal
students_with_portal = env['benglish.student'].search([
    ('user_id', '!=', False)
])

created_count = 0
existing_count = 0

for student in students_with_portal:
    existing = password_manager_model.search([
        ('student_id', '=', student.id)
    ], limit=1)
    
    if not existing:
        password_manager_model.create({
            'student_id': student.id,
        })
        created_count += 1
    else:
        existing_count += 1

# Mostrar notificación con el resultado
action = {
    'type': 'ir.actions.client',
    'tag': 'display_notification',
    'params': {
        'title': 'Inicialización Completada',
        'message': f'Registros creados: {created_count}, Registros existentes: {existing_count}',
        'type': 'success' if created_count > 0 else 'info',
        'sticky': False,
    }
}
        </field>
    </record>

    <!-- Acción de Servidor: Sincronizar Gestor de Contraseñas desde Estudiantes -->
    <record id="action_sync_students_to_password_manager" model="ir.actions.server">
        <field name="name">Sincronizar a Gestor de Contraseñas</field>
        <field name="model_id" ref="model_benglish_student"/>
        <field name="binding_model_id" ref="model_benglish_student"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
# Sincronizar estudiantes seleccionados con el gestor de contraseñas
password_manager = env['benglish.student.password.manager']
count = 0

for student in records.filtered(lambda s: s.user_id):
    password_manager.get_or_create_for_student(student.id)
    count += 1

if count > 0:
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Sincronización Completada',
            'message': f'{count} estudiante(s) sincronizado(s) con el gestor de contraseñas',
            'type': 'success',
            'sticky': False,
        }
    }
else:
    action = {
        'type': 'ir.actions.client',
        'tag': 'display_notification',
        'params': {
            'title': 'Sin Cambios',
            'message': 'No se encontraron estudiantes con usuario portal para sincronizar',
            'type': 'info',
            'sticky': False,
        }
    }
        </field>
    </record>
</odoo>
