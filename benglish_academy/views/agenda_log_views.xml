<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- =============================================== -->
    <!-- VISTAS PARA HISTORIAL DE CAMBIOS DE AGENDA -->
    <!-- =============================================== -->

    <!-- Vista Tree (Lista) de Logs -->
    <record id="view_agenda_log_tree" model="ir.ui.view">
        <field name="name">benglish.agenda.log.tree</field>
        <field name="model">benglish.agenda.log</field>
        <field name="arch" type="xml">
            <list string="Historial de Cambios"
                default_order="date desc"
                create="false"
                edit="false"
                delete="false"
                decoration-info="action == 'create'"
                decoration-danger="action == 'delete'"
                decoration-warning="action in ['update', 'move']">

                <field name="date" string="Fecha y Hora" widget="datetime" />
                <field name="action" string="Acción" widget="badge"
                    decoration-info="action == 'create'"
                    decoration-danger="action == 'delete'"
                    decoration-warning="action == 'update'"
                    decoration-success="action == 'move'" />
                <field name="session_date" string="Fecha Sesión" />
                <field name="session_subject" string="Asignatura" />
                <field name="session_teacher" string="Docente" />
                <field name="user_id" string="Usuario" widget="many2one_avatar_user" />
                <field name="message" string="Descripción" />

            </list>
        </field>
    </record>

    <!-- Vista Form de Logs (solo lectura) -->
    <record id="view_agenda_log_form" model="ir.ui.view">
        <field name="name">benglish.agenda.log.form</field>
        <field name="model">benglish.agenda.log</field>
        <field name="arch" type="xml">
            <form string="Detalle del Cambio" create="false" edit="false" delete="false">
                <sheet>

                    <!-- Badge con tipo de acción -->
                    <widget name="web_ribbon"
                        title="Creación"
                        bg_color="bg-info"
                        invisible="action != 'create'" />
                    <widget name="web_ribbon"
                        title="Eliminación"
                        bg_color="bg-danger"
                        invisible="action != 'delete'" />
                    <widget name="web_ribbon"
                        title="Modificación"
                        bg_color="bg-warning"
                        invisible="action != 'update'" />
                    <widget name="web_ribbon"
                        title="Reprogramación"
                        bg_color="bg-success"
                        invisible="action != 'move'" />

                    <group>
                        <group name="main_info" string="Información Principal">
                            <field name="name" readonly="1" />
                            <field name="date" widget="datetime" readonly="1" />
                            <field name="user_id" widget="many2one_avatar_user" readonly="1" />
                            <field name="action" readonly="1" />
                        </group>
                        <group name="session_info" string="Información de la Sesión">
                            <field name="agenda_id" readonly="1" />
                            <field name="session_id" readonly="1" />
                            <field name="session_date" readonly="1" />
                            <field name="session_subject" readonly="1" />
                            <field name="session_teacher" readonly="1" />
                        </group>
                    </group>

                    <notebook>
                        <page string="Descripción del Cambio" name="message">
                            <field name="message" readonly="1" nolabel="1" widget="text" />
                        </page>
                        <page string="Valores Anteriores" name="old_values"
                            invisible="not old_values">
                            <field name="old_values" readonly="1" nolabel="1" widget="text" />
                        </page>
                        <page string="Valores Nuevos" name="new_values" invisible="not new_values">
                            <field name="new_values" readonly="1" nolabel="1" widget="text" />
                        </page>
                    </notebook>

                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista Search para filtros -->
    <record id="view_agenda_log_search" model="ir.ui.view">
        <field name="name">benglish.agenda.log.search</field>
        <field name="model">benglish.agenda.log</field>
        <field name="arch" type="xml">
            <search string="Buscar en Historial">
                <field name="agenda_id" string="Horario" />
                <field name="user_id" string="Usuario" />
                <field name="session_subject" string="Asignatura" />
                <field name="session_teacher" string="Docente" />
                <field name="message" string="Descripción" />

                <separator />
                <filter string="Creaciones" name="filter_create"
                    domain="[('action', '=', 'create')]" />
                <filter string="Eliminaciones" name="filter_delete"
                    domain="[('action', '=', 'delete')]" />
                <filter string="Modificaciones" name="filter_update"
                    domain="[('action', '=', 'update')]" />
                <filter string="Reprogramaciones" name="filter_move"
                    domain="[('action', '=', 'move')]" />

                <separator />
                <filter string="Hoy" name="filter_today"
                    domain="[('date', '&gt;=', datetime.datetime.now().replace(hour=0, minute=0, second=0)),
                                 ('date', '&lt;=', datetime.datetime.now().replace(hour=23, minute=59, second=59))]" />
                <filter string="Esta Semana" name="filter_week"
                    domain="[('date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]" />
                <filter string="Este Mes" name="filter_month"
                    domain="[('date', '&gt;=', (context_today().replace(day=1)).strftime('%Y-%m-%d'))]" />

                <group expand="0" string="Agrupar Por">
                    <filter string="Acción" name="group_action" context="{'group_by': 'action'}" />
                    <filter string="Usuario" name="group_user" context="{'group_by': 'user_id'}" />
                    <filter string="Horario" name="group_agenda" context="{'group_by': 'agenda_id'}" />
                    <filter string="Fecha" name="group_date" context="{'group_by': 'date:day'}" />
                </group>
            </search>
        </field>
    </record>

    <!-- Acción de Ventana para Logs -->
    <record id="action_agenda_log" model="ir.actions.act_window">
        <field name="name">Historial de Cambios de Horario</field>
        <field name="res_model">benglish.agenda.log</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'create': False}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_empty_folder">
                No hay registros en el historial
            </p>
            <p>
                El historial de cambios registra automáticamente todas las creaciones,
                modificaciones y eliminaciones de sesiones en los horarios académicos.
            </p>
        </field>
    </record>

    <!-- Opcional: Menú para acceder a todos los logs (si se desea) -->
    <!--
    <menuitem id="menu_agenda_log"
              name="Historial de Cambios"
              parent="menu_academic_agenda_root"
              action="action_agenda_log"
              sequence="50"/>
    -->

</odoo>