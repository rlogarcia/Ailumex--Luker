<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Vista de Lista (Tree) - Gestión de Contraseñas de Docentes -->
    <record id="view_teacher_password_manager_tree" model="ir.ui.view">
        <field name="name">benglish.teacher.password.manager.tree</field>
        <field name="model">benglish.teacher.password.manager</field>
        <field name="arch" type="xml">
            <list string="Gestión de Contraseñas de Docentes" 
                  create="false" 
                  delete="false"
                  editable="bottom"
                  decoration-muted="not has_portal_user">
                <field name="teacher_name" string="Nombre Completo" readonly="1"/>
                <field name="teacher_email" string="Email" optional="show" readonly="1"/>
                <field name="partner_vat" string="Número Identificación" optional="show" readonly="1"/>
                <field name="portal_login" string="Usuario/Login" optional="show" readonly="1"/>
                <field name="new_password" string="Nueva Contraseña" 
                       placeholder="Ingrese nueva contraseña..."
                       password="False"
                       optional="show"
                       invisible="not has_portal_user"/>
                <field name="has_portal_user" string="Tiene Usuario" 
                       widget="boolean_toggle" optional="hide" readonly="1"/>
                <field name="user_active" string="Activo" 
                       widget="boolean_toggle" 
                       optional="hide"
                       readonly="1"
                       invisible="not has_portal_user"/>
                <button name="action_change_password" 
                        type="object" 
                        string="Cambiar"
                        class="btn-primary"
                        icon="fa-key"
                        invisible="not has_portal_user or not new_password"/>
                <button name="action_reset_to_document" 
                        type="object" 
                        string="Resetear"
                        class="btn-warning"
                        icon="fa-refresh"
                        invisible="not has_portal_user or not partner_vat"
                        confirm="¿Restablecer contraseña al número de identificación?"/>
                <button name="action_toggle_user_active" 
                        type="object" 
                        string="Activar/Desactivar"
                        class="btn-secondary"
                        icon="fa-power-off"
                        invisible="not has_portal_user"
                        confirm="¿Cambiar el estado del usuario?"/>
                <field name="user_id" column_invisible="1"/>
                <field name="employee_id" column_invisible="1"/>
                <field name="partner_id" column_invisible="1"/>
            </list>
        </field>
    </record>

    <!-- Vista de Formulario - Gestión de Contraseñas -->
    <record id="view_teacher_password_manager_form" model="ir.ui.view">
        <field name="name">benglish.teacher.password.manager.form</field>
        <field name="model">benglish.teacher.password.manager</field>
        <field name="arch" type="xml">
            <form string="Gestión de Contraseña de Docente" create="false" delete="false">
                <header>
                    <button name="action_change_password" 
                            type="object" 
                            string="Cambiar Contraseña"
                            class="oe_highlight"
                            invisible="not has_portal_user or not new_password"
                            confirm="¿Está seguro que desea cambiar la contraseña de este docente?"/>
                    <button name="action_reset_to_document" 
                            type="object" 
                            string="Restablecer a Número de Identificación"
                            class="btn-warning"
                            invisible="not has_portal_user or not partner_vat"
                            confirm="¿Está seguro que desea restablecer la contraseña al número de identificación?"/>
                    <button name="action_toggle_user_active" 
                            type="object" 
                            string="Activar/Desactivar Usuario"
                            invisible="not has_portal_user"
                            confirm="¿Está seguro que desea cambiar el estado del usuario?"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="%(hr.open_view_employee_list_my)d" 
                                type="action" 
                                class="oe_stat_button" 
                                icon="fa-user"
                                context="{'search_default_id': employee_id}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver</span>
                                <span class="o_stat_text">Empleado</span>
                            </div>
                        </button>
                    </div>

                    <widget name="web_ribbon" 
                            title="Sin Usuario Portal" 
                            bg_color="text-bg-danger" 
                            invisible="has_portal_user"/>
                    <widget name="web_ribbon" 
                            title="Usuario Inactivo" 
                            bg_color="text-bg-warning" 
                            invisible="not has_portal_user or user_active"/>

                    <group name="teacher_info" string="Información del Docente">
                        <group name="teacher_basic">
                            <field name="employee_id" readonly="1" options="{'no_create': True}"/>
                            <field name="teacher_name" readonly="1"/>
                            <field name="teacher_email" readonly="1"/>
                        </group>
                        <group name="teacher_contact">
                            <field name="partner_id" readonly="1"/>
                            <field name="partner_vat" readonly="1"/>
                        </group>
                    </group>

                    <group name="portal_info_group" string="Información del Usuario Portal">
                        <group name="portal_status">
                            <field name="has_portal_user" readonly="1" widget="boolean"/>
                            <field name="user_id" readonly="1" invisible="not has_portal_user"/>
                            <field name="portal_login" readonly="1" invisible="not has_portal_user"/>
                            <field name="user_active" readonly="1" widget="boolean" invisible="not has_portal_user"/>
                        </group>
                    </group>

                    <group name="password_management" 
                           string="Gestión de Contraseña" 
                           invisible="not has_portal_user">
                        <group name="password_info">
                            <field name="current_password" 
                                   password="True" 
                                   readonly="1"
                                   help="La contraseña actual está encriptada y no puede ser mostrada"/>
                        </group>
                        <group name="password_change">
                            <field name="new_password" 
                                   password="False"
                                   placeholder="Ingrese la nueva contraseña..."
                                   help="Ingrese la nueva contraseña para el docente (mínimo 4 caracteres)"/>
                        </group>
                    </group>

                    <group name="instructions" invisible="not has_portal_user">
                        <group>
                            <div class="alert alert-info" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fa fa-info-circle"/> Instrucciones
                                </h4>
                                <ul>
                                    <li>Ingrese la nueva contraseña en el campo "Nueva Contraseña"</li>
                                    <li>Haga clic en "Cambiar Contraseña" para aplicar los cambios</li>
                                    <li>Use "Restablecer a Número de Identificación" para usar el número de identificación como contraseña</li>
                                    <li>La contraseña debe tener al menos 4 caracteres</li>
                                    <li>El usuario y contraseña por defecto son el número de identificación del contacto</li>
                                </ul>
                            </div>
                        </group>
                    </group>

                    <group name="no_user_info" invisible="has_portal_user">
                        <group>
                            <div class="alert alert-warning" role="alert">
                                <h4 class="alert-heading">
                                    <i class="fa fa-exclamation-triangle"/> Usuario Portal No Creado
                                </h4>
                                <p>Este docente aún no tiene un usuario portal creado.</p>
                                <p>Para crear el usuario:</p>
                                <ol>
                                    <li>Asegúrese de que el contacto tenga un número de identificación (VAT/NIT)</li>
                                    <li>Vaya al empleado y active el checkbox "Acceso Al Portal Docente"</li>
                                    <li>El sistema creará automáticamente el usuario con el número de identificación</li>
                                </ol>
                            </div>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de Búsqueda (Search) -->
    <record id="view_teacher_password_manager_search" model="ir.ui.view">
        <field name="name">benglish.teacher.password.manager.search</field>
        <field name="model">benglish.teacher.password.manager</field>
        <field name="arch" type="xml">
            <search string="Buscar Docentes">
                <field name="teacher_name" string="Nombre" 
                       filter_domain="[('teacher_name', 'ilike', self)]"/>
                <field name="teacher_email" string="Email"/>
                <field name="partner_vat" string="Número Identificación"/>
                <field name="portal_login" string="Usuario/Login"/>
                
                <filter string="Con Usuario Portal" 
                        name="filter_has_portal" 
                        domain="[('has_portal_user', '=', True)]"/>
                <filter string="Sin Usuario Portal" 
                        name="filter_no_portal" 
                        domain="[('has_portal_user', '=', False)]"/>
                <filter string="Usuarios Activos" 
                        name="filter_active_users" 
                        domain="[('user_active', '=', True)]"/>
                <filter string="Usuarios Inactivos" 
                        name="filter_inactive_users" 
                        domain="[('user_active', '=', False), ('has_portal_user', '=', True)]"/>
                
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter string="Estado Usuario" 
                            name="group_by_portal_status" 
                            context="{'group_by': 'has_portal_user'}"/>
                    <filter string="Estado Activo" 
                            name="group_by_active_status" 
                            context="{'group_by': 'user_active'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción de Ventana - Gestión de Contraseñas de Docentes -->
    <record id="action_teacher_password_manager" model="ir.actions.act_window">
        <field name="name">Contraseñas de Docentes</field>
        <field name="res_model">benglish.teacher.password.manager</field>
        <field name="view_mode">list,form</field>
        <field name="context">{
            'search_default_filter_has_portal': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay docentes con acceso al portal
            </p>
            <p>
                Esta vista muestra todos los docentes que tienen acceso al portal.<br/>
                Desde aquí puedes gestionar sus contraseñas de acceso.
            </p>
        </field>
    </record>

    <!-- Menú - Contraseñas de Docentes -->
    <menuitem id="menu_teacher_password_manager"
              name="Contraseñas Docentes"
              parent="benglish_academy.menu_benglish_configuration"
              action="action_teacher_password_manager"
              sequence="51"/>

</odoo>
