<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">

        <!-- HU-CRM-08: Actividades automáticas para seguimiento de leads -->

        <!-- Actividad 1: Lead nuevo → Llamar inmediato -->
        <record id="ir_cron_lead_new_activity" model="ir.actions.server">
            <field name="name">CRM: Actividad - Llamar lead nuevo</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-08: Crear actividad "Llamar inmediato" para leads nuevos
activity_type = env.ref('mail.mail_activity_data_call', raise_if_not_found=False)
if activity_type:
    for lead in records:
        if lead.user_id:
            existing = env['mail.activity'].search([
                ('res_id', '=', lead.id),
                ('res_model', '=', 'crm.lead'),
                ('activity_type_id', '=', activity_type.id),
                ('user_id', '=', lead.user_id.id)
            ], limit=1)
            
            if not existing:
                env['mail.activity'].create({
                    'activity_type_id': activity_type.id,
                    'summary': 'Llamar lead nuevo inmediatamente',
                    'note': f'Nuevo lead recibido: {lead.name}<br/>Contactar de inmediato para calificación inicial.',
                    'res_id': lead.id,
                    'res_model_id': env.ref('crm.model_crm_lead').id,
                    'user_id': lead.user_id.id,
                    'date_deadline': datetime.date.today()
                })
]]></field>
        </record>

        <record id="automated_action_new_lead_activity" model="base.automation">
            <field name="name">CRM: Actividad - Llamar lead nuevo</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_create</field>
            <field name="action_server_ids" eval="[(6, 0, [ref('ir_cron_lead_new_activity')])]" />
        </record>

        <!-- Actividad 2: Evaluación programada → Recordatorio para asesor -->
        <record id="ir_cron_evaluation_scheduled" model="ir.actions.server">
            <field name="name">CRM: Actividad - Evaluación programada</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-08: Crear actividad para evaluación programada
activity_type = env.ref('mail.mail_activity_data_meeting', raise_if_not_found=False)
if activity_type:
    for lead in records:
        # Verificar si cambió la fecha de evaluación
        if lead.evaluation_date and lead.user_id:
            # Buscar actividad existente para esta evaluación
            existing = env['mail.activity'].search([
                ('res_id', '=', lead.id),
                ('res_model', '=', 'crm.lead'),
                ('summary', 'ilike', 'Evaluación programada'),
                ('user_id', '=', lead.user_id.id)
            ], limit=1)
            
            # Si existe, actualizarla; si no, crearla
            modality_label = dict(lead._fields['evaluation_modality'].selection).get(lead.evaluation_modality, 'No especificada')
            note = f'<p><b>Evaluación programada:</b> {lead.name}</p>'
            note += '<ul>'
            note += f'<li><b>Modalidad:</b> {modality_label}</li>'
            note += f'<li><b>Hora:</b> {lead.evaluation_time}</li>'
            
            if lead.evaluation_modality == 'virtual' and lead.evaluation_link:
                note += f'<li><b>Link:</b> <a href="{lead.evaluation_link}">{lead.evaluation_link}</a></li>'
            if lead.evaluation_modality == 'presencial' and lead.evaluation_address:
                note += f'<li><b>Dirección:</b> {lead.evaluation_address}</li>'
            
            note += '</ul>'
            
            activity_vals = {
                'activity_type_id': activity_type.id,
                'summary': f'Evaluación programada: {lead.name}',
                'note': note,
                'res_id': lead.id,
                'res_model_id': env.ref('crm.model_crm_lead').id,
                'user_id': lead.user_id.id,
                'date_deadline': lead.evaluation_date
            }
            
            if existing:
                existing.write(activity_vals)
            else:
                env['mail.activity'].create(activity_vals)
]]></field>
        </record>

        <record id="automated_action_evaluation_scheduled" model="base.automation">
            <field name="name">CRM: Actividad - Evaluación programada</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('evaluation_date', '!=', False), ('evaluation_time', '!=',
                False)]</field>
            <field name="action_server_ids" eval="[(6, 0, [ref('ir_cron_evaluation_scheduled')])]" />
            <field name="active" eval="True" />
        </record>

        <!-- Actividad 3: Evaluación cerrada → Seguimiento Marketing -->
        <record id="ir_cron_evaluation_closed" model="ir.actions.server">
            <field name="name">CRM: Actividad - Seguimiento post-evaluación</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-08: Crear actividad de seguimiento cuando la evaluación cierra
activity_type = env.ref('mail.mail_activity_data_todo', raise_if_not_found=False)
if activity_type:
    marketing_team = env['crm.team'].search([('name', '=', 'Marketing')], limit=1)
    
    for lead in records:
        target_user = False
        if marketing_team and marketing_team.user_id:
            target_user = marketing_team.user_id
        elif lead.create_uid:
            target_user = lead.create_uid
        
        if target_user:
            existing = env['mail.activity'].search([
                ('res_id', '=', lead.id),
                ('res_model', '=', 'crm.lead'),
                ('summary', 'ilike', 'Seguimiento post-evaluación'),
                ('user_id', '=', target_user.id)
            ], limit=1)
            
            if not existing:
                note = f'<p><b>Lead evaluado:</b> {lead.name}</p>'
                note += '<ul>'
                note += f'<li><b>Estado final:</b> {lead.stage_id.name}</li>'
                note += f'<li><b>Responsable evaluación:</b> {lead.user_id.name if lead.user_id else "Sin asignar"}</li>'
                if lead.evaluation_date:
                    note += f'<li><b>Fecha evaluación:</b> {lead.evaluation_date}</li>'
                note += '</ul>'
                note += '<p><em>Realizar seguimiento para análisis de conversión y mejora de procesos.</em></p>'
                
                env['mail.activity'].create({
                    'activity_type_id': activity_type.id,
                    'summary': f'Seguimiento post-evaluación: {lead.name}',
                    'note': note,
                    'res_id': lead.id,
                    'res_model_id': env.ref('crm.model_crm_lead').id,
                    'user_id': target_user.id,
                    'date_deadline': datetime.date.today()
                })
]]></field>
        </record>

        <record id="automated_action_evaluation_closed" model="base.automation">
            <field name="name">CRM: Actividad - Seguimiento post-evaluación</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('stage_id.name', 'in', ['Reprobado', 'Matriculado', 'Pago parcial'])]</field>
            <field name="action_server_ids" eval="[(6, 0, [ref('ir_cron_evaluation_closed')])]" />
            <field name="active" eval="True" />
        </record>

        <!-- Actividad 4: Lead Incontactable → Recordatorio de reintento -->
        <record id="ir_cron_uncontactable_lead" model="ir.actions.server">
            <field name="name">CRM: Actividad - Lead incontactable</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# HU-CRM-08: Crear actividad de reintento para leads incontactables
activity_type = env.ref('mail.mail_activity_data_call', raise_if_not_found=False)
if activity_type:
    for lead in records:
        if lead.user_id:
            existing = env['mail.activity'].search([
                ('res_id', '=', lead.id),
                ('res_model', '=', 'crm.lead'),
                ('summary', 'ilike', 'Reintentar contacto'),
                ('user_id', '=', lead.user_id.id),
                ('date_deadline', '>=', datetime.date.today())
            ], limit=1)
            
            if not existing:
                retry_date = datetime.date.today() + datetime.timedelta(days=3)
                
                env['mail.activity'].create({
                    'activity_type_id': activity_type.id,
                    'summary': f'Reintentar contacto: {lead.name}',
                    'note': f'<p>Lead marcado como incontactable.</p><p>Reintentar contacto usando medios alternativos (email, WhatsApp, SMS).</p>',
                    'res_id': lead.id,
                    'res_model_id': env.ref('crm.model_crm_lead').id,
                    'user_id': lead.user_id.id,
                    'date_deadline': retry_date
                })
]]></field>
        </record>

        <record id="automated_action_uncontactable_lead" model="base.automation">
            <field name="name">CRM: Actividad - Lead incontactable</field>
            <field name="model_id" ref="crm.model_crm_lead" />
            <field name="trigger">on_write</field>
            <field name="filter_domain">[('stage_id.name', '=', 'Incontactable')]</field>
            <field name="action_server_ids" eval="[(6, 0, [ref('ir_cron_uncontactable_lead')])]" />
        </record>

    </data>
</odoo>