<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Agregar funcionalidad de recuperación de contraseña al login del portal -->
    <template id="benglish_login_password_reset" name="Benglish Login with Password Reset" inherit_id="web.login" optional="enabled">
        
        <!-- Agregar el enlace "¿Olvidaste tu contraseña?" después del botón de ingresar -->
        <xpath expr="//button[@type='submit']" position="after">
            <div class="o-bl-forgot-password-link" style="text-align: center; margin-top: 16px;">
                <a href="#" id="forgot-password-link" class="o-bl-link-primary" style="color: #007bff; text-decoration: none;">
                    ¿Olvidaste tu contraseña?
                </a>
            </div>
        </xpath>
        
        <!-- Agregar el modal de recuperación de contraseña al final del body -->
        <xpath expr="//div[hasclass('oe_login_form')]" position="after">
            
            <!-- Modal de Recuperación de Contraseña -->
            <div id="password-reset-modal" class="benglish-modal" style="display: none;">
                <div class="benglish-modal-overlay"></div>
                <div class="benglish-modal-content">
                    
                    <!-- Header del Modal -->
                    <div class="benglish-modal-header">
                        <h3 class="benglish-modal-title">Recuperar Contraseña</h3>
                        <button type="button" class="benglish-modal-close" id="close-modal-btn" aria-label="Cerrar">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Indicador de Pasos (Stepper) -->
                    <div class="benglish-stepper">
                        <div class="benglish-step active" data-step="1">
                            <div class="benglish-step-circle">1</div>
                            <div class="benglish-step-label">Identificación</div>
                        </div>
                        <div class="benglish-step-line"></div>
                        <div class="benglish-step" data-step="2">
                            <div class="benglish-step-circle">2</div>
                            <div class="benglish-step-label">Verificación</div>
                        </div>
                        <div class="benglish-step-line"></div>
                        <div class="benglish-step" data-step="3">
                            <div class="benglish-step-circle">3</div>
                            <div class="benglish-step-label">Nueva Contraseña</div>
                        </div>
                    </div>
                    
                    <!-- Body del Modal con los 3 pasos -->
                    <div class="benglish-modal-body">
                        
                        <!-- Paso 1: Identificación -->
                        <div id="step-1" class="benglish-step-content active">
                            <p class="benglish-step-description">
                                Ingresa tu número de identificación para recibir un código de verificación en tu correo electrónico.
                            </p>
                            
                            <div class="benglish-form-group">
                                <label for="identification-number" class="benglish-label">Número de Identificación</label>
                                <input 
                                    type="text" 
                                    id="identification-number" 
                                    class="benglish-input" 
                                    placeholder="Ej: 1234567890"
                                    maxlength="20"
                                    required="required"/>
                            </div>
                            
                            <div class="benglish-alert benglish-alert-info" style="display: none;" id="email-hint">
                                <i class="fa fa-info-circle"></i>
                                <span id="email-hint-text"></span>
                            </div>
                            
                            <div class="benglish-alert benglish-alert-error" style="display: none;" id="step-1-error">
                                <i class="fa fa-exclamation-triangle"></i>
                                <span id="step-1-error-text"></span>
                            </div>
                            
                            <div class="benglish-modal-footer">
                                <button type="button" class="benglish-btn benglish-btn-secondary" id="cancel-step-1-btn">
                                    Cancelar
                                </button>
                                <button type="button" class="benglish-btn benglish-btn-primary" id="send-code-btn">
                                    <span class="btn-text">Enviar Código</span>
                                    <span class="btn-spinner" style="display: none;">
                                        <i class="fa fa-spinner fa-spin"></i> Enviando...
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 2: Verificación del OTP -->
                        <div id="step-2" class="benglish-step-content">
                            <p class="benglish-step-description">
                                Te hemos enviado un código de 6 dígitos al correo electrónico asociado a tu identificación.
                            </p>
                            
                            <div class="benglish-alert benglish-alert-success">
                                <i class="fa fa-check-circle"></i>
                                <span id="email-sent-message">Código enviado a <strong id="email-display"></strong></span>
                            </div>
                            
                            <div class="benglish-form-group">
                                <label for="otp-code" class="benglish-label">Código de Verificación</label>
                                <input 
                                    type="text" 
                                    id="otp-code" 
                                    class="benglish-input benglish-input-otp" 
                                    placeholder="000000"
                                    maxlength="6"
                                    pattern="[0-9]{6}"
                                    inputmode="numeric"
                                    required="required"
                                    autocomplete="one-time-code"/>
                                <small class="benglish-helper-text">Ingresa el código de 6 dígitos</small>
                            </div>
                            
                            <div class="benglish-alert benglish-alert-error" style="display: none;" id="step-2-error">
                                <i class="fa fa-exclamation-triangle"></i>
                                <span id="step-2-error-text"></span>
                            </div>
                            
                            <div class="benglish-resend-section">
                                <p class="benglish-resend-text">¿No recibiste el código?</p>
                                <button type="button" class="benglish-btn-link" id="resend-code-btn">
                                    Reenviar código
                                </button>
                                <span class="benglish-cooldown-text" id="cooldown-timer" style="display: none;">
                                    Podrás reenviar en <strong id="cooldown-seconds">60</strong> segundos
                                </span>
                            </div>
                            
                            <div class="benglish-modal-footer">
                                <button type="button" class="benglish-btn benglish-btn-secondary" id="back-to-step-1-btn">
                                    Atrás
                                </button>
                                <button type="button" class="benglish-btn benglish-btn-primary" id="verify-code-btn">
                                    <span class="btn-text">Validar Código</span>
                                    <span class="btn-spinner" style="display: none;">
                                        <i class="fa fa-spinner fa-spin"></i> Validando...
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso 3: Nueva Contraseña -->
                        <div id="step-3" class="benglish-step-content">
                            <p class="benglish-step-description">
                                ¡Código verificado! Ahora puedes establecer tu nueva contraseña.
                            </p>
                            
                            <div class="benglish-form-group">
                                <label for="new-password" class="benglish-label">Nueva Contraseña</label>
                                <div class="benglish-password-field">
                                    <input 
                                        type="password" 
                                        id="new-password" 
                                        class="benglish-input" 
                                        placeholder="Mínimo 6 caracteres"
                                        minlength="6"
                                        maxlength="100"
                                        required="required"
                                        autocomplete="new-password"/>
                                    <button type="button" class="benglish-password-toggle" data-target="new-password" aria-label="Mostrar contraseña">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                                <small class="benglish-helper-text">Usa al menos 6 caracteres</small>
                            </div>
                            
                            <div class="benglish-form-group">
                                <label for="confirm-password" class="benglish-label">Confirmar Contraseña</label>
                                <div class="benglish-password-field">
                                    <input 
                                        type="password" 
                                        id="confirm-password" 
                                        class="benglish-input" 
                                        placeholder="Repite tu contraseña"
                                        minlength="6"
                                        maxlength="100"
                                        required="required"
                                        autocomplete="new-password"/>
                                    <button type="button" class="benglish-password-toggle" data-target="confirm-password" aria-label="Mostrar contraseña">
                                        <i class="fa fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="benglish-password-strength" id="password-strength" style="display: none;">
                                <div class="benglish-strength-bar">
                                    <div class="benglish-strength-fill" id="strength-fill"></div>
                                </div>
                                <span class="benglish-strength-text" id="strength-text"></span>
                            </div>
                            
                            <div class="benglish-alert benglish-alert-error" style="display: none;" id="step-3-error">
                                <i class="fa fa-exclamation-triangle"></i>
                                <span id="step-3-error-text"></span>
                            </div>
                            
                            <div class="benglish-modal-footer">
                                <button type="button" class="benglish-btn benglish-btn-secondary" id="cancel-step-3-btn">
                                    Cancelar
                                </button>
                                <button type="button" class="benglish-btn benglish-btn-primary" id="update-password-btn">
                                    <span class="btn-text">Actualizar Contraseña</span>
                                    <span class="btn-spinner" style="display: none;">
                                        <i class="fa fa-spinner fa-spin"></i> Actualizando...
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Paso de Éxito -->
                        <div id="step-success" class="benglish-step-content">
                            <div class="benglish-success-message">
                                <div class="benglish-success-icon">
                                    <i class="fa fa-check-circle"></i>
                                </div>
                                <h4>¡Contraseña Actualizada!</h4>
                                <p>Tu contraseña ha sido cambiada exitosamente. Ya puedes iniciar sesión con tu nueva contraseña.</p>
                            </div>
                            
                            <div class="benglish-modal-footer">
                                <button type="button" class="benglish-btn benglish-btn-primary" id="close-success-btn" style="width: 100%;">
                                    Ir al Login
                                </button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
        </xpath>
        
        <!-- Agregar los scripts JavaScript al head -->
        <xpath expr="//head" position="inside">
            <script type="text/javascript" src="/benglish_academy/static/src/js/password_reset.js"/>
            <link rel="stylesheet" type="text/css" href="/benglish_academy/static/src/css/password_reset.css"/>
        </xpath>
        
    </template>
    
</odoo>
