<?xml version="1.0" encoding="utf-8"?>
<odoo>

<template id="portal_student_header" name="Portal Student Header">
    <t t-set="display_tz" t-value="request.env.user.tz or 'America/Bogota'"/>
    <div class="ps-navbar">
        <a class="ps-brand" href="/my/student">
            <img class="ps-logo" src="/portal_student/static/src/img/benglish_logo_nav.png" alt="Benglish" />
        </a>
            <div class="ps-nav">
                <div t-att-class="'ps-nav-item ' + ('active' if page_name == 'home' else '')">
                    <a class="ps-nav-trigger" href="/my/student">Inicio</a>
                </div>
                <div t-if="portal_access.get('capabilities', {}).get('can_schedule', True) or portal_access.get('capabilities', {}).get('can_attend', True)"
                     t-att-class="'ps-nav-item ' + ('active' if page_name in ['agenda','my_agenda'] else '')">
                <span class="ps-nav-trigger" tabindex="0">Horarios <i class="fa fa-chevron-down ps-caret" aria-hidden="true"/></span>
                <div class="ps-dropdown">
                    <a href="/my/student/agenda">Nuevo horario</a>
                    <a href="/my/student/agenda/mine">Mi horario</a>
                </div>
            </div>
            <div t-if="portal_access.get('capabilities', {}).get('can_use_apps', True)"
                 t-att-class="'ps-nav-item ' + ('active' if page_name == 'resources' else '')">
                <span class="ps-nav-trigger" tabindex="0">Recursos <i class="fa fa-chevron-down ps-caret" aria-hidden="true"/></span>
                <div class="ps-dropdown">
                    <a href="/my/student/resources">Recursos y enlaces</a>
                </div>
                </div>
            <div t-if="portal_access.get('capabilities', {}).get('can_view_history', True)"
                 t-att-class="'ps-nav-item ' + ('active' if page_name in ['program','status','academic'] else '')">
                <span class="ps-nav-trigger" tabindex="0">Programa <i class="fa fa-chevron-down ps-caret" aria-hidden="true"/></span>
                <div class="ps-dropdown">
                    <a href="/my/student/program">Programa activo</a>
                    <a href="/my/student/status">Estado (calificaciones)</a>
                    <a href="/my/student/academic">Mi estado acad√©mico</a>
                    </div>
                </div>
            <div t-if="portal_access.get('capabilities', {}).get('can_view_history', True)"
                 t-att-class="'ps-nav-item ' + ('active' if page_name == 'summary' else '')">
                <a class="ps-nav-trigger" href="/my/student/summary">Historial Acad√©mico</a>
            </div>
        </div>
        <div class="ps-user">
            <!-- Filtrar notificaciones por programa y modalidad del estudiante -->
            <t t-set="student" t-value="request.env['benglish.student'].sudo().search([('user_id','=',request.env.user.id)], limit=1)"/>
            <t t-set="student_program" t-value="student.program_id if student else False"/>
            <t t-set="student_mode" t-value="student.preferred_delivery_mode if student else 'presential'"/>
            
            <t t-set="notif_domain" t-value="[
                ('is_published', '=', True),
                ('datetime_start', '>', datetime.datetime.now()),
            ]"/>
            
            <!-- Filtrar por programa -->
            <t t-if="student_program" t-set="notif_domain" t-value="notif_domain + [('program_id', '=', student_program.id)]"/>
            
            <!-- Filtrar por modalidad con EXCEPCI√ìN para B-checks y Oral Tests (siempre virtuales) -->
            <t t-if="student_mode == 'virtual'" t-set="notif_domain" t-value="notif_domain + ['|', '|', ('delivery_mode', 'in', ['virtual', 'hybrid']), ('subject_id.subject_category', 'in', ['bcheck', 'oral_test']), ('template_id.subject_category', 'in', ['bcheck', 'oral_test'])]"/>
            <t t-elif="student_mode == 'presential'" t-set="notif_domain" t-value="notif_domain + ['|', '|', ('delivery_mode', 'in', ['presential', 'hybrid']), ('subject_id.subject_category', 'in', ['bcheck', 'oral_test']), ('template_id.subject_category', 'in', ['bcheck', 'oral_test'])]"/>
            
            <t t-set="notif_list" t-value="request.env['benglish.academic.session'].sudo().search(notif_domain, order='datetime_start asc', limit=10)"/>
            <t t-set="viewed_ids" t-value="request.env['portal.notification.view'].sudo().search([('user_id','=',request.env.user.id)]).mapped('session_id').ids"/>
            <t t-set="unseen_count" t-value="len([n for n in notif_list if n.id not in viewed_ids])"/>
            <div class="ps-notif" t-if="portal_access.get('capabilities', {}).get('can_use_apps', True)">
                <button type="button" class="ps-notif-btn" aria-label="Notificaciones">
                    <i class="fa fa-bell" aria-hidden="true"></i>
                    <span t-if="unseen_count &gt; 0" 
                          class="ps-notif-badge" 
                          t-att-data-count="unseen_count"
                          t-esc="unseen_count if unseen_count &lt; 100 else '99+'"></span>
                </button>
                <div class="ps-notif-dropdown">
                    <div class="ps-notif-head">
                        <span>Notificaciones</span>
                        <span t-if="unseen_count &gt; 0" class="ps-notif-head-badge" t-esc="unseen_count"></span>
                    </div>
                    <!-- Bot√≥n para marcar todas como le√≠das -->
                    <div t-if="unseen_count &gt; 0" class="ps-notif-actions">
                        <button type="button" class="ps-btn-mark-read" data-action="mark-all-read" onclick="if(window.psMarkNotificationsAsRead) window.psMarkNotificationsAsRead(); else alert('Sistema no inicializado. Recarga la p√°gina.');">
                            <i class="fa fa-check-circle" aria-hidden="true"></i>
                            Marcar todas como le√≠das
                        </button>
                    </div>
                    <t t-if="notif_list">
                        <t t-foreach="notif_list" t-as="n">
                            <div class="ps-notif-item" 
                                 t-att-data-session-id="n.id" 
                                 t-att-class="'ps-notif-item' + (' ps-notif-unseen' if n.id not in viewed_ids else '')">
                                <div class="ps-notif-icon">
                                    <i class="fa fa-graduation-cap" aria-hidden="true"></i>
                                </div>
                                <div class="ps-notif-content">
                                    <div class="ps-notif-title">
                                        <t t-if="n.id not in viewed_ids">
                                            <i class="fa fa-circle ps-notif-unread-dot" aria-hidden="true"></i>
                                        </t>
                                        Nueva clase publicada
                                    </div>
                                    <p class="ps-session-meta">
                                        <strong><t t-esc="n.student_alias or n.subject_id.alias or n.subject_id.name or 'Clase'"/></strong>
                                    </p>
                                    <p class="ps-session-meta ps-session-time">
                                        <i class="fa fa-calendar" aria-hidden="true"></i>
                                        <span t-field="n.datetime_start" t-options='{"widget": "datetime", "format": "dd/MM/yyyy HH:mm", "tz_name": display_tz}'/>
                                    </p>
                                    <p class="ps-notif-time">
                                        <i class="fa fa-clock-o" aria-hidden="true"></i>
                                        <span t-field="n.create_date" t-options='{"widget": "relative"}'/>
                                    </p>
                                </div>
                            </div>
                        </t>
                    </t>
                    <t t-else="">
                        <div class="ps-notif-empty">
                            <i class="fa fa-bell-slash-o" aria-hidden="true"></i>
                            <p>No hay notificaciones</p>
                        </div>
                    </t>
                </div>
            </div>
            <div class="ps-user-menu">
                <button type="button" class="ps-user-btn">
                    <span class="ps-user-name" t-esc="request.env.user.name"/>
                    <i class="fa fa-chevron-down ps-caret" aria-hidden="true"></i>
                </button>
                <div class="ps-user-dropdown">
                    <a href="/my/profile"><i class="fa fa-id-card-o"></i> Mi perfil</a>
                    <a href="/my/student/info"><i class="fa fa-user"></i> Informaci√≥n personal</a>
                    <a t-if="portal_access.get('capabilities', {}).get('can_request_freeze', True)" href="/my/student/freeze"><i class="fa fa-pause-circle"></i> Solicitar congelamiento</a>
                    <a href="/my/change-password"><i class="fa fa-lock"></i> Cambiar contrase√±a</a>
                    <a href="/my/student/data"><i class="fa fa-dashboard"></i> Datos generales</a>
                    <a href="/web/session/logout"><i class="fa fa-sign-out"></i> Cerrar sesi√≥n</a>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- Forzar que /my y el home gen√©rico del portal redirijan al portal del estudiante -->
<template id="portal_student_base" name="Portal Student Base Layout">
    <t t-call="portal.portal_layout">
        <t t-if="not page_name">
            <t t-set="page_name" t-value="'home'"/>
        </t>
        <t t-if="not portal_access">
            <t t-set="portal_access" t-value="{}"/>
            <t t-set="portal_access_message" t-value="''"/>
            <t t-set="portal_access_level" t-value="'full'"/>
        </t>
        <t t-set="display_tz" t-value="request.env.user.tz or 'America/Bogota'"/>
        <t t-call-assets="portal_student.assets_portal" position="after"/>
        <t t-call="portal_student.portal_student_header"/>

        <t t-if="portal_access_level and portal_access_level != 'full' and portal_access_message">
            <div class="ps-access-banner">
                <i class="fa fa-info-circle" aria-hidden="true"></i>
                <span t-esc="portal_access_message"/>
            </div>
        </t>

        <div class="ps-shell">
            <main class="ps-app-main ps-app-main-full">
                <t t-raw="0"/>
            </main>
        </div>
    </t>
</template>

<template id="portal_student_redirect_my" name="Portal Student Redirect My" inherit_id="portal.portal_my_home">
    <xpath expr="//div[@class='oe_structure'][@id='oe_structure_portal_my_home_1']" position="after">
        <script>
            // Solo redirigir si el usuario es un estudiante y no est√° navegando intencionalmente al portal est√°ndar
            if (window.location.pathname === '/my' || window.location.pathname === '/my/home') {
                window.location.href = '/my/student';
            }
        </script>
    </xpath>
</template>

<template id="portal_student_missing" name="Portal Student Missing">
    <t t-call="portal.portal_layout">
        <div class="ps-shell ps-empty">
            <div class="ps-card">
                <h2>Portal del Estudiante</h2>
                <p>No encontramos un estudiante asociado a tu usuario. Contacta al administrador para vincular tu cuenta.</p>
            </div>
        </div>
    </t>
</template>

<template id="portal_student_home" name="Portal Student Home">
    <t t-set="page_name" t-value="'home'"/>
    <t t-call="portal_student.portal_student_base">
        <section class="ps-welcome-card">
            <div class="ps-welcome-head">
                <div class="ps-welcome-logo">
                    <img src="/portal_student/static/src/img/benglish_logo_nav.png" alt="Benglish"/>
                </div>
                <div>
                    <p class="ps-eyebrow">Portal del estudiante</p>
                    <h1 class="ps-welcome-name" t-esc="student.name"/>
                    <p class="ps-subtitle">
                        <span t-if="student.code">C√≥digo: <t t-esc="student.code"/></span>
                        <span t-if="student.email"> | <t t-esc="student.email"/></span>
                    </p>
                </div>
            </div>
            <div class="ps-welcome-message">
                <h3>Bienvenido a B English</h3>
                <p>
                    Aqu√≠ encuentras tu portal de estudiante: horarios, recursos y tu progreso en un solo lugar. Revisa tus clases, abre enlaces directos y sigue tu avance con claridad. Nos tienes a mano para que sigas aprendiendo sin perder el ritmo.
                </p>
                <div class="ps-highlights">
                    <span><i class="fa fa-calendar-check-o" aria-hidden="true"></i> Horario al d√≠a</span>
                    <span><i class="fa fa-link" aria-hidden="true"></i> Recursos r√°pidos</span>
                    <span><i class="fa fa-line-chart" aria-hidden="true"></i> Progreso visible</span>
                </div>
            </div>
        </section>
    </t>
</template>

<template id="portal_student_dashboard_cards" name="Portal Student Dashboard Cards">
    <section class="ps-dashboard">
        <div class="ps-dashboard-grid">
            <div class="ps-card ps-card-highlight">
                <div class="ps-card-head">
                    <div>
                        <p class="ps-eyebrow">Pr√≥xima clase</p>
                        <h3>
                            <t t-if="next_session"><t t-esc="next_session.student_alias or next_session.subject_id.alias or next_session.subject_id.name"/></t>
                            <t t-else="">Sin clases programadas</t>
                        </h3>
                    </div>
                    <span class="ps-badge" t-att-class="'ps-badge ' + ('ps-badge-emerald' if next_session_source == 'agenda' else 'ps-badge-blue')">
                        <t t-esc="'En tu horario' if next_session_source == 'agenda' else 'Publicada'"/>
                    </span>
                </div>
                <t t-if="next_session">
                    <t t-set="next_join_link" t-value="next_session.teacher_meeting_link or next_session.meeting_link"/>
                    <p class="ps-session-meta">
                        <i class="fa fa-clock-o" aria-hidden="true"></i>
                        <span t-field="next_session.datetime_start" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/> -
                        <span t-field="next_session.datetime_end" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/>
                    </p>
                    <p class="ps-session-meta" t-if="next_session.campus_id or next_session.delivery_mode">
                        <i class="fa fa-map-marker" aria-hidden="true"></i>
                        <t t-if="next_session.campus_id"><t t-esc="next_session.campus_id.name"/> </t>
                        <t t-if="next_session.delivery_mode">| <t t-esc="next_session.delivery_mode"/></t>
                    </p>
                    <p class="ps-session-meta" t-if="next_session.subcampus_id and next_session.subcampus_id.meeting_platform">
                        <i class="fa fa-video-camera" aria-hidden="true"></i>
                        <t t-esc="next_session.subcampus_id.meeting_platform"/>
                    </p>
                    <div class="ps-actions-inline">
                        <a class="ps-link" href="/my/student/agenda"><i class="fa fa-calendar"></i> Abrir horario</a>
                        <!-- Solo mostrar link de ingresar para clases virtuales e h√≠bridas -->
                        <t t-if="next_session.delivery_mode in ['virtual', 'hybrid']">
                            <a t-if="next_join_link and next_session_join_allowed" class="ps-link" t-att-href="next_join_link" target="_blank" rel="noopener">
                                <i class="fa fa-external-link"></i> Ingresar
                            </a>
                            <button t-elif="next_join_link" type="button" class="ps-button ps-button-ghost ps-button-xs ps-button-disabled" disabled="disabled" title="Disponible 5 min antes y 5 min despu√©s de iniciar">
                                <i class="fa fa-lock"></i> Ingresar
                            </button>
                        </t>
                    </div>
                </t>
                <t t-else="">
                    <div class="ps-empty-block">
                        <i class="fa fa-calendar-times-o" aria-hidden="true"></i>
                        <p>No tienes clases en tu horario para esta semana.</p>
                        <a class="ps-button ps-button-ghost" href="/my/student/agenda">Agregar ahora</a>
                    </div>
                </t>
            </div>

            <div class="ps-card">
                <div class="ps-card-head">
                    <div>
                        <p class="ps-eyebrow">Hoy</p>
                        <h3>Horario del d√≠a</h3>
                    </div>
                    <span class="ps-badge ps-badge-soft" t-att-class="'ps-badge ps-badge-soft ' + ('ps-badge-emerald' if today_sessions_source == 'agenda' else 'ps-badge-blue-soft')">
                        <t t-esc="'En tu horario' if today_sessions_source == 'agenda' else 'Publicada'"/>
                    </span>
                </div>
                <t t-if="today_sessions">
                    <ul class="ps-list">
                        <t t-foreach="today_sessions" t-as="session">
                            <li class="ps-session-row">
                                <div class="ps-list-title" t-esc="session.student_alias or session.subject_id.alias or session.subject_id.name"/>
                                <p class="ps-session-meta">
                                    <i class="fa fa-clock-o" aria-hidden="true"></i>
                                    <span t-field="session.datetime_start" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/> -
                                    <span t-field="session.datetime_end" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/>
                                </p>
                                <p class="ps-session-meta" t-if="session.campus_id or session.delivery_mode">
                                    <i class="fa fa-map-marker" aria-hidden="true"></i>
                                    <t t-if="session.campus_id"><t t-esc="session.campus_id.name"/> </t>
                                    <t t-if="session.delivery_mode">| <t t-esc="session.delivery_mode"/></t>
                                </p>
                            </li>
                        </t>
                    </ul>
                </t>
                <t t-else="">
                    <div class="ps-empty-block">
                        <i class="fa fa-calendar-o" aria-hidden="true"></i>
                        <p>Sin clases hoy.</p>
                    </div>
                </t>
            </div>

            <div class="ps-card">
                <div class="ps-card-head">
                    <div>
                        <p class="ps-eyebrow">Programas</p>
                        <h3>Activos</h3>
                    </div>
                    <a class="ps-link" href="/my/student/program">Ver detalle</a>
                </div>
                <t t-if="programs">
                    <ul class="ps-list">
                        <t t-foreach="programs" t-as="program">
                            <li>
                                <div class="ps-list-title" t-esc="program.name"/>
                                <p class="ps-session-meta" t-if="program.code">C√≥digo <t t-esc="program.code"/></p>
                            </li>
                        </t>
                    </ul>
                </t>
                <t t-else="">
                    <div class="ps-empty-block">
                        <i class="fa fa-folder-open" aria-hidden="true"></i>
                        <p>No hay programas activos</p>
                    </div>
                </t>
            </div>

            <div class="ps-card">
                <div class="ps-card-head">
                    <div>
                        <p class="ps-eyebrow">Estado r√°pido</p>
                        <h3>Indicadores</h3>
                    </div>
                    <a class="ps-link" href="/my/student/status">Calificaciones</a>
                </div>
                <div class="ps-kpi-grid">
                    <div class="ps-kpi">
                        <p class="ps-metric-label">Activas</p>
                        <p class="ps-metric-value" t-esc="stats.get('active_enrollments')"/>
                    </div>
                    <div class="ps-kpi">
                        <p class="ps-metric-label">Completadas</p>
                        <p class="ps-metric-value" t-esc="stats.get('completed_enrollments')"/>
                    </div>
                    <div class="ps-kpi">
                        <p class="ps-metric-label">Promedio</p>
                        <p class="ps-metric-value">
                            <t t-if="stats.get('avg_grade')"><t t-esc="stats.get('avg_grade')"/></t>
                            <t t-else="">N/D</t>
                        </p>
                    </div>
                    <div class="ps-kpi">
                        <p class="ps-metric-label">Progreso</p>
                        <p class="ps-metric-value">
                            <t t-if="stats.get('progress')"><t t-esc="stats.get('progress')"/>%</t>
                            <t t-else="">0%</t>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="ps-quickbar">
            <div class="ps-quickitem">
                <i class="fa fa-calendar-plus-o" aria-hidden="true"></i>
                <div>
                    <p>Gestionar agenda</p>
                    <a href="/my/student/agenda">Abrir</a>
                </div>
            </div>
            <div class="ps-quickitem">
                <i class="fa fa-book" aria-hidden="true"></i>
                <div>
                    <p>Mis programas</p>
                    <a href="/my/student/program">Abrir</a>
                </div>
            </div>
            <div class="ps-quickitem">
                <i class="fa fa-star" aria-hidden="true"></i>
                <div>
                    <p>Calificaciones</p>
                    <a href="/my/student/status">Ver</a>
                </div>
            </div>
            <div class="ps-quickitem">
                <i class="fa fa-link" aria-hidden="true"></i>
                <div>
                    <p>Recursos</p>
                    <a href="/my/student/resources">Ir</a>
                </div>
            </div>
        </div>
    </section>
</template>

<template id="portal_student_info" name="Portal Student Info">
    <t t-call="portal.portal_layout">
        <t t-set="page_name" t-value="'info'"/>
        <t t-call="portal_student.portal_student_header"/>

        <div class="ps-shell">
            <section class="ps-welcome-card">
                <div class="ps-welcome-head">
                    <div class="ps-welcome-logo">
                        <img src="/portal_student/static/src/img/benglish_logo_nav.png" alt="Benglish"/>
                    </div>
                    <div>
                        <p class="ps-eyebrow">Informaci√≥n personal</p>
                        <h1 class="ps-welcome-name" t-esc="student.name"/>
                        <p class="ps-subtitle">
                            <span t-if="student.code">C√≥digo: <t t-esc="student.code"/></span>
                            <span t-if="student.email"> | <t t-esc="student.email"/></span>
                        </p>
                    </div>
                </div>
                <div class="ps-welcome-message">
                    <h3>Actualiza tus datos</h3>
                    <p>
                        Mantener tu informaci√≥n al d√≠a nos ayuda a acompa√±arte mejor. Ajusta tus datos personales, contacto y preferencias. Guarda los cambios cuando termines.
                    </p>
                </div>
            </section>

            <form class="ps-form" action="/my/student/info" method="post">
                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                <t t-if="message">
                    <div class="alert alert-success ps-alert" role="alert">
                        <t t-esc="message"/>
                    </div>
                </t>
                <t t-if="error">
                    <div class="alert alert-danger ps-alert" role="alert">
                        <t t-esc="error"/>
                    </div>
                </t>

                <div class="ps-accordion">
                    <details class="ps-accordion-item" open="open">
                        <summary><i class="fa fa-user" aria-hidden="true"></i> Datos personales</summary>
                        <div class="ps-grid ps-grid-2">
                            <div class="ps-field">
                                <label for="name">Nombre completo</label>
                                <input id="name" name="name" type="text" class="form-control" t-att-value="student.name" required="required"/>
                            </div>
                            <div class="ps-field">
                                <label for="student_id_number">Documento de identidad</label>
                                <input id="student_id_number" name="student_id_number" type="text" class="form-control" t-att-value="student.student_id_number"/>
                            </div>
                            <div class="ps-field">
                                <label for="gender">Sexo</label>
                                <select id="gender" name="gender" class="form-select">
                                    <option value="">Selecciona</option>
                                    <option value="male" t-att-selected="student.gender == 'male'">Masculino</option>
                                    <option value="female" t-att-selected="student.gender == 'female'">Femenino</option>
                                    <option value="other" t-att-selected="student.gender == 'other'">Otro</option>
                                </select>
                            </div>
                            <div class="ps-field">
                                <label for="birth_date">Fecha de nacimiento</label>
                                <input id="birth_date" name="birth_date" type="date" class="form-control" t-att-value="student.birth_date"/>
                            </div>
                        </div>
                    </details>

                    <details class="ps-accordion-item">
                        <summary><i class="fa fa-envelope" aria-hidden="true"></i> Contacto</summary>
                        <div class="ps-grid ps-grid-2">
                            <div class="ps-field">
                                <label for="email">Correo electr√≥nico</label>
                                <input id="email" name="email" type="email" class="form-control" t-att-value="student.email" required="required"/>
                            </div>
                            <div class="ps-field">
                                <label for="phone">Tel√©fono</label>
                                <input id="phone" name="phone" type="text" class="form-control" t-att-value="student.phone"/>
                            </div>
                            <div class="ps-field">
                                <label for="mobile">Celular</label>
                                <input id="mobile" name="mobile" type="text" class="form-control" t-att-value="student.mobile"/>
                            </div>
                            <div class="ps-field">
                                <label for="address">Direcci√≥n</label>
                                <input id="address" name="address" type="text" class="form-control" t-att-value="student.address"/>
                            </div>
                            <div class="ps-field">
                                <label for="city">Ciudad</label>
                                <input id="city" name="city" type="text" class="form-control" t-att-value="student.city"/>
                            </div>
                            <div class="ps-field">
                                <label for="country_id">Pa√≠s</label>
                                <select id="country_id" name="country_id" class="form-select">
                                    <option value="">Selecciona pa√≠s</option>
                                    <t t-foreach="countries" t-as="c">
                                        <option t-att-value="c.id" t-att-selected="student.country_id and student.country_id.id == c.id"><t t-esc="c.name"/></option>
                                    </t>
                                </select>
                            </div>
                        </div>
                    </details>

                    <details class="ps-accordion-item">
                        <summary><i class="fa fa-sliders" aria-hidden="true"></i> Preferencias</summary>
                        <div class="ps-grid ps-grid-2">
                            <div class="ps-field">
                                <label for="preferred_campus_id">Sede preferida</label>
                                <select id="preferred_campus_id" name="preferred_campus_id" class="form-select">
                                    <option value="">Selecciona sede</option>
                                    <t t-foreach="campuses" t-as="campus">
                                        <option t-att-value="campus.id" t-att-selected="student.preferred_campus_id and student.preferred_campus_id.id == campus.id"><t t-esc="campus.name"/></option>
                                    </t>
                                </select>
                            </div>
                            <div class="ps-field">
                                <label for="preferred_delivery_mode">Modalidad preferida</label>
                                <select id="preferred_delivery_mode" name="preferred_delivery_mode" class="form-select">
                                    <option value="">Selecciona</option>
                                    <option value="presencial" t-att-selected="student.preferred_delivery_mode == 'presencial'">Presencial</option>
                                    <option value="virtual" t-att-selected="student.preferred_delivery_mode == 'virtual'">Virtual</option>
                                    <option value="hybrid" t-att-selected="student.preferred_delivery_mode == 'hybrid'">H√≠brido</option>
                                </select>
                            </div>
                        </div>
                    </details>
                </div>

                <div class="ps-actions">
                    <button type="submit" class="ps-button">Actualizar informaci√≥n</button>
                </div>
            </form>
        </div>
    </t>
</template>

<template id="portal_student_summary" name="Portal Student Summary">
    <t t-set="page_name" t-value="'summary'"/>
    <t t-call="portal_student.portal_student_base">
        <section class="ps-hero">
            <div>
                <p class="ps-eyebrow">Resumen</p>
                <h1 class="ps-welcome-name">Estado acad√©mico</h1>
                <p class="ps-subtitle">
                    Pr√≥xima clase, agenda del d√≠a y KPIs actualizados.
                </p>
                <div class="ps-hero-stats">
                    <div>
                        <p class="ps-metric-label">Pr√≥xima</p>
                        <p class="ps-metric-value">
                            <t t-if="next_session">
                                <span t-field="next_session.datetime_start" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/>
                            </t>
                            <t t-else="">Sin clases</t>
                        </p>
                    </div>
                    <div>
                        <p class="ps-metric-label">Agenda semana</p>
                        <p class="ps-metric-value" t-esc="len(scheduled_lines) if scheduled_lines else 0"/>
                    </div>
                    <div>
                        <p class="ps-metric-label">Promedio</p>
                        <p class="ps-metric-value">
                            <t t-if="stats.get('avg_grade')"><t t-esc="stats.get('avg_grade')"/></t>
                            <t t-else="">N/D</t>
                        </p>
                    </div>
                </div>
            </div>
            <div class="ps-hero-actions">
                <a class="ps-button" href="/my/student/agenda"><i class="fa fa-calendar"></i> Gestionar agenda</a>
                <a class="ps-button ps-button-ghost" href="/my/student/status"><i class="fa fa-line-chart"></i> Ver estado</a>
            </div>
        </section>

        <t t-call="portal_student.portal_student_dashboard_cards"/>
    </t>
</template>

        <!-- Agenda semanal publicada -->
        <template id="portal_student_agenda" name="Portal Student Agenda">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'agenda'"/>
                <t t-set="display_tz" t-value="request.env.user.tz or 'America/Bogota'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <section class="ps-week">
                        <div class="ps-week-head">
                            <div>
                                <h3>Nueva agenda semanal</h3>
                                <p class="ps-session-meta">
                                    <i class="fa fa-calendar" aria-hidden="true"></i>
                                    <t t-esc="week.get('monday')"/> - <t t-esc="week.get('sunday')"/>
                                    | <t t-esc="week.get('scheduled_total') or 0"/> clases agendadas
                                    | <t t-esc="week.get('total_sessions') or 0"/> publicadas
                                </p>
                            </div>
                            <div class="ps-week-nav">
                                <button type="button" class="ps-button ps-button-ghost" data-week-shift="-1" t-att-data-start="week_start_str">
                                    <i class="fa fa-chevron-left"></i> Semana anterior
                                </button>
                                <button type="button" class="ps-button" data-week-shift="1" t-att-data-start="week_start_str">
                                    Siguiente semana <i class="fa fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div id="ps-agenda-feedback"></div>

                        <!-- Resumen semanal (Cards) -->
                        <div class="ps-week-summary" style="margin-top: 1rem; margin-bottom: 1.5rem;">
                            <div class="ps-status-card" style="padding: 0.75rem 1rem;">
                                <div class="ps-status-icon ps-status-icon-blue" style="width: 40px; height: 40px;"><i class="fa fa-calendar-check-o"></i></div>
                                <div>
                                    <p class="ps-status-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">SEMANA</p>
                                    <h3 class="ps-status-value" style="font-size: 1.5rem; margin-bottom: 0.2rem;">#<t t-esc="week.get('week_number') or 'N/D'"/></h3>
                                    <p class="ps-session-meta" style="font-size: 0.7rem;">Del <t t-esc="week.get('monday')"/> al <t t-esc="week.get('sunday')"/></p>
                                </div>
                            </div>
                            <div class="ps-status-card" style="padding: 0.75rem 1rem;">
                                <div class="ps-status-icon ps-status-icon-green" style="width: 40px; height: 40px;"><i class="fa fa-check"></i></div>
                                <div>
                                    <p class="ps-status-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">AGENDADAS</p>
                                    <h3 class="ps-status-value" style="font-size: 1.5rem; margin-bottom: 0.2rem;"><t t-esc="week.get('scheduled_total') or 0"/></h3>
                                    <p class="ps-session-meta" style="font-size: 0.7rem;">Clases ya confirmadas</p>
                                </div>
                            </div>
                            <div class="ps-status-card" style="padding: 0.75rem 1rem;">
                                <div class="ps-status-icon ps-status-icon-orange" style="width: 40px; height: 40px;"><i class="fa fa-clock-o"></i></div>
                                <div>
                                    <p class="ps-status-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">DISPONIBLES</p>
                                    <h3 class="ps-status-value" style="font-size: 1.5rem; margin-bottom: 0.2rem;"><t t-esc="week.get('total_sessions') or 0"/></h3>
                                    <p class="ps-session-meta" style="font-size: 0.7rem;">Publicadas para tus grupos</p>
                                </div>
                            </div>
                        </div>

                        <!-- HU-E9: Selector de sede/ciudad -->
                        <div class="ps-campus-selector">
                            <div class="ps-card ps-card-highlight">
                                <div class="ps-card-head">
                                    <h3><i class="fa fa-map-marker" aria-hidden="true"></i> Cambiar sede o ciudad</h3>
                                </div>
                                <p class="ps-session-meta">
                                    Filtra la agenda publicada por sede o ciudad para consultar y agendar actividades en otras ubicaciones. Tu matr√≠cula acad√©mica no se modifica.
                                </p>
                                
                                <!-- Filtro actual -->
                                <t t-if="current_filter.get('type') in ['campus', 'city', 'default'] or current_filter.get('mode')">
                                    <div class="ps-current-filter-badge" style="margin-bottom: 16px; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <i class="fa fa-filter" style="color: #0284c7; font-size: 18px;"></i>
                                            <div style="flex: 1;">
                                                <strong style="color: #0c4a6e; display: block; font-size: 14px;">
                                                    <t t-if="current_filter.get('type') == 'default' and current_filter.get('default_source') == 'preferred'">Sede principal:</t>
                                                    <t t-if="current_filter.get('type') == 'default' and current_filter.get('default_source') != 'preferred'">Sede actual:</t>
                                                    <t t-else="">Filtrando por:</t>
                                                </strong>
                                                <span style="color: #075985; font-size: 16px;">
                                                    <t t-esc="current_filter.get('label', 'Todas las sedes')"/>
                                                    <t t-if="current_filter.get('mode')">
                                                        <span style="margin-left: 8px; padding: 4px 10px; background: #dbeafe; border-radius: 6px; font-size: 13px;">
                                                            <t t-if="current_filter.get('mode') == 'presential'">üìç Presencial</t>
                                                            <t t-if="current_filter.get('mode') == 'virtual'">üíª Virtual</t>
                                                            <t t-if="current_filter.get('mode') == 'hybrid'">üîÑ H√≠brido</t>
                                                        </span>
                                                    </t>
                                                </span>
                                            </div>
                                            <a href="/my/student/agenda?clear_filter=1" 
                                               style="padding: 6px 12px; background: #0284c7; color: white; border-radius: 6px; text-decoration: none; font-size: 13px; white-space: nowrap;">
                                                <i class="fa fa-times"></i> Limpiar filtros
                                            </a>
                                        </div>
                                    </div>
                                </t>
                                <t t-else="">
                                    <div class="ps-current-filter-badge" style="margin-bottom: 16px; padding: 12px; background: #dcfce7; border-radius: 8px; border-left: 4px solid #10b981;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <i class="fa fa-check-circle" style="color: #10b981; font-size: 18px;"></i>
                                            <div>
                                                <strong style="color: #064e3b; display: block; font-size: 14px;">Vista actual:</strong>
                                                <span style="color: #047857; font-size: 16px;">Selecciona tu sede para ver la agenda</span>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                                
                                <t t-set="campus_selector_open" t-value="False"/>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <button type="button" class="ps-button ps-button-ghost" data-action="ps-change-campus">
                                        <i class="fa fa-exchange"></i> Cambiar sede
                                    </button>
                                    <span class="ps-session-meta" style="margin: 0;">
                                        Solo veras sedes con agenda publicada para tu programa.
                                    </span>
                                </div>

                                <div id="ps-campus-confirm-modal" class="ps-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="ps-campus-confirm-title">
                                    <div class="ps-confirm-card">
                                        <div class="ps-confirm-head">
                                            <span class="ps-confirm-icon">
                                                <i class="fa fa-map-marker" aria-hidden="true"></i>
                                            </span>
                                            <div>
                                                <h4 id="ps-campus-confirm-title" class="ps-confirm-title">Cambiar sede</h4>
                                                <p class="ps-confirm-text">
                                                    Vas a consultar horarios en otra sede. Tu agenda no se modifica hasta que selecciones un horario.
                                                </p>
                                            </div>
                                        </div>
                                        <div class="ps-confirm-actions">
                                            <button type="button" class="ps-button ps-button-ghost" data-action="ps-cancel-campus">Cancelar</button>
                                            <button type="button" class="ps-button" data-action="ps-confirm-campus">Si, continuar</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="ps-add-confirm-modal" class="ps-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="ps-add-confirm-title">
                                    <div class="ps-confirm-card">
                                        <div class="ps-confirm-head">
                                            <span class="ps-confirm-icon">
                                                <i class="fa fa-calendar-plus-o" aria-hidden="true"></i>
                                            </span>
                                            <div>
                                                <h4 id="ps-add-confirm-title" class="ps-confirm-title">Confirmar agendamiento</h4>
                                                <p class="ps-confirm-text">
                                                    Estas seguro que quieres agendar esta clase?
                                                </p>
                                            </div>
                                        </div>
                                        <div class="ps-confirm-subtitle">Resumen de la clase</div>
                                        <div class="ps-confirm-details">
                                            <div class="ps-confirm-row" data-field="subject">
                                                <span class="ps-confirm-label">Clase</span>
                                                <span class="ps-confirm-value" id="ps-add-confirm-subject"></span>
                                            </div>
                                            <div class="ps-confirm-row" data-field="date">
                                                <span class="ps-confirm-label">Fecha</span>
                                                <span class="ps-confirm-value" id="ps-add-confirm-date"></span>
                                            </div>
                                            <div class="ps-confirm-row" data-field="time">
                                                <span class="ps-confirm-label">Horario</span>
                                                <span class="ps-confirm-value" id="ps-add-confirm-time"></span>
                                            </div>
                                            <div class="ps-confirm-row" data-field="campus">
                                                <span class="ps-confirm-label">Sede</span>
                                                <span class="ps-confirm-value" id="ps-add-confirm-campus"></span>
                                            </div>
                                            <div class="ps-confirm-row" data-field="room">
                                                <span class="ps-confirm-label">Aula</span>
                                                <span class="ps-confirm-value" id="ps-add-confirm-room"></span>
                                            </div>
                                        </div>
                                        <div class="ps-confirm-actions">
                                            <button type="button" class="ps-button ps-button-ghost" data-action="ps-add-cancel">Cancelar</button>
                                            <button type="button" class="ps-button" data-action="ps-add-confirm">Aceptar</button>
                                        </div>
                                    </div>
                                </div>

                                <div id="ps-campus-selector-body" t-att-style="'display: block;' if campus_selector_open else 'display: none;'">
                                
                                <!-- Opci√≥n: Mi sede principal -->
                                <div class="ps-campus-selector-grid" style="margin-bottom: 24px;">
                                    <a t-attf-href="/my/student/agenda?start={{week_start_str}}{{'' if not current_filter.get('mode') else '&amp;filter_mode=' + current_filter.get('mode')}}" 
                                       t-attf-class="ps-campus-option {{'' if current_filter.get('type') == 'default' or current_filter.get('type') == 'none' else ''}}">
                                        <div class="ps-campus-option-icon" style="background: #34d399;">
                                            <i class="fa fa-home"></i>
                                        </div>
                                        <div class="ps-campus-option-content">
                                            <h4>Mi sede principal</h4>
                                            <p t-if="student.preferred_campus_id">
                                                <t t-esc="student.preferred_campus_id.name"/> - <t t-esc="student.preferred_campus_id.city_name or ''"/>
                                            </p>
                                            <p t-else="">No configurada</p>
                                        </div>
                                        <span t-if="current_filter.get('type') == 'default' or current_filter.get('type') == 'none'" class="ps-campus-option-badge">
                                            <i class="fa fa-check-circle"></i>
                                        </span>
                                    </a>
                                </div>
                                
                                <!-- Selector de ciudades -->
                                <h4 style="margin: 24px 0 12px; color: #1e293b; font-size: 16px; font-weight: 600;">
                                    <i class="fa fa-building"></i> Selecciona una ciudad
                                </h4>
                                
                                <t t-if="cities_data">
                                    <t t-foreach="cities_data.items()" t-as="city_data">
                                        <t t-set="city_name" t-value="city_data[0]"/>
                                        <t t-set="city_campuses" t-value="city_data[1]"/>
                                        
                                        <details class="ps-city-accordion" t-att-open="'open' if current_filter.get('city') == city_name or (current_filter.get('type') == 'campus' and current_filter.get('campus_id') in [c.id for c in city_campuses]) else None"
                                                 style="margin-bottom: 12px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                            <summary style="padding: 16px; background: #f8fafc; cursor: pointer; font-weight: 600; color: #1e40af; display: flex; align-items: center; gap: 12px;">
                                                <i class="fa fa-building" style="font-size: 18px;"></i>
                                                <span style="flex: 1;" t-esc="city_name"/>
                                                <span style="background: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 13px;">
                                                    <t t-esc="len(city_campuses)"/> sede<t t-if="len(city_campuses) != 1">s</t>
                                                </span>
                                                <i class="fa fa-chevron-down" style="font-size: 12px; transition: transform 0.2s;"></i>
                                            </summary>
                                            
                                            <div style="padding: 12px; background: white;">
                                                <div class="ps-campus-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                                                    <t t-foreach="city_campuses" t-as="campus">
                                                        <a t-attf-href="/my/student/agenda?start={{week_start_str}}&amp;filter_campus_id={{campus.id}}{{'' if not current_filter.get('mode') else '&amp;filter_mode=' + current_filter.get('mode')}}"
                                                           t-attf-class="ps-campus-card {{'' if current_filter.get('campus_id') == campus.id else ''}}"
                                                           style="display: block; padding: 16px; border: 2px solid #e2e8f0; border-radius: 8px; text-decoration: none; transition: all 0.2s; background: white;">
                                                            <div style="display: flex; align-items: start; gap: 12px;">
                                                                <div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                                    <i class="fa fa-map-marker" style="color: white; font-size: 18px;"></i>
                                                                </div>
                                                                <div style="flex: 1; min-width: 0;">
                                                                    <h5 style="margin: 0 0 6px; color: #1e293b; font-size: 15px; font-weight: 600;" t-esc="campus.name"/>
                                                                    <p style="margin: 0; color: #64748b; font-size: 13px; line-height: 1.4;">
                                                                        <t t-if="campus.address" t-esc="campus.address"/>
                                                                        <t t-else="">Sin direcci√≥n</t>
                                                                    </p>
                                                                    <t t-if="current_filter.get('campus_id') == campus.id">
                                                                        <span style="display: inline-block; margin-top: 8px; padding: 4px 10px; background: #dcfce7; color: #166534; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                                                            <i class="fa fa-check-circle"></i> Activa
                                                                        </span>
                                                                    </t>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </t>
                                                </div>
                                            </div>
                                        </details>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div style="padding: 24px; text-align: center; color: #64748b;">
                                        <i class="fa fa-info-circle" style="font-size: 32px; margin-bottom: 12px;"></i>
                                        <p style="margin: 0;">No hay sedes disponibles en este momento.</p>
                                    </div>
                                </t>
                                </div>
                            </div>
                        </div>

                        <div class="ps-planner">
                            <!-- HU-E7: Alerta de prerrequisito BCheck obligatorio -->
                            <t t-if="needs_prerequisite_warning and available_prerequisites">
                                <div class="ps-card ps-card-warning" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                                    <div class="ps-card-head">
                                        <h3 style="color: #92400e;">
                                            <i class="fa fa-exclamation-triangle" aria-hidden="true"></i> 
                                            ‚ö°PRERREQUISITO OBLIGATORIO (BCheck)
                                        </h3>
                                    </div>
                                    <p style="color: #78350f; font-size: 14px; margin: 12px 0;">
                                        <strong>Debes agendar PRIMERO el B-check</strong> antes de poder agregar cualquier otra clase a tu semana.
                                    </p>
                                    <p style="color: #78350f; font-size: 13px;">
                                        El BCheck es una clase obligatoria de evaluaci√≥n inicial que debe estar en tu agenda antes que cualquier otra sesi√≥n. 
                                        Busca el B-check marcado con ‚ö° en la lista de abajo y agr√©galo primero.
                                    </p>
                                </div>
                            </t>
                            
                            <div class="ps-card ps-card-highlight">
                                <div class="ps-card-head">
                                    <h3><i class="fa fa-magic" aria-hidden="true"></i> Construye tu semana</h3>
                                </div>
                                <p class="ps-session-meta">
                                    Selecciona las asignaturas que deseas agendar. Cada asignatura muestra m√∫ltiples opciones de horario disponibles. <strong>Importante:</strong> Debes agendar primero el B-check antes de poder programar cualquier otra clase.
                                </p>
                                
                                <!-- MENSAJE: Sin filtro de sede seleccionado -->
                                <t t-if="not has_filter">
                                    <div style="margin-top: 24px; padding: 32px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6; border-radius: 16px; text-align: center;">
                                        <div style="display: inline-flex; width: 80px; height: 80px; background: #3b82f6; border-radius: 50%; align-items: center; justify-content: center; margin-bottom: 20px;">
                                            <i class="fa fa-map-marker" style="font-size: 36px; color: white;"></i>
                                        </div>
                                        <h4 style="font-size: 22px; font-weight: 700; color: #1e40af; margin: 0 0 12px;">Selecciona una sede para comenzar</h4>
                                        <p style="font-size: 16px; color: #1e3a8a; margin: 0 0 24px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.6;">
                                            Para ver y agendar las sesiones disponibles, primero debes seleccionar una <strong>sede</strong> o <strong>ciudad</strong> utilizando los selectores de arriba.
                                        </p>
                                        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                                            <div style="background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);">
                                                <i class="fa fa-building" style="font-size: 24px; color: #3b82f6; margin-bottom: 8px;"></i>
                                                <p style="margin: 0; font-size: 14px; color: #64748b;">
                                                    <strong style="color: #1e40af; display: block; margin-bottom: 4px;">Paso 1</strong>
                                                    Selecciona una sede espec√≠fica
                                                </p>
                                            </div>
                                            <div style="background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);">
                                                <i class="fa fa-filter" style="font-size: 24px; color: #3b82f6; margin-bottom: 8px;"></i>
                                                <p style="margin: 0; font-size: 14px; color: #64748b;">
                                                    <strong style="color: #1e40af; display: block; margin-bottom: 4px;">Paso 2</strong>
                                                    Filtra por modalidad (opcional)
                                                </p>
                                            </div>
                                            <div style="background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);">
                                                <i class="fa fa-calendar-check-o" style="font-size: 24px; color: #3b82f6; margin-bottom: 8px;"></i>
                                                <p style="margin: 0; font-size: 14px; color: #64748b;">
                                                    <strong style="color: #1e40af; display: block; margin-bottom: 4px;">Paso 3</strong>
                                                    Agenda tus clases
                                                </p>
                                            </div>
                                        </div>
                                        <p style="margin-top: 24px; font-size: 13px; color: #64748b;">
                                            <i class="fa fa-info-circle"></i> 
                                            Esto evita cargar miles de sesiones y te permite ver solo las opciones relevantes para ti.
                                        </p>
                                    </div>
                                </t>
                                
                                <!-- Vista semanal: sesiones disponibles por d√≠a -->
                                <t t-if="has_filter and agenda_sessions">
                                    <div class="ps-week-grid ps-week-grid-tight" style="margin-top: 24px;">
                                        <t t-foreach="agenda_by_day" t-as="day">
                                            <t t-set="day_sessions" t-value="day.get('sessions')"/>
                                            <div class="ps-week-day">
                                                <div class="ps-week-day-head">
                                                    <span class="ps-week-day-name" t-esc="day.get('date').strftime('%A')"/>
                                                    <span class="ps-week-day-date" t-esc="day.get('date')"/>
                                                </div>
                                                <div class="ps-week-sessions ps-week-sessions-compact">
                                                    <t t-if="day_sessions">
                                                        <t t-foreach="day_sessions" t-as="session">
                                                            <t t-set="subject_category" t-value="session.template_id.subject_category or (session.sudo().subject_id and session.sudo().subject_id.subject_category)"/>
                                                            <t t-set="is_prerequisite_sess" t-value="subject_category == 'bcheck'"/>
                                                            <t t-set="is_oral_test" t-value="subject_category == 'oral_test'"/>
                                                            <t t-set="required_unit" t-value="0"/>
                                                            <t t-set="student_max_unit" t-value="student_max_unit_ctx or 0"/>
                                                            <t t-set="level_name" t-value="student_level_name_ctx or ''"/>
                                                            <t t-set="prereq_units_raw" t-value="''"/>
                                                            <t t-if="is_oral_test and prereq_units_raw">
                                                                <t t-set="prereq_units" t-value="[]"/>
                                                                <t t-if="prereq_units">
                                                                    <t t-set="required_unit" t-value="prereq_units[0]"/>
                                                                </t>
                                                            </t>
                                                            <div class="ps-week-session ps-week-session-compact"
                                                                 t-att-data-is-prerequisite="is_prerequisite_sess and 'true' or 'false'"
                                                                 t-att-data-is-oral-test="is_oral_test and 'true' or 'false'"
                                                                 t-att-data-required-unit="is_oral_test and str(required_unit) or ''"
                                                                 t-att-data-student-max-unit="is_oral_test and str(student_max_unit) or ''"
                                                                 t-att-data-level-name="is_oral_test and level_name or ''">
                                                                <div class="ps-week-session-row">
                                                                    <div class="ps-week-session-main">
                                                                        <div class="ps-week-session-badges">
                                                                            <t t-if="is_prerequisite_sess">
                                                                                <span class="ps-pill ps-pill-xs ps-pill-warning">
                                                                                    PRERREQ
                                                                                </span>
                                                                            </t>
                                                                            <t t-if="is_oral_test">
                                                                                <span class="ps-pill ps-pill-xs ps-badge-oral-test">
                                                                                    ORAL TEST<t t-if="required_unit &gt; 0"> U<t t-esc="required_unit"/></t>
                                                                                </span>
                                                                            </t>
                                                                        </div>
                                                                        <p class="ps-list-title ps-week-session-title" t-esc="session.student_alias or session.subject_id.alias or session.subject_id.name"/>
                                                                        <div class="ps-week-session-inline">
                                                                            <span class="ps-session-time">
                                                                                <span t-field="session.datetime_start" t-options='{"widget": "datetime", "format": "HH:mm", "tz_name": display_tz, "time_only": True}'/> -
                                                                                <span t-field="session.datetime_end" t-options='{"widget": "datetime", "format": "HH:mm", "tz_name": display_tz, "time_only": True}'/>
                                                                            </span>
                                                                            <t t-if="session.subcampus_id">
                                                                                <span class="ps-session-sep">|</span>
                                                                                <span class="ps-session-room">Aula <t t-esc="session.subcampus_id.name"/></span>
                                                                            </t>
                                                                        </div>
                                                                        <t t-set="pr" t-value="prereq_status_by_session.get(session.id)"/>
                                                                        <t t-if="pr and not pr.get('ok')">
                                                                            <span class="ps-tag-warning ps-tag-warning-compact">
                                                                                <i class="fa fa-unlock-alt"></i> <t t-esc="pr.get('missing') or 'Prerrequisitos pendientes'"/>
                                                                            </span>
                                                                        </t>
                                                                    </div>
                                                                    <div class="ps-week-session-action">
                                                                        <t t-if="session.id not in bookable_session_ids">
                                                                            <span class="ps-tag-warning ps-tag-warning-compact" style="background: #eef2ff; border-color: #c7d2fe; color: #3730a3;">
                                                                                Agendada
                                                                            </span>
                                                                        </t>
                                                                        <button class="ps-button ps-button-xs"
                                                                                data-action="ps-add-session"
                                                                                t-att-data-session-id="session.id"
                                                                                t-att-data-week-start="week_start_str"
                                                                                t-att-data-subject="session.student_alias or session.subject_id.alias or session.subject_id.name"
                                                                                t-att-data-date="session.date"
                                                                                t-att-data-time-start="session.time_start"
                                                                                t-att-data-time-end="session.time_end"
                                                                                t-att-data-campus="session.campus_id.name if session.campus_id else ''"
                                                                                t-att-data-room="session.subcampus_id.name if session.subcampus_id else ''"
                                                                                aria-label="Agendar"
                                                                                title="Agendar"
                                                                                t-att-disabled="session.id not in bookable_session_ids">
                                                                            <i class="fa fa-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="ps-session-meta" style="color: #64748b;">Sin sesiones disponibles.</div>
                                                    </t>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                                <t t-elif="has_filter">
                                    <div style="margin-top: 24px; padding: 28px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; text-align: center;">
                                        <i class="fa fa-search" style="font-size: 48px; color: #94a3b8; margin-bottom: 16px;"></i>
                                        <h4 style="font-size: 18px; font-weight: 700; color: #475569; margin: 0 0 8px;">No hay sesiones disponibles</h4>
                                        <p style="font-size: 14px; color: #64748b; margin: 0;">
                                            No se encontraron sesiones publicadas para los filtros seleccionados en esta semana.
                                        </p>
                                        <p style="font-size: 13px; color: #94a3b8; margin-top: 12px;">
                                            <i class="fa fa-lightbulb-o"></i>
                                            Intenta seleccionar otra sede o navegar a otra semana.
                                        </p>
                                    </div>
                                </t>
                            </div>
                        </div>

                    </section>
                </div>
                
                <!-- Modal para seleccionar horarios de una asignatura -->
                <div id="ps-schedule-modal" class="ps-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 9999; overflow-y: auto; padding: 20px;">
                    <div class="ps-modal-content" style="max-width: 900px; margin: 40px auto; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative;">
                        <div class="ps-modal-header" style="padding: 24px 32px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 16px 16px 0 0;">
                            <div>
                                <h2 id="ps-modal-subject-name" style="margin: 0 0 8px; font-size: 24px; font-weight: 700;">Selecciona un horario</h2>
                                <p id="ps-modal-subject-info" style="margin: 0; font-size: 14px; opacity: 0.9;">Elige el horario que mejor se ajuste a tu disponibilidad</p>
                            </div>
                            <button class="ps-modal-close" data-action="ps-close-modal" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="ps-modal-body" id="ps-modal-sessions-list" style="padding: 32px; max-height: 70vh; overflow-y: auto;">
                            <!-- Se llenar√° din√°micamente con JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Fallback JavaScript para agendar clases -->
                <script type="text/javascript">
                    (function() {
                        'use strict';
                        
                        console.log('[Portal Student] Fallback script loaded');
                        var pendingAdd = null;
                        var addConfirmModal = null;
                        
                        // Esperar a que el DOM est√©¬© listo
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', initPortalStudent);
                        } else {
                            initPortalStudent();
                        }
                        
                        function initPortalStudent() {
                            console.log('[Portal Student] Initializing fallback handlers');
                            
                            // Manejar botones para abrir modal de horarios
                            var modalButtons = document.querySelectorAll('[data-action="ps-open-schedule-modal"]');
                            console.log('[Portal Student] Found ' + modalButtons.length + ' modal buttons');
                            
                            modalButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    console.log('[Portal Student] Open modal button clicked');
                                    
                                    var subjectId = btn.getAttribute('data-subject-id');
                                    var subjectName = btn.getAttribute('data-subject-name');
                                    
                                    console.log('[Portal Student] Subject ID:', subjectId, 'Name:', subjectName);
                                    
                                    if (!subjectId) {
                                        console.error('[Portal Student] No subject ID found');
                                        return;
                                    }
                                    
                                    openScheduleModal(subjectId, subjectName);
                                });
                            });
                            
                            // Manejar cierre del modal
                            var closeButtons = document.querySelectorAll('[data-action="ps-close-modal"]');
                            closeButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    closeScheduleModal();
                                });
                            });
                            
                            // Cerrar modal al hacer clic fuera
                            var modal = document.getElementById('ps-schedule-modal');
                            if (modal) {
                                modal.addEventListener('click', function(e) {
                                    if (e.target === modal) {
                                        closeScheduleModal();
                                    }
                                });
                            }

                            // Confirm modal para agendar clases
                            addConfirmModal = document.getElementById('ps-add-confirm-modal');
                            if (addConfirmModal) {
                                var confirmAddBtn = addConfirmModal.querySelector('[data-action="ps-add-confirm"]');
                                var cancelAddBtn = addConfirmModal.querySelector('[data-action="ps-add-cancel"]');

                                if (confirmAddBtn) {
                                    confirmAddBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        if (!pendingAdd || !pendingAdd.sessionId) {
                                            closeAddConfirm();
                                            return;
                                        }
                                        var sessionId = pendingAdd.sessionId;
                                        var weekStart = pendingAdd.weekStart;
                                        var actionBtn = pendingAdd.button;
                                        closeAddConfirm();

                                        if (actionBtn) {
                                            actionBtn.disabled = true;
                                            actionBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Agendando...';
                                        }
                                        addSession(sessionId, weekStart, actionBtn);
                                    });
                                }

                                if (cancelAddBtn) {
                                    cancelAddBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        closeAddConfirm();
                                    });
                                }

                                addConfirmModal.addEventListener('click', function(e) {
                                    if (e.target === addConfirmModal) {
                                        closeAddConfirm();
                                    }
                                });
                            }
                            
                            // Manejar botones de agendar
                            var addButtons = document.querySelectorAll('[data-action="ps-add-session"]');
                            console.log('[Portal Student] Found ' + addButtons.length + ' add buttons');
                            
                            addButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    console.log('[Portal Student] Add button clicked');
                                    
                                    var meta = buildAddMetaFromButton(btn);
                                    if (!meta.sessionId) {
                                        console.error('[Portal Student] No session ID found');
                                        return;
                                    }

                                    if (addConfirmModal) {
                                        openAddConfirm(meta);
                                        return;
                                    }

                                    btn.disabled = true;
                                    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Agendando...';
                                    addSession(meta.sessionId, meta.weekStart, btn);
                                });
                            });
                            
                            // Manejar botones de remover
                            var removeButtons = document.querySelectorAll('[data-action="ps-remove-session"]');
                            console.log('[Portal Student] Found ' + removeButtons.length + ' remove buttons');
                            
                            removeButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    console.log('[Portal Student] Remove button clicked');
                                    
                                    var lineId = btn.getAttribute('data-line-id');
                                    var subjectName = btn.getAttribute('data-subject-name') || 'Clase';
                                    var datetime = btn.getAttribute('data-datetime') || 'Sin fecha';
                                    var campus = btn.getAttribute('data-campus') || 'Sin sede';
                                    
                                    console.log('[Portal Student] Line ID:', lineId);
                                    
                                    if (!lineId) {
                                        console.error('[Portal Student] No line ID found');
                                        return;
                                    }
                                    
                                    // Mostrar modal de confirmaci√≥n
                                    var modal = document.getElementById('ps-cancel-class-modal');
                                    if (!modal) {
                                        console.error('[Portal Student] Cancel confirmation modal not found');
                                        return;
                                    }
                                    
                                    // Rellenar informaci√≥n de la clase
                                    document.getElementById('ps-cancel-class-subject').textContent = subjectName;
                                    document.getElementById('ps-cancel-class-datetime').textContent = datetime;
                                    document.getElementById('ps-cancel-class-campus').textContent = campus;
                                    
                                    // Mostrar modal
                                    modal.style.display = 'flex';
                                    modal.setAttribute('aria-hidden', 'false');
                                    
                                    // Configurar botones del modal
                                    var cancelBtn = modal.querySelector('[data-action="ps-cancel-class-no"]');
                                    var confirmBtn = modal.querySelector('[data-action="ps-cancel-class-yes"]');
                                    
                                    // Bot√≥n NO - cerrar modal
                                    if (cancelBtn) {
                                        cancelBtn.onclick = function() {
                                            modal.style.display = 'none';
                                            modal.setAttribute('aria-hidden', 'true');
                                        };
                                    }
                                    
                                    // Bot√≥n S√ç - ejecutar cancelaci√≥n
                                    if (confirmBtn) {
                                        confirmBtn.onclick = function() {
                                            modal.style.display = 'none';
                                            modal.setAttribute('aria-hidden', 'true');
                                            
                                            btn.disabled = true;
                                            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Cancelando...';
                                            
                                            removeSession(lineId, btn);
                                        };
                                    }
                                });
                            });
                            
                            // Manejar botones de navegaci√≥n entre semanas
                            var weekNavButtons = document.querySelectorAll('[data-week-shift]');
                            console.log('[Portal Student] Found ' + weekNavButtons.length + ' week navigation buttons');
                            
                            weekNavButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    console.log('[Portal Student] Week navigation button clicked');
                                    
                                    var shift = parseInt(btn.getAttribute('data-week-shift') || '0', 10);
                                    var start = btn.getAttribute('data-start');
                                    
                                    console.log('[Portal Student] Shift:', shift, 'Start:', start);
                                    
                                    if (!start) {
                                        console.error('[Portal Student] No start date found');
                                        return;
                                    }
                                    
                                    // Calcular nueva fecha
                                    var currentDate = new Date(start);
                                    currentDate.setDate(currentDate.getDate() + (shift * 7));
                                    var newStart = currentDate.toISOString().slice(0, 10);
                                    
                                    // Construir URL con par√°metros
                                    var url = new URL(window.location.href);
                                    url.searchParams.set('start', newStart);
                                    
                                    // Mantener filtros de sede/ciudad si existen (HU-E9)
                                    // Los par√°metros filter_campus_id y filter_city ya est√©¬°n en la URL si fueron configurados
                                    
                                    console.log('[Portal Student] Navigating to:', url.toString());
                                    
                                    // Mostrar indicador de carga
                                    btn.disabled = true;
                                    var originalHTML = btn.innerHTML;
                                    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Cargando...';
                                    
                                    // Navegar a la nueva semana
                                    window.location.href = url.toString();
                                });
                            });

                            // Manejar cambio de sede (fallback)
                            if (!window.psCampusModalHandler) {
                                var changeCampusButtons = document.querySelectorAll('[data-action=\"ps-change-campus\"]');
                                changeCampusButtons.forEach(function(btn) {
                                    btn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        var modal = document.getElementById('ps-campus-confirm-modal');
                                        var body = document.getElementById('ps-campus-selector-body');
                                        if (modal) {
                                            modal.classList.add('is-open');
                                            var confirmBtn = modal.querySelector('[data-action=\"ps-confirm-campus\"]');
                                            var cancelBtn = modal.querySelector('[data-action=\"ps-cancel-campus\"]');
                                            if (confirmBtn) {
                                                confirmBtn.onclick = function() {
                                                    modal.classList.remove('is-open');
                                                    if (body) {
                                                        body.style.display = 'block';
                                                    }
                                                };
                                            }
                                            if (cancelBtn) {
                                                cancelBtn.onclick = function() {
                                                    modal.classList.remove('is-open');
                                                };
                                            }
                                        } else {
                                            var confirmed = window.confirm('¬øEstas seguro de que deseas cambiar la sede?');
                                            if (!confirmed) {
                                                return;
                                            }
                                            if (body) {
                                                body.style.display = 'block';
                                                try {
                                                    body.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                                } catch (err) {}
                                            }
                                        }
                                    });
                                });
                            }
                        }
                        
                        function formatTimeFromFloat(value) {
                            if (value === null || value === undefined || value === '') {
                                return '';
                            }
                            var num = parseFloat(value);
                            if (isNaN(num)) {
                                return '';
                            }
                            var hours = Math.floor(num);
                            var minutes = Math.round((num - hours) * 60);
                            if (minutes &gt;= 60) {
                                hours += 1;
                                minutes = 0;
                            }
                            var hh = ('0' + hours).slice(-2);
                            var mm = ('0' + minutes).slice(-2);
                            return hh + ':' + mm;
                        }

                        function formatDateFromString(value) {
                            if (!value) {
                                return '';
                            }
                            var parts = String(value).split('-');
                            if (parts.length === 3) {
                                return parts[2] + '/' + parts[1] + '/' + parts[0];
                            }
                            return value;
                        }

                        function buildAddMetaFromButton(btn) {
                            return {
                                sessionId: btn.getAttribute('data-session-id'),
                                weekStart: btn.getAttribute('data-week-start'),
                                subject: btn.getAttribute('data-subject') || '',
                                date: btn.getAttribute('data-date') || '',
                                timeStart: btn.getAttribute('data-time-start'),
                                timeEnd: btn.getAttribute('data-time-end'),
                                campus: btn.getAttribute('data-campus') || '',
                                room: btn.getAttribute('data-room') || '',
                                button: btn
                            };
                        }

                        function setConfirmRow(field, value) {
                            if (!addConfirmModal) {
                                return;
                            }
                            var row = addConfirmModal.querySelector('[data-field="' + field + '"]');
                            var valueEl = document.getElementById('ps-add-confirm-' + field);
                            if (!row || !valueEl) {
                                return;
                            }
                            if (value) {
                                row.classList.remove('is-hidden');
                                valueEl.textContent = value;
                            } else {
                                row.classList.add('is-hidden');
                                valueEl.textContent = '';
                            }
                        }

                        function openAddConfirm(meta) {
                            if (!addConfirmModal) {
                                return;
                            }
                            pendingAdd = meta;
                            var subjectLabel = meta.subject || '';
                            var dateLabel = formatDateFromString(meta.date);
                            var startLabel = formatTimeFromFloat(meta.timeStart);
                            var endLabel = formatTimeFromFloat(meta.timeEnd);
                            var timeLabel = '';
                            if (startLabel || endLabel) {
                                timeLabel = startLabel;
                                if (endLabel) {
                                    timeLabel = startLabel + ' - ' + endLabel;
                                }
                            }

                            setConfirmRow('subject', subjectLabel);
                            setConfirmRow('date', dateLabel);
                            setConfirmRow('time', timeLabel);
                            setConfirmRow('campus', meta.campus || '');
                            setConfirmRow('room', meta.room || '');

                            addConfirmModal.classList.add('is-open');
                        }

                        function closeAddConfirm() {
                            if (!addConfirmModal) {
                                return;
                            }
                            pendingAdd = null;
                            addConfirmModal.classList.remove('is-open');
                        }
                        
                        function addSession(sessionId, weekStart, btn) {
                            console.log('[Portal Student] Sending add request...');
                            
                            fetch('/my/student/agenda/add', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: {
                                        session_id: sessionId,
                                        week_start: weekStart
                                    }
                                })
                            })
                            .then(function(response) {
                                console.log('[Portal Student] Response status:', response.status);
                                return response.json();
                            })
                            .then(function(data) {
                                console.log('[Portal Student] Response data:', data);
                                
                                var result = data.result || data;
                                var rpcError = data.error || (result &amp;&amp; result.error);
                                
                                if (result.status === 'ok') {
                                    showToast('success', result.message || 'Clase agregada correctamente');
                                    setTimeout(function() {
                                        window.location.reload();
                                    }, 800);
                                } else {
                                    var errorMessage = result.message;
                                    if (!errorMessage &amp;&amp; rpcError) {
                                        errorMessage = (rpcError.data &amp;&amp; rpcError.data.message) || rpcError.message;
                                    }
                                    if (!errorMessage &amp;&amp; result.errors &amp;&amp; result.errors.length) {
                                        errorMessage = result.errors[0].message;
                                    }
                                    if (result.no_capacity) {
                                        showToast('warning', errorMessage || 'Esta clase ya no tiene cupos disponibles');
                                    } else {
                                        showToast('error', errorMessage || 'No se pudo agendar la clase');
                                    }
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="fa fa-plus"></i> Agendar';
                                }
                            })
                            .catch(function(error) {
                                console.error('[Portal Student] Error:', error);
                                showToast('error', 'Error al agendar: ' + error.message);
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fa fa-plus"></i> Agendar';
                            });
                        }
                        
                        function removeSession(lineId, btn) {
                            console.log('[Portal Student] Sending remove request...');
                            
                            fetch('/my/student/agenda/remove', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: {
                                        line_id: lineId
                                    }
                                })
                            })
                            .then(function(response) {
                                return response.json();
                            })
                            .then(function(data) {
                                console.log('[Portal Student] Response data:', data);
                                
                                var result = data.result || data;
                                
                                if (result.status === 'ok') {
                                    var toastType = result.warning_type || (result.late_cancel ? 'warning' : 'success');
                                    showToast(toastType, result.message || 'Clase eliminada correctamente');
                                    setTimeout(function() {
                                        window.location.reload();
                                    }, 800);
                                } else {
                                    showToast('error', result.message || 'No se pudo eliminar la clase');
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="fa fa-trash"></i>Cancelar de mi agenda';
                                }
                            })
                            .catch(function(error) {
                                console.error('[Portal Student] Error:', error);
                                showToast('error', 'Error al eliminar: ' + error.message);
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fa fa-trash"></i>Cancelar de mi agenda';
                            });
                        }
                        
                        function openScheduleModal(subjectId, subjectName) {
                            console.log('[Portal Student] Opening schedule modal for subject:', subjectId);
                            
                            var modal = document.getElementById('ps-schedule-modal');
                            var modalTitle = document.getElementById('ps-modal-subject-name');
                            var modalInfo = document.getElementById('ps-modal-subject-info');
                            var sessionsList = document.getElementById('ps-modal-sessions-list');
                            
                            if (!modal || !sessionsList) {
                                console.error('[Portal Student] Modal elements not found');
                                return;
                            }
                            
                            // Actualizar t√≠tulo del modal
                            modalTitle.textContent = subjectName || 'Selecciona un horario';
                            
                            // Leer datos de sesiones desde el script JSON embebido
                            var dataScript = document.getElementById('ps-sessions-data-' + subjectId);
                            var sessions = [];
                            
                            if (dataScript) {
                                try {
                                    sessions = JSON.parse(dataScript.textContent);
                                    console.log('[Portal Student] Loaded ' + sessions.length + ' sessions from JSON');
                                } catch (e) {
                                    console.error('[Portal Student] Error parsing sessions JSON:', e);
                                }
                            }
                            
                            // Limpiar lista de sesiones
                            sessionsList.innerHTML = '';
                            
                            if (sessions.length === 0) {
                                sessionsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;"><i class="fa fa-info-circle" style="font-size: 48px; margin-bottom: 16px; display: block;"></i><p style="font-size: 16px; margin: 0;">No hay horarios disponibles para esta asignatura</p><p style="font-size: 13px; margin: 8px 0 0; opacity: 0.7;">Intenta con otra semana o consulta con tu coordinador acad√©mico.</p></div>';
                                modal.style.display = 'block';
                                document.body.style.overflow = 'hidden';
                                return;
                            }
                            
                            modalInfo.textContent = sessions.length + ' horario' + (sessions.length !== 1 ? 's' : '') + ' disponible' + (sessions.length !== 1 ? 's' : '') + ' esta semana';
                            
                            // Obtener week_start de la p√°gina
                            var weekStartInput = document.querySelector('[data-week-start]');
                            var weekStart = weekStartInput ? weekStartInput.getAttribute('data-week-start') : '';
                            
                            // Crear tarjetas para cada sesi√≥n
                            sessions.forEach(function(session) {
                                var card = document.createElement('div');
                                card.className = 'ps-session-modal-card';
                                card.style.cssText = 'margin-bottom: 16px; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; transition: all 0.2s; cursor: pointer; background: white;';
                                
                                if (session.is_prerequisite) {
                                    card.style.borderColor = '#f59e0b';
                                    card.style.background = 'linear-gradient(135deg, #fef3c7 0%, #ffffff 100%)';
                                } else if (session.is_oral_test) {
                                    card.style.borderColor = '#8b5cf6';
                                    card.style.background = 'linear-gradient(135deg, #f3e8ff 0%, #ffffff 100%)';
                                }
                                
                                var html = '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">';
                                html += '<div style="flex: 1; min-width: 0;">';
                                
                                // Badges
                                if (session.is_prerequisite) {
                                    html += '<span class="ps-pill" style="background: #f59e0b; color: white; font-weight: bold; margin-bottom: 8px; display: inline-block;">PRERREQUISITO</span>';
                                } else if (session.is_oral_test) {
                                    html += '<span class="ps-pill" style="background: #8b5cf6; color: white; font-weight: bold; margin-bottom: 8px; display: inline-block;">üé§ ORAL TEST</span>';
                                }
                                
                                // Fecha y horario
                                var startTime = session.start_time || formatTimeFromFloat(session.time_start);
                                var endTime = session.end_time || formatTimeFromFloat(session.time_end);
                                html += '<p class="ps-eyebrow" style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; margin: 0 0 4px;">' + session.date + '</p>';
                                html += '<h4 style="font-size: 17px; font-weight: 700; color: #1e293b; margin: 0 0 8px;">' + startTime + ' - ' + endTime + '</h4>';
                                
                                // Meta informaci√≥n
                                html += '<p class="ps-session-meta" style="font-size: 13px; color: #64748b; margin: 4px 0;">';
                                html += '<i class="fa fa-users"></i> Grupo: <strong>' + session.group + '</strong> | ';
                                html += '<i class="fa fa-desktop"></i> ' + ((session.delivery_mode === 'presential' || session.delivery_mode === 'presencial') ? 'Presencial' : (session.delivery_mode === 'virtual' ? 'Virtual' : 'H√≠brido'));
                                html += '</p>';
                                
                                html += '<p class="ps-session-meta" style="font-size: 13px; color: #64748b; margin: 4px 0;">';
                                html += '<i class="fa fa-map-marker"></i> ' + session.campus;
                                if (session.subcampus) {
                                    html += ' - ' + session.subcampus;
                                }
                                html += '</p>';
                                
                                if (session.meeting_platform) {
                                    html += '<p class="ps-session-meta" style="font-size: 13px; color: #64748b; margin: 4px 0;">';
                                    html += '<i class="fa fa-video-camera"></i> ' + session.meeting_platform;
                                    html += '</p>';
                                }
                                
                                html += '</div>';
                                
                                // Bot√≥n de agendar
                                html += '<button class="ps-button" style="padding: 10px 20px; font-size: 14px; font-weight: 600; white-space: nowrap; margin-left: 16px;" data-session-id="' + session.id + '" data-action="ps-add-session-modal" data-week-start="' + weekStart + '">';
                                html += '<i class="fa fa-plus"></i> Agendar';
                                html += '</button>';
                                
                                html += '</div>';
                                
                                card.innerHTML = html;
                                
                                // Efectos hover
                                card.addEventListener('mouseenter', function() {
                                    if (!session.is_prerequisite &amp;&amp; !session.is_oral_test) {
                                        card.style.borderColor = '#3b82f6';
                                        card.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.15)';
                                    }
                                });
                                card.addEventListener('mouseleave', function() {
                                    if (!session.is_prerequisite &amp;&amp; !session.is_oral_test) {
                                        card.style.borderColor = '#e2e8f0';
                                        card.style.boxShadow = 'none';
                                    }
                                });
                                
                                // Manejar clic en bot√≥n de agendar
                                var addBtn = card.querySelector('[data-action="ps-add-session-modal"]');
                                if (addBtn) {
                                    addBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        var meta = {
                                            sessionId: String(session.id),
                                            weekStart: weekStart,
                                            subject: session.subject || subjectName || '',
                                            date: session.date || '',
                                            timeStart: session.time_start,
                                            timeEnd: session.time_end,
                                            campus: session.campus || '',
                                            room: session.subcampus || '',
                                            button: addBtn
                                        };
                                        if (addConfirmModal) {
                                            openAddConfirm(meta);
                                            return;
                                        }

                                        addBtn.disabled = true;
                                        addBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Agendando...';
                                        addSession(session.id, weekStart, addBtn);
                                    });
                                }
                                
                                sessionsList.appendChild(card);
                            });
                            
                            // Mostrar modal
                            modal.style.display = 'block';
                            document.body.style.overflow = 'hidden';
                            console.log('[Portal Student] Modal opened with ' + sessions.length + ' sessions');
                        }
                        
                        function closeScheduleModal() {
                            console.log('[Portal Student] Closing schedule modal');
                            var modal = document.getElementById('ps-schedule-modal');
                            if (modal) {
                                modal.style.display = 'none';
                                document.body.style.overflow = 'auto';
                            }
                        }
                        
                        function showToast(type, message) {
                            var container = document.getElementById('ps-agenda-feedback');
                            if (!container) {
                                console.warn('[Portal Student] Toast container not found, using alert');
                                alert(message);
                                return;
                            }
                            
                            container.innerHTML = '';
                            var toast = document.createElement('div');
                            toast.className = 'ps-toast ps-toast-' + type;
                            
                            // Agregar bot√≥n de cerrar
                            var closeBtn = document.createElement('button');
                            closeBtn.textContent = '\u00D7';
                            closeBtn.className = 'ps-toast-close';
                            closeBtn.onclick = function() {
                                if (toast &amp;&amp; toast.parentNode) {
                                    toast.parentNode.removeChild(toast);
                                }
                            };
                            toast.appendChild(closeBtn);
                            
                            // Agregar mensaje
                            var messageText = document.createElement('span');
                            messageText.textContent = message;
                            toast.appendChild(messageText);
                            
                            container.appendChild(toast);
                            
                            console.log('[Portal Student] Toast shown:', type, message);
                        }
                    })();
                </script>
            </t>
        </template>

        <!-- Mi agenda (solo clases agendadas) -->
        <template id="portal_student_my_agenda" name="Portal Student My Agenda">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'my_agenda'"/>
                <t t-set="display_tz" t-value="request.env.user.tz or 'America/Bogota'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <section class="ps-week">
                        <div class="ps-week-head">
                            <div>
                                <h3>Mi agenda semanal</h3>
                                <p class="ps-session-meta">
                                    <i class="fa fa-calendar" aria-hidden="true"></i>
                                    <t t-esc="week.get('monday')"/> - <t t-esc="week.get('sunday')"/>
                                    | <t t-esc="week.get('scheduled_total') or 0"/> clases agendadas
                                </p>
                            </div>
                            <div class="ps-week-nav">
                                <button type="button" class="ps-button ps-button-ghost" data-week-shift="-1" t-att-data-start="week_start_str">
                                    <i class="fa fa-chevron-left"></i> Semana anterior
                                </button>
                                <button type="button" class="ps-button" data-week-shift="1" t-att-data-start="week_start_str">
                                    Siguiente semana <i class="fa fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div id="ps-agenda-feedback"></div>

                        <div class="ps-week-summary ps-week-summary-compact">
                            <div class="ps-status-card ps-status-card-compact">
                                <div class="ps-status-icon ps-status-icon-blue"><i class="fa fa-calendar-check-o"></i></div>
                                <div>
                                    <p class="ps-status-label">SEMANA</p>
                                    <h3 class="ps-status-value">#<t t-esc="week.get('week_number') or 'N/D'"/></h3>
                                    <p class="ps-session-meta">Del <t t-esc="week.get('monday')"/> al <t t-esc="week.get('sunday')"/></p>
                                </div>
                            </div>
                            <div class="ps-status-card ps-status-card-compact">
                                <div class="ps-status-icon ps-status-icon-green"><i class="fa fa-check"></i></div>
                                <div>
                                    <p class="ps-status-label">AGENDADAS</p>
                                    <h3 class="ps-status-value"><t t-esc="week.get('scheduled_total') or 0"/></h3>
                                    <p class="ps-session-meta">Clases ya confirmadas</p>
                                </div>
                            </div>
                        </div>

                        <div class="ps-week-grid ps-week-grid-tight ps-my-agenda-grid">
                            <t t-foreach="agenda_by_day" t-as="day">
                                <div class="ps-week-day">
                                    <div class="ps-week-day-head">
                                        <span class="ps-week-day-name" t-esc="day.get('date').strftime('%A')"/>
                                        <span class="ps-week-day-date" t-esc="day.get('date')"/>
                                    </div>
                                    <div class="ps-week-sessions">
                                        <t t-if="day.get('lines')">
                                            <t t-foreach="day.get('lines')" t-as="line">
                                                <t t-set="line_subject" t-value="line.effective_subject_id or line.session_id.sudo().subject_id"/>
                                                <t t-set="is_prerequisite_line" t-value="line_subject and line_subject.subject_category == 'bcheck'"/>
                                                <div class="ps-week-session ps-my-agenda-card" t-attf-style="#{is_prerequisite_line and 'border-left: 4px solid #f59e0b; background: #fffbeb;' or ''}">
                                                    <div class="ps-my-agenda-head">
                                                        <t t-if="is_prerequisite_line">
                                                            <span class="ps-pill ps-pill-xs ps-pill-warning">PRERREQUISITO</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="ps-pill ps-pill-xs ps-pill-neutral">Clase</span>
                                                        </t>
                                                    </div>
                                                    <div class="ps-my-agenda-title" t-esc="line.student_alias or line_subject.alias or line_subject.name or 'Clase'"/>
                                                    <div class="ps-my-agenda-meta">
                                                        <i class="fa fa-calendar"></i>
                                                        <span t-field="line.start_datetime" t-options='{"widget": "datetime", "format": "dd/MM/yyyy", "tz_name": display_tz}'/>
                                                    </div>
                                                    <div class="ps-my-agenda-meta">
                                                        <i class="fa fa-clock-o"></i>
                                                        <span t-field="line.start_datetime" t-options='{"widget": "datetime", "format": "HH:mm", "tz_name": display_tz, "time_only": True}'/> -
                                                        <span t-field="line.end_datetime" t-options='{"widget": "datetime", "format": "HH:mm", "tz_name": display_tz, "time_only": True}'/>
                                                    </div>
                                                    <div class="ps-my-agenda-meta">
                                                        <i class="fa fa-map-marker"></i>
                                                        <t t-esc="line.campus_id.name if line.campus_id else ''"/>
                                                        <t t-if="line.session_id.subcampus_id">
                                                            <span class="ps-my-agenda-sep">|</span>
                                                            Aula <t t-esc="line.session_id.subcampus_id.name"/>
                                                        </t>
                                                    </div>

                                                    <t t-set="line_join_link" t-value="line.session_id.teacher_meeting_link or line.session_id.meeting_link"/>
                                                    <t t-set="formatted_date" t-value="line.start_datetime.strftime('%d/%m/%Y') if line.start_datetime else 'Sin fecha'"/>
                                                    <t t-set="formatted_time" t-value="(line.start_datetime.strftime('%H:%M') + ' - ' + line.end_datetime.strftime('%H:%M')) if line.start_datetime and line.end_datetime else 'Sin hora'"/>
                                                    <t t-set="campus_name" t-value="line.campus_id.name if line.campus_id else 'Sin sede'"/>
                                                    <div class="ps-my-agenda-actions">
                                                        <a t-if="line_join_link and line.session_id.id in join_allowed_session_ids" class="ps-link" t-att-href="line_join_link" target="_blank">
                                                            Entrar a clase
                                                        </a>
                                                        <button t-elif="line_join_link" type="button" class="ps-button ps-button-ghost ps-button-xs ps-button-disabled" disabled="disabled" title="Disponible 5 min antes y 5 min despu√©s de iniciar">
                                                            <i class="fa fa-lock"></i> Entrar a clase
                                                        </button>
                                                        <button class="ps-button ps-button-ghost" data-action="ps-remove-session"
                                                                t-att-data-line-id="line.id"
                                                                t-att-data-subject-name="line.student_alias or line_subject.alias or line_subject.name or 'Clase'"
                                                                t-att-data-datetime="formatted_date + ' ' + formatted_time"
                                                                t-att-data-campus="campus_name"
                                                                t-att-data-dependent-count="len(dependency_map.get(line.id) or [])"
                                                                t-att-data-dependent-labels="', '.join(dependency_map.get(line.id) or [])"
                                                                t-att-data-is-prerequisite="'true' if is_prerequisite_line else 'false'">
                                                            <i class="fa fa-trash" aria-hidden="true"></i>
                                                            Cancelar
                                                        </button>
                                                    </div>
                                                </div>
                                            </t>
                                        </t>
                                        <t t-else="">
                                            <div class="ps-empty-block ps-empty-compact">
                                                <i class="fa fa-calendar-o" aria-hidden="true"></i>
                                                <p>Sin clases agendadas</p>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </section>
                        </div>

                        <div id="ps-remove-confirm-modal" class="ps-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="ps-remove-confirm-title">
                            <div class="ps-confirm-card">
                                <div class="ps-confirm-head">
                                    <span class="ps-confirm-icon ps-confirm-icon-warning">
                                        <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
                                    </span>
                                    <div>
                                        <h4 id="ps-remove-confirm-title" class="ps-confirm-title">Cancelar B-check</h4>
                                        <p id="ps-remove-confirm-text" class="ps-confirm-text">
                                            Si cancelas este B-check se eliminar√°n todas las dem√°s clases de tu agenda semanal.
                                        </p>
                                    </div>
                                </div>
                                <div class="ps-confirm-subtitle">Impacto</div>
                                <div class="ps-confirm-details">
                                    <div class="ps-confirm-row" data-field="dependents">
                                        <span class="ps-confirm-label">Clases dependientes</span>
                                        <span class="ps-confirm-value" id="ps-remove-confirm-count"></span>
                                    </div>
                                    <div class="ps-confirm-row" data-field="dependents_list">
                                        <span class="ps-confirm-label">Se eliminaran</span>
                                        <span class="ps-confirm-value ps-confirm-list" id="ps-remove-confirm-list"></span>
                                    </div>
                                </div>
                                <div class="ps-confirm-actions">
                                    <button type="button" class="ps-button ps-button-ghost" data-action="ps-remove-cancel">No, conservar</button>
                                    <button type="button" class="ps-button" data-action="ps-remove-confirm">Si, cancelar</button>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de doble confirmaci√≥n para cancelar clases normales -->
                        <div id="ps-cancel-class-modal" class="ps-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="ps-cancel-class-title">
                            <div class="ps-confirm-card">
                                <div class="ps-confirm-head">
                                    <span class="ps-confirm-icon ps-confirm-icon-warning">
                                        <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
                                    </span>
                                    <div>
                                        <h4 id="ps-cancel-class-title" class="ps-confirm-title">¬øEst√°s seguro de cancelar esta clase?</h4>
                                        <p class="ps-confirm-text">
                                            Esta acci√≥n eliminar√° la clase de tu agenda semanal. Podr√°s volver a agendarla si hay cupos disponibles.
                                        </p>
                                    </div>
                                </div>
                                <div class="ps-confirm-subtitle">Detalles de la clase</div>
                                <div class="ps-confirm-details">
                                    <div class="ps-confirm-row">
                                        <span class="ps-confirm-label">Clase</span>
                                        <span class="ps-confirm-value" id="ps-cancel-class-subject"></span>
                                    </div>
                                    <div class="ps-confirm-row">
                                        <span class="ps-confirm-label">Fecha y hora</span>
                                        <span class="ps-confirm-value" id="ps-cancel-class-datetime"></span>
                                    </div>
                                    <div class="ps-confirm-row">
                                        <span class="ps-confirm-label">Sede</span>
                                        <span class="ps-confirm-value" id="ps-cancel-class-campus"></span>
                                    </div>
                                </div>
                                <div class="ps-confirm-actions">
                                    <button type="button" class="ps-button ps-button-ghost" data-action="ps-cancel-class-no">No, mantener clase</button>
                                    <button type="button" class="ps-button ps-button-danger" data-action="ps-cancel-class-yes">S√≠, cancelar clase</button>
                                </div>
                            </div>
                        </div>

                <script type="text/javascript">
                    (function() {
                        'use strict';

                        var removeConfirmModal = document.getElementById('ps-remove-confirm-modal');
                        var pendingRemove = null;
                        var removeConfirmTitle = removeConfirmModal ? removeConfirmModal.querySelector('#ps-remove-confirm-title') : null;
                        var removeConfirmText = removeConfirmModal ? removeConfirmModal.querySelector('#ps-remove-confirm-text') : null;
                        var removeConfirmCount = removeConfirmModal ? removeConfirmModal.querySelector('#ps-remove-confirm-count') : null;
                        var removeConfirmList = removeConfirmModal ? removeConfirmModal.querySelector('#ps-remove-confirm-list') : null;
                        var removeConfirmCountRow = removeConfirmModal ? removeConfirmModal.querySelector('[data-field="dependents"]') : null;
                        var removeConfirmListRow = removeConfirmModal ? removeConfirmModal.querySelector('[data-field="dependents_list"]') : null;

                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', initMyAgenda);
                        } else {
                            initMyAgenda();
                        }

                        function initMyAgenda() {
                            if (removeConfirmModal) {
                                var confirmRemoveBtn = removeConfirmModal.querySelector('[data-action="ps-remove-confirm"]');
                                var cancelRemoveBtn = removeConfirmModal.querySelector('[data-action="ps-remove-cancel"]');
                                if (confirmRemoveBtn) {
                                    confirmRemoveBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        if (!pendingRemove) {
                                            closeRemoveConfirm();
                                            return;
                                        }
                                        var btn = pendingRemove.button;
                                        if (btn) {
                                            btn.disabled = true;
                                            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Cancelando...';
                                        }
                                        var lineId = pendingRemove.lineId;
                                        closeRemoveConfirm();
                                        removeSession(lineId, btn);
                                    });
                                }
                                if (cancelRemoveBtn) {
                                    cancelRemoveBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        closeRemoveConfirm();
                                    });
                                }
                                removeConfirmModal.addEventListener('click', function(e) {
                                    if (e.target === removeConfirmModal) {
                                        closeRemoveConfirm();
                                    }
                                });
                            }

                            var removeButtons = document.querySelectorAll('[data-action="ps-remove-session"]');
                            removeButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    var lineId = btn.getAttribute('data-line-id');
                                    if (!lineId) {
                                        return;
                                    }
                                    var dependentCount = parseInt(btn.getAttribute('data-dependent-count') || '0', 10);
                                    var dependentLabels = btn.getAttribute('data-dependent-labels') || '';
                                    var subjectName = btn.getAttribute('data-subject-name') || 'Esta clase';
                                    var dateTime = btn.getAttribute('data-datetime') || '';
                                    var campus = btn.getAttribute('data-campus') || '';
                                    
                                    // Si tiene dependientes (ej: B-check con skills), mostrar modal de prerrequisito
                                    if (removeConfirmModal &amp;&amp; dependentCount > 0) {
                                        openRemoveConfirm({
                                            lineId: lineId,
                                            dependentCount: dependentCount,
                                            dependentLabels: dependentLabels,
                                            button: btn
                                        });
                                        return;
                                    }
                                    
                                    // Para clases normales (sin dependientes), mostrar modal de confirmaci√≥n simple
                                    var cancelClassModal = document.getElementById('ps-cancel-class-modal');
                                    if (cancelClassModal) {
                                        openCancelClassConfirm({
                                            lineId: lineId,
                                            subjectName: subjectName,
                                            dateTime: dateTime,
                                            campus: campus,
                                            button: btn
                                        });
                                        return;
                                    }
                                    
                                    // Fallback: cancelar sin confirmaci√≥n (no deber√≠a llegar aqu√≠)
                                    btn.disabled = true;
                                    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Cancelando...';
                                    removeSession(lineId, btn);
                                });
                            });

                            var weekNavButtons = document.querySelectorAll('[data-week-shift]');
                            weekNavButtons.forEach(function(btn) {
                                btn.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    var shift = parseInt(btn.getAttribute('data-week-shift') || '0', 10);
                                    var start = btn.getAttribute('data-start');
                                    if (!start) {
                                        return;
                                    }
                                    var currentDate = new Date(start);
                                    currentDate.setDate(currentDate.getDate() + (shift * 7));
                                    var newStart = currentDate.toISOString().slice(0, 10);
                                    var url = new URL(window.location.href);
                                    url.searchParams.set('start', newStart);
                                    btn.disabled = true;
                                    btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Cargando...';
                                    window.location.href = url.toString();
                                });
                            });

                            // Inicializar modal de cancelaci√≥n de clases normales
                            cancelClassModal = document.getElementById('ps-cancel-class-modal');
                            if (cancelClassModal) {
                                var confirmCancelBtn = cancelClassModal.querySelector('[data-action="ps-cancel-class-yes"]');
                                var cancelCancelBtn = cancelClassModal.querySelector('[data-action="ps-cancel-class-no"]');
                                
                                if (confirmCancelBtn) {
                                    confirmCancelBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        if (pendingCancelClass) {
                                            var btn = pendingCancelClass.button;
                                            var lineId = pendingCancelClass.lineId;
                                            closeCancelClassConfirm();
                                            btn.disabled = true;
                                            btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Cancelando...';
                                            removeSession(lineId, btn);
                                        }
                                    });
                                }
                                
                                if (cancelCancelBtn) {
                                    cancelCancelBtn.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        closeCancelClassConfirm();
                                    });
                                }
                                
                                cancelClassModal.addEventListener('click', function(e) {
                                    if (e.target === cancelClassModal) {
                                        closeCancelClassConfirm();
                                    }
                                });
                            }
                        }

                        function openRemoveConfirm(meta) {
                            if (!removeConfirmModal) {
                                return;
                            }
                            pendingRemove = meta;
                            var count = meta.dependentCount || 0;
                            var label = count === 1 ? '1 clase' : (count + ' clases');
                            if (removeConfirmTitle) {
                                removeConfirmTitle.textContent = 'Cancelar B-check y clases dependientes';
                            }
                            if (removeConfirmText) {
                                removeConfirmText.textContent = '‚ö†Ô∏è Al cancelar el B-check tambi√©n se eliminar√°n autom√°ticamente ' + label + ' dependiente(s), ya que el B-check es un prerrequisito obligatorio para todas las dem√°s clases de la semana.';
                            }
                            if (removeConfirmCount) {
                                removeConfirmCount.textContent = label;
                            }
                            if (removeConfirmList) {
                                removeConfirmList.textContent = meta.dependentLabels || '';
                            }
                            if (removeConfirmCountRow) {
                                removeConfirmCountRow.classList.toggle('is-hidden', count &lt;= 0);
                            }
                            if (removeConfirmListRow) {
                                removeConfirmListRow.classList.toggle('is-hidden', !meta.dependentLabels);
                            }
                            removeConfirmModal.classList.add('is-open');
                        }

                        function closeRemoveConfirm() {
                            pendingRemove = null;
                            if (removeConfirmModal) {
                                removeConfirmModal.classList.remove('is-open');
                            }
                        }

                        // Variables para el modal de cancelaci√≥n de clases normales
                        var cancelClassModal = null;
                        var pendingCancelClass = null;

                        function openCancelClassConfirm(meta) {
                            if (!cancelClassModal) {
                                cancelClassModal = document.getElementById('ps-cancel-class-modal');
                            }
                            if (!cancelClassModal) {
                                console.error('[Portal Student] Modal de cancelaci√≥n no encontrado');
                                return;
                            }
                            pendingCancelClass = meta;
                            
                            // Actualizar informaci√≥n en el modal
                            var subjectEl = cancelClassModal.querySelector('#ps-cancel-class-subject');
                            var dateTimeEl = cancelClassModal.querySelector('#ps-cancel-class-datetime');
                            var campusEl = cancelClassModal.querySelector('#ps-cancel-class-campus');
                            
                            if (subjectEl) subjectEl.textContent = meta.subjectName || '‚Äî';
                            if (dateTimeEl) dateTimeEl.textContent = meta.dateTime || '‚Äî';
                            if (campusEl) campusEl.textContent = meta.campus || '‚Äî';
                            
                            cancelClassModal.classList.add('is-open');
                        }

                        function closeCancelClassConfirm() {
                            pendingCancelClass = null;
                            if (cancelClassModal) {
                                cancelClassModal.classList.remove('is-open');
                            }
                        }

                        function removeSession(lineId, btn) {
                            fetch('/my/student/agenda/remove', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'call',
                                    params: {
                                        line_id: lineId
                                    }
                                })
                            })
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                var result = data.result || data;
                                if (result.status === 'ok') {
                                    var toastType = result.warning_type || (result.late_cancel ? 'warning' : 'success');
                                    showToast(toastType, result.message || 'Clase eliminada correctamente');
                                    setTimeout(function() {
                                        window.location.reload();
                                    }, 800);
                                } else {
                                    showToast('error', result.message || 'No se pudo eliminar la clase');
                                    btn.disabled = false;
                                    btn.innerHTML = '<i class="fa fa-trash"></i> Cancelar';
                                }
                            })
                            .catch(function(error) {
                                showToast('error', 'Error al eliminar: ' + error.message);
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fa fa-trash"></i> Cancelar';
                            });
                        }

                        function showToast(type, message) {
                            var container = document.getElementById('ps-agenda-feedback');
                            if (!container) {
                                alert(message);
                                return;
                            }
                            container.innerHTML = '';
                            var toast = document.createElement('div');
                            toast.className = 'ps-toast ps-toast-' + type;
                            var closeBtn = document.createElement('button');
                            closeBtn.textContent = '\u00D7';
                            closeBtn.className = 'ps-toast-close';
                            closeBtn.onclick = function() {
                                if (toast &amp;&amp; toast.parentNode) {
                                    toast.parentNode.removeChild(toast);
                                }
                            };
                            toast.appendChild(closeBtn);
                            var messageText = document.createElement('span');
                            messageText.textContent = message;
                            toast.appendChild(messageText);
                            container.appendChild(toast);
                        }
                    })();
                </script>
            </t>
        </template>

        <!-- Estructura acad√©mica -->
        <template id="portal_student_program" name="Portal Student Program">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'program'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <section class="ps-hero-block ps-hero-block-blue">
                        <div>
                            <p class="ps-eyebrow">Programa Acad√©mico</p>
                            <h2>Mi Programa de Estudio</h2>
                        </div>
                    </section>
                    <section class="ps-program-card">

                        <t t-if="structure">
                            <div class="ps-program-grid">
                                <t t-foreach="structure" t-as="block">
                                    <div class="ps-program-item">
                                        <div class="ps-program-banner">
                                            <div>
                                                <p class="ps-eyebrow">Programa</p>
                                                <h4 t-esc="block.get('program').name"/>
                                                <p class="ps-session-meta">C√≥digo <t t-esc="block.get('program').code"/></p>
                                            </div>
                                        </div>
                                        <div class="ps-program-body">
                                            <t t-foreach="block.get('plans')" t-as="plan_block">
                                                <div class="ps-plan-card">
                                                    <div class="ps-plan-head">
                                                        <div>
                                                            <h5 t-esc="plan_block.get('plan').name"/>
                                                            <p class="ps-session-meta" t-esc="plan_block.get('plan').description or ''"/>
                                                        </div>
                                                        <span class="ps-pill ps-pill-info">Plan Asignado</span>
                                                    </div>
                                                    <div class="ps-plan-body">
                                                        <t t-foreach="plan_block.get('phases')" t-as="phase_block">
                                                            <div class="ps-phase-card">
                                                                <div class="ps-phase-head">
                                                                    <span class="ps-pill">Fase</span>
                                                                    <strong t-esc="phase_block.get('phase').name"/>
                                                                </div>
                                                                <t t-foreach="phase_block.get('levels')" t-as="level_block">
                                                                    <div class="ps-level-card">
                                                                        <div class="ps-level-head">
                                                                            <span class="ps-pill ps-pill-soft">Nivel</span>
                                                                            <strong t-esc="level_block.get('level').name"/>
                                                                        </div>
                                                                        
                                                                        <!-- Mostrar modalidad si hay asignaturas matriculadas -->
                                                                        <t t-if="level_block.get('subject_details')">
                                                                            <t t-set="has_enrollments" t-value="any(s.get('enrollment') for s in level_block.get('subject_details'))"/>
                                                                            
                                                                            <t t-if="has_enrollments">
                                                                                <t t-set="delivery_modes" t-value="set([s['delivery_mode'] for s in level_block.get('subject_details') if s['delivery_mode']])"/>
                                                                                <t t-if="delivery_modes">
                                                                                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px;">
                                                                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                                                            <i class="fa fa-desktop" style="color: #64748b;"></i>
                                                                                            <span style="font-weight: 600; color: #334155;">Modalidad:</span>
                                                                                            <t t-foreach="delivery_modes" t-as="mode">
                                                                                                <span class="ps-pill ps-pill-xs" style="margin-left: 0.25rem;">
                                                                                                    <t t-if="mode in ['presential', 'presencial']">Presencial</t>
                                                                                                    <t t-elif="mode == 'virtual'">Virtual</t>
                                                                                                    <t t-elif="mode == 'hybrid'">H√≠brido</t>
                                                                                                </span>
                                                                                            </t>
                                                                                        </div>
                                                                                    </div>
                                                                                </t>
                                                                            </t>
                                                                            <t t-else="">
                                                                                <!-- Mostrar modalidad preferida del estudiante si no hay matr√≠culas -->
                                                                                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                                                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                                                        <i class="fa fa-info-circle" style="color: #3b82f6;"></i>
                                                                                        <span style="font-weight: 600; color: #1e40af;">Informaci√≥n del Programa:</span>
                                                                                    </div>
                                                                                    <p style="margin: 0.5rem 0 0; color: #1e40af; font-size: 0.9rem;">
                                                                                        Este es tu programa asignado. Para ver el detalle de asignaturas y horarios espec√≠ficos, necesitas matricularte en al menos una asignatura.
                                                                                    </p>
                                                                                    <div style="margin-top: 0.5rem;">
                                                                                        <span style="font-weight: 600; color: #1e40af;">Modalidad Preferida:</span>
                                                                                        <span class="ps-pill ps-pill-xs" style="margin-left: 0.25rem; background: #3b82f6; color: white;">
                                                                                            <t t-if="student.preferred_delivery_mode == 'virtual'">Virtual</t>
                                                                                            <t t-elif="student.preferred_delivery_mode == 'hybrid'">H√≠brido</t>
                                                                                            <t t-else="">Presencial</t>
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                            </t>
                                                                        </t>
                                                                    </div>
                                                                </t>
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="ps-empty-block" style="padding: 4rem 2rem; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.9;">
                                    <i class="fa fa-graduation-cap" aria-hidden="true"></i>
                                </div>
                                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: white;">No hay programa asignado</h3>
                                <p style="font-size: 1.1rem; opacity: 0.95; max-width: 500px; margin: 0 auto; line-height: 1.6;">
                                    A√∫n no tienes un programa acad√©mico asignado o no hay matr√≠culas activas. Por favor contacta al equipo acad√©mico para obtener informaci√≥n sobre tu programa de estudio.
                                </p>
                                <div style="margin-top: 2rem;">
                                    <a href="/my/student/agenda" class="btn btn-light" style="padding: 0.75rem 2rem; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-block; margin-right: 1rem;">
                                        <i class="fa fa-calendar" aria-hidden="true"></i> Ver Horarios
                                    </a>
                                    <a href="/my/student/info" class="btn btn-outline-light" style="padding: 0.75rem 2rem; border: 2px solid white; border-radius: 8px; font-weight: 600; text-decoration: none; display: inline-block; color: white;">
                                        <i class="fa fa-user" aria-hidden="true"></i> Mi Informaci√≥n
                                    </a>
                                </div>
                            </div>
                        </t>
                    </section>
                </div>
            </t>
        </template>

        <!-- Recursos -->
        <template id="portal_student_resources" name="Portal Student Resources">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'resources'"/>
                <t t-set="display_tz" t-value="request.env.user.tz or 'America/Bogota'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <section class="ps-hero-block ps-hero-block-blue">
                        <div>
                            <p class="ps-eyebrow">Recursos</p>
                            <h2>Enlaces de clase y materiales</h2>
                        </div>
                    </section>
                    <div class="ps-resources">
                        <t t-if="resources">
                            <div class="ps-resource-stack">
                                <t t-foreach="resources" t-as="res">
                                    <div class="ps-resource-card">
                                        <div class="ps-resource-card-head">
                                            <div>
                                                <h4 t-esc="(res.get('subject').alias or res.get('subject').name) if res.get('subject') else res.get('group').name"/>
                                                <p class="ps-session-meta" t-if="res.get('group')">Grupo: <t t-esc="res.get('group').name"/></p>
                                                <p class="ps-session-meta" t-if="res.get('campus')">Sede: <t t-esc="res.get('campus').name"/></p>
                                            </div>
                                            <span class="ps-chip-secondary"><i class="fa fa-folder-open"></i> Recursos</span>
                                        </div>

                                        <!-- Solo mostrar el bloque de clase virtual para modalidades virtual e h√≠brida -->
                                        <t t-if="res.get('delivery_mode') in ['virtual', 'hybrid']">
                                            <div class="ps-resource-block">
                                                <div class="ps-resource-block-head">
                                                    <i class="fa fa-play-circle-o" aria-hidden="true"></i>
                                                    <span>Clase virtual</span>
                                                    <span class="ps-pill-soft" t-if="res.get('meeting_platform')" t-esc="res.get('meeting_platform')"/>
                                                </div>
                                                <div class="ps-resource-block-body">
                                                    <t t-if="res.get('meeting_link') and res.get('join_allowed')">
                                                        <p class="ps-session-meta" t-if="res.get('next_session')">Pr√≥xima:
                                                            <span t-field="res.get('next_session').datetime_start" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/>
                                                        </p>
                                                        <a class="ps-button" t-att-href="res.get('meeting_link')" target="_blank">Entrar a la clase</a>
                                                    </t>
                                                    <t t-elif="res.get('meeting_link')">
                                                        <p class="ps-session-meta" t-if="res.get('next_session')">Pr√≥xima:
                                                            <span t-field="res.get('next_session').datetime_start" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/>
                                                        </p>
                                                        <button type="button" class="ps-button ps-button-ghost ps-button-xs ps-button-disabled" disabled="disabled" title="Disponible 5 min antes y 5 min despu√©s de iniciar">
                                                            <i class="fa fa-lock"></i> Entrar a la clase
                                                        </button>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="ps-tag-warning"><i class="fa fa-clock-o"></i> Enlace pendiente</span>
                                                        <p class="ps-session-meta" t-if="not res.get('next_session')">Sin horario publicado</p>
                                                    </t>
                                                </div>
                                            </div>
                                        </t>

                        <div class="ps-resource-block ps-resource-materials">
                            <div class="ps-resource-block-head">
                                <i class="fa fa-archive" aria-hidden="true"></i>
                                <span>Materiales</span>
                            </div>
                            <div class="ps-resource-block-body">
                                <t t-if="res.get('materials')">
                                    <ul class="ps-list">
                                        <t t-foreach="res.get('materials')" t-as="mat">
                                            <li>
                                                <i class="fa fa-link"></i>
                                                <a class="ps-link" t-att-href="mat.get('url')" target="_blank">
                                                    <t t-esc="mat.get('name') or mat.get('url')"/>
                                                </a>
                                            </li>
                                        </t>
                                    </ul>
                                </t>
                                <t t-else="">
                                    <p class="ps-session-meta">Aun no hay recursos publicados para esta asignatura.</p>
                                </t>
                            </div>
                        </div>
                    </div>
                </t>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="ps-empty-block">
                                <i class="fa fa-info-circle" aria-hidden="true"></i>
                                <p>No hay recursos disponibles.</p>
                            </div>
                        </t>
                    </div>
                </div>
            </t>
        </template>

        <!-- Estado acad√©mico -->
<template id="portal_student_status" name="Portal Student Status">
    <t t-call="portal.portal_layout">
        <t t-set="page_name" t-value="'status'"/>
        <t t-set="display_tz" t-value="request.env.user.tz or 'America/Bogota'"/>
        <t t-call="portal_student.portal_student_header"/>
        <div class="ps-shell">
            <section class="ps-hero-block ps-hero-block-blue">
                <div>
                    <h2><i class="fa fa-star"></i> Estado acad√©mico</h2>
                    <p>Revisa tu asistencia consolidada y el promedio general de tus asignaturas.</p>
                </div>
                <div class="ps-code-badge">
                    <span>C√≥digo:</span>
                    <strong t-esc="student.code or 'N/D'"/>
                </div>
            </section>

            <div class="ps-status-grid">
                <div class="ps-status-card">
                    <div class="ps-status-icon ps-status-icon-green"><i class="fa fa-check-circle"></i></div>
                    <div>
                        <p class="ps-status-label">Matr√≠culas</p>
                        <h3 class="ps-status-value"><t t-esc="stats.get('total_enrollments')"/></h3>
                        <p class="ps-session-meta">Activas: <t t-esc="stats.get('active_enrollments')"/></p>
                    </div>
                </div>
                <div class="ps-status-card">
                    <div class="ps-status-icon ps-status-icon-blue"><i class="fa fa-line-chart"></i></div>
                    <div>
                        <p class="ps-status-label">Promedio general</p>
                        <h3 class="ps-status-value">
                            <t t-if="stats.get('avg_grade')"><t t-esc="stats.get('avg_grade')"/></t>
                            <t t-else="">N/D</t>
                        </h3>
                        <p class="ps-session-meta">Progreso: <t t-esc="(str(stats.get('progress')) + '%') if stats.get('progress') else '0%'"/></p>
                    </div>
                </div>
                <div class="ps-status-card">
                    <div class="ps-status-icon ps-status-icon-orange"><i class="fa fa-clock-o"></i></div>
                    <div>
                        <p class="ps-status-label">Pendientes</p>
                        <h3 class="ps-status-value">0</h3>
                        <p class="ps-session-meta">Pr√≥ximas sesiones o actividades</p>
                    </div>
                </div>
            </div>
        </div>
    </t>
</template>

        <!-- Estado acad√©mico por asignatura (TPE16) -->
        <template id="portal_student_academic" name="Portal Student Academic">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'academic'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <section class="ps-hero-block ps-hero-block-blue">
                        <div>
                            <p class="ps-eyebrow">Estado acad√©mico</p>
                            <h2>Asistencias y calificaciones por asignatura</h2>
                        </div>
                        <div class="ps-code-badge">
                            <span>C√≥digo:</span>
                            <strong t-esc="student.code or 'N/D'"/>
                        </div>
                    </section>

                    <section class="ps-card">
                        <div class="ps-card-head">
                            <div>
                                <p class="ps-eyebrow">Resumen</p>
                                <h3>Asistencias y notas</h3>
                            </div>
                            <div class="ps-status-icon ps-status-icon-blue">
                                <i class="fa fa-line-chart"></i>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr>
                                        <th>Asignatura</th>
                                        <th>Nivel / Fase</th>
                                        <th>Sede</th>
                                        <th>Modalidad</th>
                                        <th>Asistencia</th>
                                        <th>Faltas</th>
                                        <th>Nota final</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-if="enrollments_data">
                                        <t t-foreach="enrollments_data" t-as="row">
                                            <tr>
                                                <td>
                                                    <strong t-esc="row.get('subject_label') or 'Asignatura'"/>
                                                    <div class="ps-session-meta" t-if="row.get('program')">
                                                        <t t-esc="row.get('program').name"/>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div t-if="row.get('level')" t-esc="row.get('level').name"/>
                                                    <div class="ps-session-meta" t-if="row.get('phase')">
                                                        <t t-esc="row.get('phase').name"/>
                                                    </div>
                                                </td>
                                                <td>
                                                    <t t-if="row.get('campus')"><t t-esc="row.get('campus').name"/></t>
                                                    <t t-else=""><em style="color:#94a3b8;">N/A</em></t>
                                                </td>
                                                <td>
                                                    <span class="ps-pill ps-pill-xs">
                                                        <t t-if="row.get('delivery_mode') in ['presential', 'presencial']">Presencial</t>
                                                        <t t-elif="row.get('delivery_mode') == 'virtual'">Virtual</t>
                                                        <t t-elif="row.get('delivery_mode') == 'hybrid'">H√≠brido</t>
                                                        <t t-else="">N/A</t>
                                                    </span>
                                                </td>
                                                <td>
                                                    <t t-if="row.get('attendance') is not False">
                                                        <t t-esc="row.get('attendance')"/>%
                                                    </t>
                                                    <t t-else=""><em style="color:#94a3b8;">N/D</em></t>
                                                </td>
                                                <td>
                                                    <t t-if="row.get('absences') not in [False, None]">
                                                        <t t-esc="row.get('absences')"/>
                                                    </t>
                                                    <t t-else=""><em style="color:#94a3b8;">N/D</em></t>
                                                </td>
                                                <td>
                                                    <t t-if="row.get('final_grade') not in [False, None]">
                                                        <t t-esc="row.get('final_grade')"/>
                                                    </t>
                                                    <t t-else=""><em style="color:#94a3b8;">N/D</em></t>
                                                </td>
                                                <td>
                                                    <span class="ps-pill ps-pill-soft" t-att-class="'ps-pill-' + ('green' if row.get('state') in ['enrolled','in_progress'] else 'gray')">
                                                        <t t-if="row.get('state') == 'enrolled'">Matriculado</t>
                                                        <t t-elif="row.get('state') == 'in_progress'">En curso</t>
                                                        <t t-elif="row.get('state') == 'completed'">Completado</t>
                                                        <t t-else=""><t t-esc="row.get('state') or 'N/D'"/></t>
                                                    </span>
                                                </td>
                                            </tr>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <tr>
                                            <td colspan="9" style="text-align:center; color:#94a3b8;">
                                                No hay matr√≠culas con informaci√≥n acad√©mica disponible.
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </t>
        </template>

        <template id="portal_student_data" name="Portal Student Data">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'data'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <section class="ps-grid">
                        <div class="ps-card ps-card-highlight ps-card-wide">
                            <div class="ps-card-head">
                                <p class="ps-eyebrow">Datos generales</p>
                                <h3>Tu perfil en Benglish</h3>
                                <div class="ps-list ps-list-inline">
                                    <span class="ps-pill" t-if="profile_state.get('estado')">
                                        <i class="fa fa-shield"></i>
                                        <t t-esc="profile_state.get('estado')"/>
                                    </span>
                                    <span class="ps-pill" t-if="student.preferred_campus_id">Sede: <t t-esc="student.preferred_campus_id.name"/></span>
                                    <span class="ps-pill" t-if="student.preferred_delivery_mode">Modalidad: <t t-esc="student.preferred_delivery_mode"/></span>
                                </div>
                            </div>
                            <p class="ps-subtitle" t-if="profile_state.get('mensaje')">
                                <t t-esc="profile_state.get('mensaje')"/>
                            </p>
                        </div>

                        <div class="ps-card">
                            <div class="ps-card-head">
                                <p class="ps-eyebrow">Perfil</p>
                                <h3>Datos personales</h3>
                            </div>
                            <ul class="ps-list">
                                <li>
                                    <p class="ps-list-title">Nombre</p>
                                    <p class="ps-session-meta"><t t-esc="student.name"/></p>
                                </li>
                                <li>
                                    <p class="ps-list-title">C√≥digo</p>
                                    <p class="ps-session-meta"><t t-esc="student.code or 'N/D'"/></p>
                                </li>
                                <li t-if="student.email">
                                    <p class="ps-list-title">Correo</p>
                                    <p class="ps-session-meta"><t t-esc="student.email"/></p>
                                </li>
                                <li>
                                    <p class="ps-list-title">Telefono</p>
                                    <p class="ps-session-meta">
                                        <t t-esc="student.mobile or student.phone or 'Sin tel√©fono'"/>
                                    </p>
                                </li>
                                <li>
                                    <p class="ps-list-title">Ciudad</p>
                                    <p class="ps-session-meta">
                                        <t t-esc="student.city or 'Sin ciudad'"/>
                                        <t t-if="student.country_id">, <t t-esc="student.country_id.name"/></t>
                                    </p>
                                </li>
                            </ul>
                        </div>

                        <div class="ps-card">
                            <div class="ps-card-head">
                                <p class="ps-eyebrow">Matricula</p>
                                <h3>Curso y grupo (solo lectura)</h3>
                            </div>
                            <t t-set="active" t-value="active_enrollment and active_enrollment[0] or False"/>
                            <t t-if="active">
                                <ul class="ps-list">
                                    <li>
                                        <p class="ps-list-title">Programa / Plan</p>
                                        <p class="ps-session-meta">
                                            <t t-esc="active.program_id.name or 'Sin programa'"/> |
                                            <t t-esc="active.plan_id.name or 'Sin plan'"/>
                                        </p>
                                    </li>
                                    <li>
                                        <p class="ps-list-title">Fase / Nivel / Asignatura</p>
                                        <p class="ps-session-meta">
                                            <t t-esc="active.phase_id.name or 'Sin fase'"/> |
                                            <t t-esc="active.level_id.name or 'Sin nivel'"/> |
                                            <t t-esc="active.subject_id.alias or active.subject_id.name or 'Sin asignatura'"/>
                                        </p>
                                    </li>
                                    <li>
                                        <p class="ps-list-title">Grupo y sede</p>
                                        <p class="ps-session-meta">
                                            <t t-esc="active.group_id.name or 'Sin grupo'"/> |
                                            <t t-esc="active.campus_id.name or 'Sin sede'"/>
                                        </p>
                                    </li>
                                    <li>
                                        <p class="ps-list-title">Modalidad</p>
                                        <p class="ps-session-meta">
                                            <t t-esc="active.delivery_mode"/>
                                        </p>
                                    </li>
                                    <li>
                                        <p class="ps-list-title">Estado y fechas</p>
                                        <p class="ps-session-meta">
                                            <t t-esc="active.state"/> |
                                            Inicio <t t-esc="active.start_date"/> - Fin <t t-esc="active.end_date"/>
                                        </p>
                                    </li>
                                </ul>
                            </t>
                            <t t-else="">
                                <p class="ps-session-meta">No encontramos una matr√≠cula activa.</p>
                            </t>
                        </div>

                        <div class="ps-card">
                            <div class="ps-card-head">
                                <p class="ps-eyebrow">Horarios publicados</p>
                                <h3>Pr√≥ximas clases</h3>
                            </div>
                            <t t-if="next_sessions">
                                <ul class="ps-list">
                                    <t t-foreach="next_sessions" t-as="ses">
                                        <li>
                                            <p class="ps-list-title"><t t-esc="ses.student_alias or ses.subject_id.alias or ses.subject_id.name or 'Clase'"/></p>
                                            <p class="ps-session-meta">
                                                <i class="fa fa-calendar"></i>
                                                <t t-esc="ses.date"/>
                                                <t t-if="ses.datetime_start"> -
                                                    <span t-field="ses.datetime_start" t-options='{"widget": "datetime", "format": "HH:mm", "tz_name": display_tz, "time_only": True}'/>
                                                </t>
                                            </p>
                                            <p class="ps-session-meta">
                                                <t t-esc="ses.campus_id.name if ses.campus_id else ''"/>
                                                <t t-if="ses.delivery_mode"> | <t t-esc="ses.delivery_mode"/></t>
                                            </p>
                                        </li>
                                    </t>
                                </ul>
                            </t>
                            <t t-else="">
                                <p class="ps-session-meta">No hay horarios publicados esta semana.</p>
                            </t>
                        </div>

                        <div class="ps-card">
                            <div class="ps-card-head">
                                <p class="ps-eyebrow">Recursos</p>
                                <h3>Enlaces directos</h3>
                            </div>
                            <t t-if="resources">
                                <ul class="ps-list">
                                    <t t-foreach="resources" t-as="res">
                                        <t t-set="session" t-value="res.get('next_session')"/>
                                        <li>
                                            <p class="ps-list-title">
                                                <t t-esc="(res.get('subject').alias or res.get('subject').name) if res.get('subject') else 'Sin asignatura'"/>
                                            </p>
                                            <p class="ps-session-meta">
                                                <t t-esc="res.get('group').name if res.get('group') else 'Grupo'"/> |
                                                <t t-esc="res.get('campus').name if res.get('campus') else 'Sede'"/>
                                            </p>
                                            <p class="ps-session-meta" t-if="session">
                                                Pr√≥xima:
                                                <span t-field="session.datetime_start" t-options='{"widget": "datetime", "format": "yyyy-MM-dd HH:mm", "tz_name": display_tz}'/>
                                                (<t t-esc="session.delivery_mode"/>)
                                            </p>
                                            <!-- Solo mostrar enlace para clases virtuales e h√≠bridas -->
                                            <t t-if="res.get('delivery_mode') in ['virtual', 'hybrid']">
                                                <p class="ps-session-meta" t-if="res.get('meeting_link') and res.get('join_allowed')">
                                                    <a class="ps-link" t-att-href="res.get('meeting_link')" target="_blank">
                                                        Abrir enlace en <t t-esc="res.get('meeting_platform') or 'plataforma'"/>
                                                    </a>
                                                </p>
                                                <p class="ps-session-meta" t-elif="res.get('meeting_link')">
                                                    <button type="button" class="ps-button ps-button-ghost ps-button-xs ps-button-disabled" disabled="disabled" title="Disponible 5 min antes y 5 min despu√©s de iniciar">
                                                        <i class="fa fa-lock"></i> Abrir enlace
                                                    </button>
                                                </p>
                                            </t>
                                        </li>
                                    </t>
                                </ul>
                            </t>
                            <t t-else="">
                                <p class="ps-session-meta">No hay enlaces publicados para tus clases activas.</p>
                            </t>
                        </div>

                        <div class="ps-card ps-card-wide">
                            <div class="ps-card-head">
                                <p class="ps-eyebrow">Estado acad√©mico</p>
                                <h3>Indicadores r√°pidos</h3>
                            </div>
                            <div class="ps-status-grid">
                                <div class="ps-status-card">
                                    <div class="ps-status-icon ps-status-icon-green"><i class="fa fa-check-circle"></i></div>
                                    <div>
                                        <p class="ps-status-label">Matriculas</p>
                                        <h3 class="ps-status-value"><t t-esc="stats.get('total_enrollments')"/></h3>
                                        <p class="ps-session-meta">Activas: <t t-esc="stats.get('active_enrollments')"/></p>
                                    </div>
                                </div>
                                <div class="ps-status-card">
                                    <div class="ps-status-icon ps-status-icon-blue"><i class="fa fa-line-chart"></i></div>
                                    <div>
                                        <p class="ps-status-label">Promedio</p>
                                        <h3 class="ps-status-value">
                                            <t t-if="stats.get('avg_grade')"><t t-esc="stats.get('avg_grade')"/></t>
                                            <t t-else="">N/D</t>
                                        </h3>
                                        <p class="ps-session-meta">Progreso: <t t-esc="(str(stats.get('progress')) + '%') if stats.get('progress') else '0%'"/></p>
                                    </div>
                                </div>
                                <div class="ps-status-card">
                                    <div class="ps-status-icon ps-status-icon-orange"><i class="fa fa-university"></i></div>
                                    <div>
                                        <p class="ps-status-label">Finanzas</p>
                                        <p class="ps-session-meta">
                                            <t t-if="student.al_dia_en_pagos">Al d√≠a</t>
                                            <t t-else="">Pendiente (facturas: <t t-esc="student.facturas_vencidas_count or 0"/>)</t>
                                        </p>
                                        <p class="ps-session-meta" t-if="student.monto_pendiente">Saldo: <t t-esc="student.monto_pendiente"/></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </t>
        </template>

        <!-- Solicitud de Congelamiento (HU-PE-CONG-01) -->
        <template id="portal_student_freeze" name="Portal Student Freeze Request">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'freeze'"/>
                <t t-call="portal_student.portal_student_header"/>
                <div class="ps-shell">
                    <!-- HU-PE-CONG-02 y T-PE-CONG-03: Banner de congelamiento activo -->
                    <t t-if="active_freeze_period">
                        <div class="ps-freeze-active-banner">
                            <div class="ps-freeze-banner-icon">
                                <i class="fa fa-pause-circle"></i>
                            </div>
                            <div class="ps-freeze-banner-content">
                                <h3><i class="fa fa-snowflake-o"></i> Tu curso est√° actualmente congelado</h3>
                                <p class="ps-freeze-banner-text">
                                    Has pausado temporalmente tu avance acad√©mico. Durante este periodo no tienes obligaci√≥n de asistir a clases,
                                    pero tu matr√≠cula permanece activa y tu fecha de finalizaci√≥n se extendi√≥ autom√°ticamente.
                                </p>
                                <div class="ps-freeze-info-grid">
                                    <div class="ps-freeze-info-item">
                                        <i class="fa fa-calendar"></i>
                                        <div>
                                            <strong>Periodo de congelamiento</strong>
                                            <p><t t-esc="active_freeze_period.fecha_inicio"/> - <t t-esc="active_freeze_period.fecha_fin"/></p>
                                        </div>
                                    </div>
                                    <div class="ps-freeze-info-item">
                                        <i class="fa fa-clock-o"></i>
                                        <div>
                                            <strong>D√≠as de congelamiento</strong>
                                            <p><t t-esc="active_freeze_period.dias"/> d√≠as totales</p>
                                        </div>
                                    </div>
                                    <div class="ps-freeze-info-item">
                                        <i class="fa fa-hourglass-half"></i>
                                        <div>
                                            <strong>D√≠as restantes</strong>
                                            <p><t t-esc="active_freeze_period.dias_restantes"/> d√≠as hasta el <t t-esc="active_freeze_period.fecha_fin"/></p>
                                        </div>
                                    </div>
                                    <div class="ps-freeze-info-item">
                                        <i class="fa fa-play-circle"></i>
                                        <div>
                                            <strong>Fecha de retorno</strong>
                                            <p>Podr√°s retomar tus clases a partir del <t t-esc="return_date"/></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="ps-freeze-financial-reminder">
                                    <i class="fa fa-info-circle"></i>
                                    <div>
                                        <strong>Recordatorio importante:</strong>
                                        <p>El congelamiento es √∫nicamente acad√©mico. Tu plan de pagos contin√∫a sin cambios y debes mantener tus cuotas al d√≠a.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>

                    <section class="ps-hero-block ps-hero-block-blue">
                        <div>
                            <p class="ps-eyebrow">Congelamiento</p>
                            <h2><i class="fa fa-pause-circle"></i> Solicitar Congelamiento</h2>
                            <p style="margin-top: 8px; color: rgba(255,255,255,0.9);">
                                Pausa temporalmente tu avance acad√©mico mientras mantienes tu matr√≠cula activa.
                            </p>
                        </div>
                    </section>

                    <!-- Mensajes de feedback -->
                    <t t-if="message">
                        <div class="alert alert-success ps-alert" role="alert">
                            <i class="fa fa-check-circle"></i> <t t-esc="message"/>
                        </div>
                    </t>
                    <t t-if="error">
                        <div class="alert alert-danger ps-alert" role="alert">
                            <i class="fa fa-exclamation-triangle"></i> <t t-esc="error"/>
                        </div>
                    </t>

                    <!-- Informaci√≥n del estudiante y estado de congelamiento -->
                    <div class="ps-freeze-info-grid">
                        <div class="ps-card ps-card-highlight">
                            <div class="ps-card-head">
                                <h3><i class="fa fa-info-circle"></i> Informaci√≥n de Congelamiento</h3>
                            </div>
                            <p class="ps-session-meta" style="margin: 8px 0;">
                                El congelamiento te permite pausar tus estudios por un periodo determinado sin perder tu matr√≠cula.
                                Durante el congelamiento, tu fecha de fin de matr√≠cula se extender√° autom√°ticamente por los d√≠as solicitados.
                            </p>
                            <div class="ps-freeze-rules">
                                <div class="ps-freeze-rule-item">
                                    <i class="fa fa-check"></i>
                                    <span>Mant√©n tu cupo en el programa</span>
                                </div>
                                <div class="ps-freeze-rule-item">
                                    <i class="fa fa-check"></i>
                                    <span>Extensi√≥n autom√°tica de fecha de fin</span>
                                </div>
                                <div class="ps-freeze-rule-item">
                                    <i class="fa fa-check"></i>
                                    <span>Regreso garantizado despu√©s del periodo</span>
                                </div>
                                <div class="ps-freeze-rule-item">
                                    <i class="fa fa-info-circle"></i>
                                    <span>Debes estar al d√≠a en pagos</span>
                                </div>
                            </div>
                        </div>

                        <!-- Estado de cartera -->
                        <div class="ps-card">
                            <div class="ps-card-head">
                                <h3><i class="fa fa-credit-card"></i> Estado de Cartera</h3>
                            </div>
                            <div class="ps-payment-status" t-att-class="'ps-payment-status-ok' if student.al_dia_en_pagos else 'ps-payment-status-warning'">
                                <div class="ps-payment-icon">
                                    <i t-att-class="'fa fa-check-circle' if student.al_dia_en_pagos else 'fa fa-exclamation-triangle'"></i>
                                </div>
                                <div>
                                    <h4 t-if="student.al_dia_en_pagos">Al D√≠a en Pagos</h4>
                                    <h4 t-else="">Pagos Pendientes</h4>
                                    <p class="ps-session-meta">
                                        <t t-if="student.al_dia_en_pagos">
                                            Puedes solicitar congelamiento sin restricciones.
                                        </t>
                                        <t t-else="">
                                            Debes ponerte al d√≠a en tus pagos antes de solicitar congelamiento.
                                        </t>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- T-PE-CONG-02: Advertencia sobre implicaciones financieras -->
                    <div class="ps-freeze-financial-warning">
                        <div class="ps-freeze-warning-icon">
                            <i class="fa fa-exclamation-triangle"></i>
                        </div>
                        <div class="ps-freeze-warning-content">
                            <h3><i class="fa fa-credit-card"></i> Informaci√≥n Importante sobre tu Plan de Pagos</h3>
                            <div class="ps-freeze-warning-text">
                                <p><strong>El congelamiento es √∫nicamente acad√©mico.</strong> Esto significa que:</p>
                                <ul class="ps-freeze-warning-list">
                                    <li>
                                        <i class="fa fa-check-circle"></i>
                                        <span>Pausas tus clases y obligaciones acad√©micas temporalmente</span>
                                    </li>
                                    <li>
                                        <i class="fa fa-check-circle"></i>
                                        <span>Tu matr√≠cula se mantiene activa y tu cupo est√° reservado</span>
                                    </li>
                                    <li>
                                        <i class="fa fa-check-circle"></i>
                                        <span>La fecha de finalizaci√≥n de tu matr√≠cula se extiende autom√°ticamente</span>
                                    </li>
                                    <li>
                                        <i class="fa fa-exclamation-circle"></i>
                                        <span><strong>Tu plan de pagos contin√∫a sin cambios</strong> - Debes seguir pagando tus cuotas normalmente</span>
                                    </li>
                                    <li>
                                        <i class="fa fa-exclamation-circle"></i>
                                        <span><strong>Para aprobar tu solicitud debes estar al d√≠a en tus pagos</strong></span>
                                    </li>
                                </ul>
                                <div class="ps-freeze-warning-highlight">
                                    <i class="fa fa-lightbulb-o"></i>
                                    <p>
                                        <strong>¬øPor qu√© debo seguir pagando?</strong>
                                        Durante el congelamiento mantenemos tu cupo, tu matr√≠cula activa y todos los recursos institucionales disponibles para ti.
                                        El congelamiento extiende tu fecha de finalizaci√≥n, pero no suspende los servicios ni compromisos financieros.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario de solicitud -->
                    <div class="ps-card ps-freeze-form-card">
                        <div class="ps-card-head">
                            <h3><i class="fa fa-edit"></i> Nueva Solicitud de Congelamiento</h3>
                        </div>

                        <form action="/my/student/freeze/request" method="post" enctype="multipart/form-data" class="ps-freeze-form">
                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                            <!-- Selector de matr√≠cula -->
                            <div class="ps-field ps-field-required">
                                <label for="enrollment_id">
                                    <i class="fa fa-graduation-cap"></i> Matr√≠cula a Congelar
                                </label>
                                <select id="enrollment_id" name="enrollment_id" class="form-select ps-select" required="required" onchange="updateEnrollmentInfo(this)">
                                    <option value="">Selecciona una matr√≠cula</option>
                                    <t t-foreach="enrollment_info" t-as="info">
                                        <option 
                                            t-att-value="info['enrollment'].id"
                                            t-att-data-permite="'1' if info['permite_congelamiento'] else '0'"
                                            t-att-data-dias-disponibles="info['dias_disponibles']"
                                            t-att-data-dias-usados="info['dias_usados']"
                                            t-att-data-min-dias="info['config'].min_dias_congelamiento if info['config'] else 0"
                                            t-att-data-max-dias="info['config'].max_dias_congelamiento if info['config'] else 0"
                                            t-att-data-puede-solicitar="'1' if info['puede_solicitar'] else '0'">
                                            <t t-esc="info['enrollment'].subject_id.alias or info['enrollment'].subject_id.name"/> - 
                                            <t t-esc="info['enrollment'].group_id.name"/>
                                            (<t t-esc="info['dias_disponibles']"/> d√≠as disponibles)
                                        </option>
                                    </t>
                                </select>
                                <div id="enrollment-info" class="ps-enrollment-info" style="display: none;">
                                    <!-- Informaci√≥n din√°mica de la matr√≠cula se llenar√° con JS -->
                                </div>
                            </div>

                            <!-- Fechas -->
                            <div class="ps-grid ps-grid-2">
                                <div class="ps-field ps-field-required">
                                    <label for="fecha_inicio">
                                        <i class="fa fa-calendar"></i> Fecha de Inicio
                                    </label>
                                    <input 
                                        type="date" 
                                        id="fecha_inicio" 
                                        name="fecha_inicio" 
                                        class="form-control" 
                                        required="required"
                                        t-att-min="datetime.date.today().isoformat()"
                                        onchange="calculateDays()"/>
                                </div>
                                <div class="ps-field ps-field-required">
                                    <label for="fecha_fin">
                                        <i class="fa fa-calendar"></i> Fecha de Fin
                                    </label>
                                    <input 
                                        type="date" 
                                        id="fecha_fin" 
                                        name="fecha_fin" 
                                        class="form-control" 
                                        required="required"
                                        t-att-min="datetime.date.today().isoformat()"
                                        onchange="calculateDays()"/>
                                </div>
                            </div>

                            <div id="dias-info" class="ps-dias-badge" style="display: none;">
                                <i class="fa fa-clock-o"></i>
                                <strong><span id="dias-count">0</span> d√≠as</strong> de congelamiento solicitados
                            </div>

                            <!-- Motivo -->
                            <div class="ps-field ps-field-required">
                                <label for="freeze_reason_id">
                                    <i class="fa fa-question-circle"></i> Motivo del Congelamiento
                                </label>
                                <select id="freeze_reason_id" name="freeze_reason_id" class="form-select ps-select" required="required">
                                    <option value="">Selecciona un motivo</option>
                                    <t t-foreach="freeze_reasons" t-as="reason">
                                        <option 
                                            t-att-value="reason.id"
                                            t-att-data-requiere-docs="'1' if reason.requiere_documentacion else '0'">
                                            <t t-esc="reason.name"/>
                                        </option>
                                    </t>
                                </select>
                            </div>

                            <!-- Descripci√≥n detallada -->
                            <div class="ps-field">
                                <label for="motivo_detalle">
                                    <i class="fa fa-align-left"></i> Descripci√≥n Detallada (Opcional)
                                </label>
                                <textarea 
                                    id="motivo_detalle" 
                                    name="motivo_detalle" 
                                    class="form-control ps-textarea" 
                                    rows="4"
                                    placeholder="Explica con m√°s detalle tu situaci√≥n..."></textarea>
                                <small class="ps-hint">
                                    Esta informaci√≥n ayuda al equipo acad√©mico a entender mejor tu situaci√≥n.
                                </small>
                            </div>

                            <!-- Documentos de soporte -->
                            <div class="ps-field" id="documento-field" style="display: none;">
                                <label for="documento_soporte">
                                    <i class="fa fa-paperclip"></i> Documentos de Soporte
                                </label>
                                <input 
                                    type="file" 
                                    id="documento_soporte" 
                                    name="documento_soporte" 
                                    class="form-control" 
                                    multiple="multiple"
                                    accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"/>
                                <small class="ps-hint">
                                    Puedes adjuntar certificados m√©dicos, cartas laborales, comprobantes de viaje, etc.
                                </small>
                            </div>

                            <!-- T-PE-CONG-02: Aceptaci√≥n de t√©rminos financieros -->
                            <div class="ps-freeze-acceptance">
                                <div class="ps-freeze-acceptance-box">
                                    <input 
                                        type="checkbox" 
                                        id="aceptacion_terminos" 
                                        name="aceptacion_terminos" 
                                        required="required"
                                        onchange="enableSubmitIfValid()"
                                        class="ps-checkbox"/>
                                    <label for="aceptacion_terminos" class="ps-freeze-acceptance-label">
                                        <strong>He le√≠do y acepto las condiciones financieras:</strong>
                                        Entiendo que el congelamiento es √∫nicamente acad√©mico y que mi plan de pagos contin√∫a sin cambios.
                                        Me comprometo a mantener mis cuotas al d√≠a durante el periodo de congelamiento.
                                    </label>
                                </div>
                            </div>

                            <!-- Botones -->
                            <div class="ps-actions ps-freeze-actions">
                                <button type="button" class="ps-button ps-button-ghost" onclick="window.location.href='/my/student/summary'">
                                    <i class="fa fa-times"></i>Cancelar
                                </button>
                                <button type="submit" class="ps-button" id="submit-btn" disabled="disabled">
                                    <i class="fa fa-paper-plane"></i> Enviar Solicitud
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Historial de solicitudes -->
                    <t t-if="freeze_periods or previous_requests">
                        <div class="ps-card">
                            <div class="ps-card-head">
                                <h3><i class="fa fa-history"></i> Historial de Congelamientos</h3>
                            </div>
                            
                            <div class="ps-freeze-history">
                                <t t-if="freeze_periods">
                                    <t t-foreach="freeze_periods" t-as="period">
                                        <div class="ps-freeze-history-item" t-att-class="'ps-freeze-status-' + period.estado">
                                            <div class="ps-freeze-history-icon">
                                                <i t-if="period.estado == 'aprobado'" class="fa fa-check-circle"></i>
                                                <i t-elif="period.estado == 'pendiente'" class="fa fa-clock-o"></i>
                                                <i t-elif="period.estado == 'rechazado'" class="fa fa-times-circle"></i>
                                                <i t-elif="period.estado == 'finalizado'" class="fa fa-flag-checkered"></i>
                                                <i t-else="" class="fa fa-circle"></i>
                                            </div>
                                            <div class="ps-freeze-history-content">
                                                <h4>
                                                    <t t-esc="period.freeze_reason_id.name or 'Sin motivo'"/>
                                                    <span class="ps-pill ps-pill-soft" t-esc="dict(period._fields['estado'].selection).get(period.estado)"/>
                                                </h4>
                                                <p class="ps-session-meta">
                                                    <t t-esc="period.fecha_inicio"/> - <t t-esc="period.fecha_fin"/> 
                                                    (<t t-esc="period.dias"/> d√≠as)
                                                </p>
                                                <p class="ps-session-meta" t-if="period.enrollment_id">
                                                    Matr√≠cula: <t t-esc="period.enrollment_id.subject_id.alias or period.enrollment_id.subject_id.name"/> - <t t-esc="period.enrollment_id.group_id.name"/>
                                                </p>
                                                <t t-if="period.estado == 'rechazado' and period.motivo_rechazo">
                                                    <p class="ps-freeze-rejection">
                                                        <strong>Motivo del rechazo:</strong> <t t-esc="period.motivo_rechazo"/>
                                                    </p>
                                                </t>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="ps-empty-block">
                                        <i class="fa fa-info-circle"></i>
                                        <p>No tienes congelamientos registrados a√∫n.</p>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- JavaScript para validaciones -->
                <script type="text/javascript">
                    (function() {
                        'use strict';
                        
                        function updateEnrollmentInfo(select) {
                            var option = select.options[select.selectedIndex];
                            var infoDiv = document.getElementById('enrollment-info');
                            var submitBtn = document.getElementById('submit-btn');
                            
                            if (!option.value) {
                                infoDiv.style.display = 'none';
                                submitBtn.disabled = true;
                                return;
                            }
                            
                            var permite = option.getAttribute('data-permite') === '1';
                            var diasDisponibles = parseInt(option.getAttribute('data-dias-disponibles'));
                            var diasUsados = parseInt(option.getAttribute('data-dias-usados'));
                            var minDias = parseInt(option.getAttribute('data-min-dias'));
                            var maxDias = parseInt(option.getAttribute('data-max-dias'));
                            var puedeSolicitar = option.getAttribute('data-puede-solicitar') === '1';
                            
                            var html = '';
                            if (!permite) {
                                html = '<div class="ps-info-warning"><i class="fa fa-ban"></i> Esta matr√≠cula no permite congelamiento seg√∫n su plan.</div>';
                                submitBtn.disabled = true;
                            } else if (!puedeSolicitar) {
                                html = '<div class="ps-info-warning"><i class="fa fa-exclamation-triangle"></i> No tienes d√≠as suficientes para solicitar congelamiento en esta matr√≠cula.</div>';
                                submitBtn.disabled = true;
                            } else {
                                html = '<div class="ps-info-success">';
                                html += '<i class="fa fa-check-circle"></i>';
                                html += '<div>';
                                html += '<strong>D√≠as disponibles:</strong> ' + diasDisponibles + ' d√≠as<br/>';
                                html += '<strong>D√≠as ya usados:</strong> ' + diasUsados + ' d√≠as<br/>';
                                html += '<strong>Rango permitido:</strong> ' + minDias + ' a ' + maxDias + ' d√≠as por solicitud';
                                html += '</div>';
                                html += '</div>';
                                submitBtn.disabled = false;
                            }
                            
                            infoDiv.innerHTML = html;
                            infoDiv.style.display = 'block';
                        }
                        
                        function calculateDays() {
                            var inicio = document.getElementById('fecha_inicio').value;
                            var fin = document.getElementById('fecha_fin').value;
                            var diasDiv = document.getElementById('dias-info');
                            var diasCount = document.getElementById('dias-count');
                            
                            if (inicio &amp;&amp; fin) {
                                var d1 = new Date(inicio);
                                var d2 = new Date(fin);
                                var dias = Math.floor((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
                                
                                if (dias &gt; 0) {
                                    diasCount.textContent = dias;
                                    diasDiv.style.display = 'flex';
                                } else {
                                    diasDiv.style.display = 'none';
                                }
                            } else {
                                diasDiv.style.display = 'none';
                            }
                        }
                        
                        // Mostrar campo de documentos si el motivo lo requiere
                        var reasonSelect = document.getElementById('freeze_reason_id');
                        if (reasonSelect) {
                            reasonSelect.addEventListener('change', function() {
                                var option = this.options[this.selectedIndex];
                                var requiresDocs = option.getAttribute('data-requiere-docs') === '1';
                                var docField = document.getElementById('documento-field');
                                
                                if (requiresDocs) {
                                    docField.style.display = 'block';
                                } else {
                                    docField.style.display = 'none';
                                }
                            });
                        }
                        
                        function enableSubmitIfValid() {
                            var enrollmentSelect = document.getElementById('enrollment_id');
                            var fechaInicio = document.getElementById('fecha_inicio');
                            var fechaFin = document.getElementById('fecha_fin');
                            var reasonSelect = document.getElementById('freeze_reason_id');
                            var aceptacion = document.getElementById('aceptacion_terminos');
                            var submitBtn = document.getElementById('submit-btn');
                            
                            // Verificar que todos los campos requeridos est√©¬©n completos
                            var enrollmentValid = enrollmentSelect &amp;&amp; enrollmentSelect.value;
                            var fechasValid = fechaInicio &amp;&amp; fechaInicio.value &amp;&amp; fechaFin &amp;&amp; fechaFin.value;
                            var reasonValid = reasonSelect &amp;&amp; reasonSelect.value;
                            var aceptacionValid = aceptacion &amp;&amp; aceptacion.checked;
                            
                            // Verificar que la matr√≠cula permita congelamiento
                            var enrollmentOk = false;
                            if (enrollmentSelect &amp;&amp; enrollmentSelect.value) {
                                var option = enrollmentSelect.options[enrollmentSelect.selectedIndex];
                                enrollmentOk = option.getAttribute('data-puede-solicitar') === '1';
                            }
                            
                            // Habilitar bot√≥n solo si todo es v√°lido
                            if (submitBtn) {
                                submitBtn.disabled = !(enrollmentValid &amp;&amp; enrollmentOk &amp;&amp; fechasValid &amp;&amp; reasonValid &amp;&amp; aceptacionValid);
                            }
                        }
                        
                        // Agregar listeners para validaci√≥n en tiempo real
                        document.addEventListener('DOMContentLoaded', function() {
                            var enrollmentSelect = document.getElementById('enrollment_id');
                            var fechaInicio = document.getElementById('fecha_inicio');
                            var fechaFin = document.getElementById('fecha_fin');
                            var reasonSelect = document.getElementById('freeze_reason_id');
                            var aceptacion = document.getElementById('aceptacion_terminos');
                            
                            if (enrollmentSelect) enrollmentSelect.addEventListener('change', enableSubmitIfValid);
                            if (fechaInicio) fechaInicio.addEventListener('change', enableSubmitIfValid);
                            if (fechaFin) fechaFin.addEventListener('change', enableSubmitIfValid);
                            if (reasonSelect) reasonSelect.addEventListener('change', enableSubmitIfValid);
                            if (aceptacion) aceptacion.addEventListener('change', enableSubmitIfValid);
                        });
                        
                        // Exponer funciones al scope global
                        window.updateEnrollmentInfo = updateEnrollmentInfo;
                        window.calculateDays = calculateDays;
                        window.enableSubmitIfValid = enableSubmitIfValid;
                    })();
                </script>
            </t>
        </template>

        <!-- Acceso directo al portal de estudiante desde /my -->
        <!-- DISABLED: Causing XPath issues in this Odoo installation
        <template id="portal_student_portal_my_home" inherit_id="portal.portal_my_home" name="Portal Student Entry" priority="100">
            <xpath expr="//div[@id='portal_common_category']" position="inside">
                <t t-call="portal.portal_docs_entry" groups="portal_student.group_benglish_student">
                    <t t-set="icon" t-value="'/portal/static/src/img/portal-connection.svg'"/>
                    <t t-set="title">Portal del Estudiante</t>
                    <t t-set="text">Clases, agenda, recursos y estado acad√©mico.</t>
                    <t t-set="url" t-value="'/my/student'"/>
                </t>
            </xpath>
        </template>
        -->

<!-- ============================================================ -->
<!-- NUEVO RESUMEN ACAD√âMICO V2 - Basado en Clases Individuales -->
<!-- ============================================================ -->

<template id="portal_student_summary_v2" name="Portal Student Summary V2">
    <t t-call="portal.portal_layout">
        <t t-set="additional_title">Historial Acad√©mico</t>
        <t t-call="portal_student.portal_student_header"/>
        
        <div class="ps-container">
            <!-- Hero Section -->
            <section style="padding: 2rem 0 1rem;">
                <div>
                    <h1 style="font-size: 1.875rem; font-weight: 800; color: #1f2937; margin: 0 0 0.5rem;">Historial Acad√©mico</h1>
                    <p style="font-size: 0.9375rem; color: #6b7280; margin: 0;">
                        <span t-if="program"><t t-esc="program.name"/></span>
                        <span t-if="plan"> ‚Ä¢ <t t-esc="plan.name"/></span>
                    </p>
                </div>
            </section>

            <!-- Progress Overview Cards -->
            <section style="padding: 1.5rem 0 1rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem;">
                    <!-- Total de Clases Completadas -->
                    <div style="background: linear-gradient(120deg, #0f1f52 0%, #1e3a8a 65%, #274aaf 100%); border-radius: 12px; padding: 1rem; position: relative; overflow: hidden; box-shadow: 0 4px 16px rgba(30, 58, 138, 0.25);">
                        <div style="position: absolute; top: -30px; right: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.625rem;">
                                <p style="font-size: 0.625rem; font-weight: 700; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Clases Completadas</p>
                                <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa fa-check-circle" aria-hidden="true" style="color: white; font-size: 1.125rem;"></i>
                                </div>
                            </div>
                            <h2 style="font-size: 1.625rem; font-weight: 800; color: white; margin: 0.25rem 0; line-height: 1;">
                                <t t-esc="completed_subjects"/> 
                                <span style="font-size: 1rem; opacity: 0.85;">/ <t t-esc="total_subjects"/></span>
                            </h2>
                            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin: 0.375rem 0 0;">Has terminado <t t-esc="completed_subjects"/> clases</p>
                        </div>
                    </div>

                    <!-- Clases Pendientes -->
                    <div style="background: linear-gradient(120deg, #0f1f52 0%, #1e3a8a 65%, #274aaf 100%); border-radius: 12px; padding: 1rem; position: relative; overflow: hidden; box-shadow: 0 4px 16px rgba(30, 58, 138, 0.25);">
                        <div style="position: absolute; top: -30px; right: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.625rem;">
                                <p style="font-size: 0.625rem; font-weight: 700; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Clases Pendientes</p>
                                <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa fa-clock-o" aria-hidden="true" style="color: white; font-size: 1.125rem;"></i>
                                </div>
                            </div>
                            <h2 style="font-size: 1.625rem; font-weight: 800; color: white; margin: 0.25rem 0; line-height: 1;"><t t-esc="pending_subjects"/></h2>
                            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin: 0.375rem 0 0;">Clases por completar</p>
                        </div>
                    </div>

                    <!-- Asistencia -->
                    <div style="background: linear-gradient(120deg, #0f1f52 0%, #1e3a8a 65%, #274aaf 100%); border-radius: 12px; padding: 1rem; position: relative; overflow: hidden; box-shadow: 0 4px 16px rgba(30, 58, 138, 0.25);">
                        <div style="position: absolute; top: -30px; right: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.625rem;">
                                <p style="font-size: 0.625rem; font-weight: 700; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Tasa de Asistencia</p>
                                <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa fa-calendar-check-o" aria-hidden="true" style="color: white; font-size: 1.125rem;"></i>
                                </div>
                            </div>
                            <h2 style="font-size: 1.625rem; font-weight: 800; color: white; margin: 0.25rem 0; line-height: 1;"><t t-esc="'%.1f' % attendance_summary['attendance_rate']"/>%</h2>
                            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin: 0.375rem 0 0;">
                                <t t-esc="attendance_summary['attended']"/> de <t t-esc="attendance_summary['total_classes']"/> clases
                            </p>
                        </div>
                    </div>

                    <!-- Progreso General -->
                    <div style="background: linear-gradient(120deg, #0f1f52 0%, #1e3a8a 65%, #274aaf 100%); border-radius: 12px; padding: 1rem; position: relative; overflow: hidden; box-shadow: 0 4px 16px rgba(30, 58, 138, 0.25);">
                        <div style="position: absolute; top: -30px; right: -30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                        <div style="position: relative; z-index: 1;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.625rem;">
                                <p style="font-size: 0.625rem; font-weight: 700; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.05em; margin: 0;">Progreso General</p>
                                <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fa fa-trophy" aria-hidden="true" style="color: white; font-size: 1.125rem;"></i>
                                </div>
                            </div>
                            <h2 style="font-size: 1.625rem; font-weight: 800; color: white; margin: 0.25rem 0; line-height: 1;"><t t-esc="'%.1f' % progress_percentage"/>%</h2>
                            <p style="font-size: 0.75rem; color: rgba(255,255,255,0.9); margin: 0.375rem 0 0;">Del programa completo</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Progress Bar -->
            <section class="ps-section" style="padding: 0.5rem 0;">
                <div style="background: linear-gradient(135deg, rgba(30, 58, 138, 0.08) 0%, rgba(99, 102, 241, 0.08) 100%); border: 2px solid #1e3a8a; border-radius: 12px; padding: 1rem; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.12);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.625rem;">
                        <h3 style="margin: 0; font-size: 0.8125rem; font-weight: 700; color: #1e3a8a; display: flex; align-items: center; gap: 0.375rem;">
                            <i class="fa fa-trophy" aria-hidden="true" style="font-size: 0.75rem;"></i>
                            Tu Progreso
                        </h3>
                        <span style="font-size: 1.125rem; font-weight: 800; background: linear-gradient(135deg, #1e3a8a 0%, #0f56c9 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            <t t-esc="'%.1f' % progress_percentage"/>%
                        </span>
                    </div>
                    <div style="width: 100%; height: 20px; background: rgba(30, 58, 138, 0.15); border-radius: 10px; overflow: hidden; position: relative; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <div t-attf-style="width: {{progress_percentage}}%; background: linear-gradient(90deg, #1e3a8a 0%, #0f56c9 50%, #6366f1 100%); height: 100%; transition: width 0.5s ease; box-shadow: 0 2px 8px rgba(30, 58, 138, 0.4); position: relative;">
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: #1e3a8a; font-weight: 600;">
                        <span><i class="fa fa-check-circle" style="color: #10b981; margin-right: 0.25rem;"></i><t t-esc="completed_subjects"/> completadas</span>
                        <span><i class="fa fa-clock-o" style="margin-right: 0.25rem;"></i><t t-esc="pending_subjects"/> pendientes</span>
                    </div>
                </div>
            </section>

            <!-- Clases por Fase y Nivel -->
            <section class="ps-section" style="padding: 0.75rem 0;">
                <div style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); border-radius: 12px 12px 0 0; padding: 1rem; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.2);">
                    <h2 style="font-size: 1.125rem; font-weight: 700; color: white; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fa fa-graduation-cap" aria-hidden="true"></i>
                        Tus Clases
                    </h2>
                    <p style="font-size: 0.8125rem; color: rgba(255, 255, 255, 0.85); margin: 0.25rem 0 0;">Revisa qu√© clases has completado y cu√°les te faltan</p>
                </div>
                <div style="padding: 1rem; background: white; border-radius: 0 0 12px 12px; border: 2px solid #1e3a8a; border-top: none; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.1);">

                    <div style="display: grid; gap: 1rem;">
                        <t t-foreach="subjects_by_phase.values()" t-as="phase_data">
                            <div style="background: white; border-radius: 10px; padding: 1rem; border: 2px solid #1e3a8a; box-shadow: 0 2px 4px rgba(30, 58, 138, 0.1);">
                                <h3 style="margin-bottom: 0.75rem; font-size: 0.9375rem; font-weight: 700; color: #1e3a8a; border-bottom: 2px solid rgba(30, 58, 138, 0.2); padding-bottom: 0.5rem; display: flex; align-items: center;">
                                    <i class="fa fa-folder-open" aria-hidden="true" style="margin-right: 0.5rem; font-size: 1rem;"></i>
                                    <t t-esc="phase_data['name']"/>
                                </h3>
                                
                                <t t-foreach="phase_data['levels'].values()" t-as="level_data">
                                    <div style="margin-bottom: 0.75rem;">
                                        <h4 style="font-size: 0.8125rem; font-weight: 600; color: #1e3a8a; margin-bottom: 0.5rem; display: flex; align-items: center; background: rgba(30, 58, 138, 0.05); padding: 0.375rem 0.5rem; border-radius: 6px;">
                                            <i class="fa fa-layer-group" aria-hidden="true" style="margin-right: 0.5rem; font-size: 0.75rem;"></i>
                                            <t t-esc="level_data['name']"/>
                                        </h4>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;">
                                            <t t-foreach="level_data['subjects']" t-as="subject_data">
                                                <!-- Colores seg√∫n el estado -->
                                                <t t-if="subject_data['status'] == 'attended'">
                                                    <t t-set="border_color" t-value="'#10b981'"/>
                                                    <t t-set="bg_color" t-value="'#f0fdf4'"/>
                                                    <t t-set="icon_bg" t-value="'#10b981'"/>
                                                    <t t-set="icon_color" t-value="'white'"/>
                                                    <t t-set="icon_class" t-value="'fa fa-check'"/>
                                                </t>
                                                <t t-elif="subject_data['status'] == 'absent'">
                                                    <t t-set="border_color" t-value="'#ef4444'"/>
                                                    <t t-set="bg_color" t-value="'#fef2f2'"/>
                                                    <t t-set="icon_bg" t-value="'#ef4444'"/>
                                                    <t t-set="icon_color" t-value="'white'"/>
                                                    <t t-set="icon_class" t-value="'fa fa-times'"/>
                                                </t>
                                                <t t-else="">
                                                    <t t-set="border_color" t-value="'rgba(30, 58, 138, 0.3)'"/>
                                                    <t t-set="bg_color" t-value="'#f8fafc'"/>
                                                    <t t-set="icon_bg" t-value="'rgba(30, 58, 138, 0.1)'"/>
                                                    <t t-set="icon_color" t-value="'#1e3a8a'"/>
                                                    <t t-set="icon_class" t-value="'fa fa-circle-o'"/>
                                                </t>
                                                
                                                <div class="ps-subject-item" 
                                                     t-attf-style="display: flex; align-items: center; padding: 0.5rem; border-radius: 6px; border: 1.5px solid {{border_color}}; background: {{bg_color}}; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                    
                                                    <!-- Check Icon -->
                                                    <div t-attf-style="flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; background: {{icon_bg}}; border: 1.5px solid {{border_color}};">
                                                        <i t-att-class="icon_class" 
                                                           aria-hidden="true" 
                                                           t-attf-style="color: {{icon_color}}; font-size: 0.625rem;"></i>
                                                    </div>
                                                    
                                                    <!-- Subject Info -->
                                                    <div style="flex-grow: 1; min-width: 0;">
                                                        <div style="font-weight: 600; color: #1f2937; font-size: 0.8125rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                            <t t-esc="subject_data['name']"/>
                                                        </div>
                                                        <div style="font-size: 0.6875rem; color: #6b7280;">
                                                            <t t-if="subject_data['status'] == 'attended'">
                                                                <i class="fa fa-check-circle" aria-hidden="true" style="color: #10b981; font-size: 0.625rem;"></i>
                                                                <t t-if="subject_data['last_class_date']">
                                                                    <t t-esc="subject_data['last_class_date'].strftime('%d/%m')"/>
                                                                </t>
                                                                <!-- Mostrar Calificaci√≥n -->
                                                                <t t-if="subject_data.get('grade')">
                                                                    <div style="margin-top: 0.375rem; padding: 0.5rem; background: linear-gradient(120deg, #10b981 0%, #059669 100%); border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);">
                                                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                            <span style="color: white; font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Calificaci√≥n:</span>
                                                                            <span style="color: white; font-weight: 800; font-size: 1.125rem;">
                                                                                <t t-esc="'%.1f' % subject_data['grade']"/>
                                                                            </span>
                                                                        </div>
                                                                        <t t-if="subject_data.get('notes')">
                                                                            <div style="margin-top: 0.375rem; padding-top: 0.375rem; border-top: 1px solid rgba(255, 255, 255, 0.3);">
                                                                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.625rem; font-weight: 500;">Observaci√≥n:</span>
                                                                                <div style="color: white; font-size: 0.75rem; margin-top: 0.125rem; font-style: italic;">
                                                                                    <t t-esc="subject_data['notes']"/>
                                                                                </div>
                                                                            </div>
                                                                        </t>
                                                                    </div>
                                                                </t>
                                                                <!-- Si no hay calificaci√≥n pero s√≠ hay observaciones -->
                                                                <t t-elif="subject_data.get('notes')">
                                                                    <div style="margin-top: 0.375rem; padding: 0.375rem 0.5rem; background: linear-gradient(120deg, rgba(15, 31, 82, 0.05) 0%, rgba(30, 58, 138, 0.08) 100%); border-radius: 0.375rem; border-left: 3px solid #1e3a8a;">
                                                                        <span style="color: #64748b; font-size: 0.625rem; font-weight: 500;">Observaci√≥n:</span>
                                                                        <span style="color: #1e3a8a; font-weight: 700; font-size: 0.8125rem; margin-left: 0.25rem;">
                                                                            <t t-esc="subject_data['notes']"/>
                                                                        </span>
                                                                    </div>
                                                                </t>
                                                            </t>
                                                            <t t-elif="subject_data['status'] == 'absent'">
                                                                <i class="fa fa-times-circle" aria-hidden="true" style="color: #ef4444; font-size: 0.625rem;"></i>
                                                                No asisti√≥
                                                                <t t-if="subject_data['last_class_date']">
                                                                    (<t t-esc="subject_data['last_class_date'].strftime('%d/%m')"/>)
                                                                </t>
                                                                <t t-if="subject_data.get('notes')">
                                                                    <div style="margin-top: 0.375rem; padding: 0.375rem 0.5rem; background: linear-gradient(120deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.08) 100%); border-radius: 0.375rem; border-left: 3px solid #ef4444;">
                                                                        <span style="color: #64748b; font-size: 0.625rem; font-weight: 500;">Observaci√≥n:</span>
                                                                        <span style="color: #ef4444; font-weight: 700; font-size: 0.75rem; margin-left: 0.25rem;">
                                                                            <t t-esc="subject_data['notes']"/>
                                                                        </span>
                                                                    </div>
                                                                </t>
                                                            </t>
                                                            <t t-else="">
                                                                <i class="fa fa-clock-o" aria-hidden="true" style="color: #1e3a8a; font-size: 0.625rem;"></i>
                                                                Pendiente
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </t>
                    </div>
                </div>
            </section>

            <!-- Call to Action -->
            <section class="ps-section" style="text-align: center; padding: 1.5rem 0;">
                <div style="background: linear-gradient(145deg, rgba(30, 58, 138, 0.95), rgba(13, 27, 76, 0.95)); border-radius: 12px; padding: 1.5rem; color: white;">
                    <h2 style="color: white; margin-bottom: 0.5rem; font-size: 1.125rem; font-weight: 700;">¬øListo para tu pr√≥xima clase?</h2>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem; font-size: 0.875rem;">
                        Revisa tu agenda y prep√°rate para continuar aprendiendo
                    </p>
                    <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                        <a href="/my/student/agenda/mine" class="ps-button ps-button-white" style="background: white; color: #1e3a8a; font-weight: 600; font-size: 0.875rem; padding: 0.5rem 1rem;">
                            <i class="fa fa-calendar"></i> Ver Mi Agenda
                        </a>
                        <a href="/my/student/agenda" class="ps-button" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; font-weight: 600; font-size: 0.875rem; padding: 0.5rem 1rem;">
                            <i class="fa fa-plus"></i> Agendar Nueva Clase
                        </a>
                    </div>
                </div>
            </section>

        </div>
    </t>
</template>


</odoo>
