<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ========================================
         AUTOMATIZACIÓN: Validar responsable activo en cambio
         ======================================== -->

    <record id="rule_validate_active_user_assignment" model="base.automation">
        <field name="name">Validar Responsable Activo en Asignación</field>
        <field name="model_id" ref="crm.model_crm_lead" />
        <field name="trigger">on_write</field>
        <field name="filter_pre_domain">[('user_id', '!=', False)]</field>
        <field name="filter_domain">[('user_id', '!=', False)]</field>
        <field name="active">True</field>
    </record>

    <record id="action_validate_active_user" model="ir.actions.server">
        <field name="name">Validar Usuario Activo</field>
        <field name="model_id" ref="crm.model_crm_lead" />
        <field name="base_automation_id" ref="rule_validate_active_user_assignment" />
        <field name="state">code</field>
        <field name="code"><![CDATA[
for record in records:
    if record.user_id and not record.user_id.active:
        old_user_name = record.user_id.name
        record.write({'user_id': False})
        record.message_post(
            body="Usuario desactivado removido: %s" % old_user_name,
            subject="Usuario Inactivo Detectado",
        )
]]></field>
    </record>

    <!-- ========================================
         AUTOMATIZACIÓN: Notificar en evaluación completada
         ======================================== -->

    <record id="rule_notify_evaluation_completed" model="base.automation">
        <field name="name">Notificar: Evaluación Completada</field>
        <field name="model_id" ref="crm.model_crm_lead" />
        <field name="trigger">on_write</field>
        <field name="filter_domain">[('evaluation_completed', '=', True)]</field>
        <field name="active">True</field>
    </record>

    <record id="action_notify_evaluation_completed" model="ir.actions.server">
        <field name="name">Notificar Evaluación Completada</field>
        <field name="model_id" ref="crm.model_crm_lead" />
        <field name="base_automation_id" ref="rule_notify_evaluation_completed" />
        <field name="state">code</field>
        <field name="code"><![CDATA[
Activity = env['mail.activity']
for record in records:
    if record.evaluation_completed and record.user_id:
        Activity.create({
            'activity_type_id': env.ref('mail.mail_activity_data_todo').id,
            'summary': 'Evaluación completada - Siguiente paso',
            'note': 'La evaluación del lead "%s" ha sido completada. Por favor revise los resultados.' % record.name,
            'user_id': record.user_id.id,
            'res_id': record.id,
            'res_model_id': env.ref('crm.model_crm_lead').id,
        })
]]></field>
    </record>

</odoo>